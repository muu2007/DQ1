import 'macros' as {$}
import 'utl' as :L, :pos_in_box, :play
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Town, :Dungeon, :Charactor, :g_player, :å®¿å±‹, :æ­¦å™¨å±‹, :é“å…·å±‹, :MessageBoxRetro, :Battle, :generateMonster, :æ‰‰, :å®ç®±
local *


mapdata = $to2d [[
PPPPPPPPCCC'CCCCCCCCC@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPP@@@@@@@@@@@@@@@@@@@@PPPPPPPPPP
PPPPPPPPPC''C'C""""""""@@'@@PPPPPPPPPP
PPPPPPPPPC''A'C""!'''!"""'""!!!!PPPPPP
!!!!!!""CC'CCCC"!!'"'!!''''''''')!!!!!
!!!!!!!!!!'!!!!!'''''!!!!!!!!!!!$PPPPP
!!!!!!!!'''''''''!'!!!J'CCC"!!!!$$PPPP
!!!!!!!!"""!'!""!!'I!!C'A'CC!!!!$$PPP!
!!!!!!!!CCCC'C"$CC'CC!C'CCCC!!!!!$$$!!
PPPPPPPPPC'''CC$C'A'C!C'C''C!!!!!!$$!!
PPPPPPPPPCCCCCPCC'''C!C''''C!!!!!$$$!!
PPPPPPPPPPPPPPPPCCCCCCCCCCCC!!!!!!$!!!
PPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!!!
PPPPPPPPPPPPPPPPPPPPPPPPPPPPPP!!!!!!!!]]


mapdataå¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEE%EEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEC''''''''''''CCCCPPPEEEEEEE
EEEEEEEEC'CCCCC''''''PPPCPCCEEEEEEE
EEEEEEEEC'C'''C''''''CPPPPPCEEEEEEE
EEEEEEEEC'CC'CC''''''CPCPCPCEEEEEEE
EEEEEEEEC''''''''''''''''''CEEEEEEE
EEEEEEEEC''''''''''''''''''CEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCC'''CEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEECC'CCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEE%EEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE]]

mapdataå¢“å ´é€šè·¯ = $to2d [[
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!PPC'''''''''''''PPC4!!!!!!!
!!!!!!!!PPC'$$$$$$$$$$$'')''!!!!!!!
!!!!!!!!CCC'CCCCCCCCCCCCPCCC!!!!!!!
!!!!!!!!@@@%@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!
!!!!!!!!@@@@@@@@@@@@@@@@@@@@!!!!!!!]]

mapdataå¢“å ´B1 = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEEC''''''''C'C'''C''''CCEEEEEEE
EEEEEEEEC'CCCCCC'''C'''''CC''CEEEEEEE
EEEEEEEEC'C''''C'C'C'''C'''C'CEEEEEEE
EEEEEEEEC'C'CC'''C'C'CCCCC'C'CEEEEEEE
EEEEEEEEC'C''''CCC'CCC'C'C'''CEEEEEEE
EEEEEEEEC'CCCC'''C'''C'C'C'C'CEEEEEEE
EEEEEEEEC''''CCCCC'C'C'C'C'C'CEEEEEEE
EEEEEEEEC'C''C'''''''''''''''CEEEEEEE
EEEEEEEEC'C'CC'CCC'CCCCC'CCC'CEEEEEEE
EEEEEEEEC'C'C''''''C'''''C'''CEEEEEEE
EEEEEEEEC'C'C'C'CC'CCCCC'''''CEEEEEEE
EEEEEEEEC'C'''C3'''C'''C'CC''CEEEEEEE
EEEEEEEEC'C'C'C''''C'C'''CC'CCEEEEEEE
EEEEEEEEC'C'CCCCCC'CCCCC''C''CEEEEEEE
EEEEEEEEC'C'''C''''''''CCCCC'CEEEEEEE
EEEEEEEECCCCC'CCCCCC'C'C'C'C'CEEEEEEE
EEEEEEEEC'''CCC''''''''C'''''CEEEEEEE
EEEEEEEEC''C'C''C'CCCCCCCCC'CCEEEEEEE
EEEEEEEEC'4''CCCCCCC'C'''C'''CEEEEEEE
EEEEEEEEC''''''''''''''C'''C'CEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE]]

mapdataå¢“å ´B2 = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEECC''''''''''''''CCEEEEEEE
EEEEEEEECC'4C'CCCCCCC'4'CCEEEEEEE
EEEEEEEECC'CC'''''''C3''CCEEEEEEE
EEEEEEEECC''CCCCCCC'CCC'CCEEEEEEE
EEEEEEEECC''C'''''''''C'CCEEEEEEE
EEEEEEEECC''C'C'C'C'C'C'CCEEEEEEE
EEEEEEEECC''C''4''C'C'C'CCEEEEEEE
EEEEEEEECC''C'C'C'CCCCC'CCEEEEEEE
EEEEEEEECC''C'''''C'''''CCEEEEEEE
EEEEEEEECC'CCCCCCCCCCCC'CCEEEEEEE
EEEEEEEECC'4C''''''''C4'CCEEEEEEE
EEEEEEEECC''''''''''''''CCEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE]]

mapdataå¢“å ´B3 = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEEC'''C'''C''''''''C'''CEEEEEEE
EEEEEEEEC'''C'''''C'C'C3'C'3'CEEEEEEE
EEEEEEEEC'''C'CCCCC''''''C'''CEEEEEEE
EEEEEEEEC'CCC'C'C'CCCCCCCCCCCCEEEEEEE
EEEEEEEEC'C'''C''''CC'''CC'''CEEEEEEE
EEEEEEEEC'C'CCC'C'4C'''''CCC'CEEEEEEE
EEEEEEEEC'''C'''CCCC'''''C'C'CEEEEEEE
EEEEEEEEC'CCC'C'C'C''''''C'C'CEEEEEEE
EEEEEEEEC'C'C'C'C'C'''''CC'''CEEEEEEE
EEEEEEEEC'C'C'''C'C4'CCCCC'C'CEEEEEEE
EEEEEEEEC'C'C'CCC'CCCC'C'''C'CEEEEEEE
EEEEEEEEC'C'C'C3'''''''C''CC'CEEEEEEE
EEEEEEEEC'C'C'CCCCCCCCCCC'C''CEEEEEEE
EEEEEEEEC'C'C'C''''C''''''C3'CEEEEEEE
EEEEEEEEC'C'''C''C'C'CCC'CCC'CEEEEEEE
EEEEEEEEC'CC''C''C'C'''''C'''CEEEEEEE
EEEEEEEEC'C''CCCCC'CCCCC'C'C'CEEEEEEE
EEEEEEEEC'C3'''''''C'''''C'C'CEEEEEEE
EEEEEEEEC'CCCCCCCCCCCCCC'CCC'CEEEEEEE
EEEEEEEEC''''''''''''''''''''CEEEEEEE
EEEEEEEECCCCCCCCCCCCCCCCCCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE]]

mapdataå¢“å ´B4 = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEECCCCCCCCCCCCEEEEEEE
EEEEEEECCCCCC'CCCCCEEEEEEE
EEEEEEECCCCC'''CCCCEEEEEEE
EEEEEEECCCC''C''CCCEEEEEEE
EEEEEEECCC''CCC''CCEEEEEEE
EEEEEEEC3''CC3''''CEEEEEEE
EEEEEEECCC''CCC''CCEEEEEEE
EEEEEEECCCC''C''CCCEEEEEEE
EEEEEEECCCCC'''CCCCEEEEEEE
EEEEEEECCCCCC'CCCCCEEEEEEE
EEEEEEECCCCCCCCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE]]

build = ->
	with Town(mapdata)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,20,10})
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒžãƒƒãƒ—').build_atã‚¬ãƒ©ã‚¤ã®ç”º()
		.charactors[] = with Charactor(10,8,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œãµã‚‹ã„ã€€ã„ã„ã¤ãŸãˆã§ã¯ã€€ã„ã ã„ãªã€€ãŽã‚“ã‚†ã†ã—ã˜ã‚“ã€€ã‚¬ãƒ©ã‚¤ãŒã€€ã“ã®ã¾ã¡ã‚’ã€€ã¤ãã£ãŸãã†ã§ã™ã€‚ðŸ”»"})\attach()
		.charactors[] = é“å…·å±‹(13, 9, {{L"ã‚„ããã†", 10}, {L"ãŸã„ã¾ã¤", 8}, {L"ã‚Šã‚…ã†ã®ã†ã‚ã“", 20} })
		.charactors[] = with Charactor(10,15,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã†ã‚ã•ã§ã¯ã€€ãƒ­ãƒ¼ãƒ©ã²ã‚ã¯\nã©ã“ã‹ã®ã€€ã©ã†ãã¤ã«ã€€ã¨ã˜ã“ã‚ã‚‰ã‚ŒãŸãã†ã˜ã‚ƒã€‚ðŸ”»", L'\nã‚‚ã†ã€€ãŸã™ã‘ãŸã•ã‚ŒãŸã‹ã®ã†â€¦ã€‚ðŸ”»'})\attach()
		.charactors[] = with Charactor(15,15,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŠã‚Œã¯ã€€ã¿ã‚„ãŠã†ã ã€‚\nã‚­ãƒ ã“ã†ã‚’ã€€ã•ãŒã—ã¦ã„ã‚‹ã€‚ðŸ”»"})\attach()
		.charactors[] = æ­¦å™¨å±‹(18, 16, {{L'ã“ã‚“ã¼ã†', 60}, {L'ã©ã†ã®ã¤ã‚‹ãŽ', 180}, {L'ã¦ã¤ã®ãŠã®', 560}, {L'ã‹ã‚ã®ãµã', 70}, {L'ãã•ã‚Šã‹ãŸã³ã‚‰', 300}, {L'ã¦ã¤ã®ã‚ˆã‚ã„', 1000}, {L'ã¦ã¤ã®ãŸã¦', 800} })
		.charactors[] = with Charactor(18,8,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã‚€ã‹ã—ãŒãŸã‚Šã®ã¾ã¡\nã€€ã€€ã‚¬ãƒ©ã‚¤ã¸ã€€ã‚ˆã†ã“ãã€‚ðŸ”»" })\attach()
		.charactors[] = with Charactor(20,9,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã‚ãŸã—ã¯ã€€ãã„ãŸï¼\nã€€ã€€ãªã‚“ã¨ã€€ã²ã‚ã‚’ã€€ã•ã‚‰ã£ãŸã¾ã‚‚ã®ãŒã²ãŒã—ã®ã»ã†ã«ã€€ã¨ã³ã•ã£ãŸã¨ã‹ï¼ðŸ”»"})\attach()
		.charactors[] = å®¿å±‹(25, 13, 25)
		.charactors[] = æ‰‰(25, 8, 'ã‚¬ãƒ©ã‚¤ã®å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã®æ‰‰')
		.traps[] = with {25, 8}
			.talk = => Scene.current = build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹_fromç”º()


export build_fromè¥¿å£ = ->
	with build()
		g_player.x, g_player.y = 8, 12
		BGM('assets/sounds/mml2ogg/town.ogg')

export build_fromæ±å£ = ->
	with build()
		g_player.x, g_player.y = 27, 10
		BGM('assets/sounds/mml2ogg/town.ogg')

build_fromå¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ = ->
	with build()
		g_player.x, g_player.y = 25, 9
		BGM('assets/sounds/mml2ogg/town.ogg')

-------------------------------
build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ = ->
	with Town(mapdataå¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹)
		.charactors[] = with Charactor(21,13,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã†ã‚ã•ã§ã¯ã€€ã©ã“ã‹ã«\nã€€ã€€ã‚†ã†ã—ã‚ƒã€€ãƒ­ãƒˆã®ãã¦ã„ãŸ\nã€€ã€€ã‚ˆã‚ã„ãŒã€€ã‚ã‚‹ã‚‰ã—ã„ã€‚ðŸ”»'})\attach()
		.charactors[] = with Charactor(19,9,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€ŒãŠã¨ã“ãªã‚“ã¦ã€€ãã‚‰ã„ã‚ˆã€‚\nã€€ã€€ã—ã£ã—ã£ã€‚ðŸ”»' })\attach()
		.charactors[] = with Charactor(16,13,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã¯ã‚‹ã‹ã€€ã¿ãªã¿ã«ã€€ãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®\nã€€ã€€ã¾ã¡ãŒã€€ã‚ã‚Šã¾ã—ãŸã€‚\nã€€ã€€ã„ã¾ã‚‚ã€€ã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹â€¦â€¦ã€‚ðŸ”»'})\attach()
		.charactors[] = å®ç®±(16, 11, 630)
		.charactors[] = å®ç®±(16, 10, L'ãŸã„ã¾ã¤')
		.charactors[] = å®ç®±(17, 10, L'ã©ã†ã®ã¤ã‚‹ãŽ')
		.charactors[] = with Charactor(17,11,{0x3e,0x3f}) -- å•†äºº
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œãˆãƒ¼ã„ã€€ã‚‚ã£ã¦ã‘ï¼ã€€ã©ã‚ã¼ã†ï¼ðŸ”»"})\attach()
		.charactors[] = with Charactor(11,10,{0x34,0x35}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã‚ãŸã—ã¯ã€€ã„ããŒã—ã„\nã€€ã€€ã¨ãªã‚Šã®ã‚„ã¤ã«ã€€ãã„ã¦ãã‚Œã€‚ðŸ”»"})\attach()
		.charactors[] = with Charactor(13,10,{0x34,0x35}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã‚ãŸã—ã¯ã€€ã„ããŒã—ã„\nã€€ã€€ã¨ãªã‚Šã®ã‚„ã¤ã«ã€€ãã„ã¦ãã‚Œã€‚ðŸ”»"})\attach()
		.charactors[] = æ‰‰(12, 11, 'ã‚¬ãƒ©ã‚¤ã®å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹å†…éƒ¨ã®å°éƒ¨å±‹ã®æ‰‰')
		.traps[] = with {25, 16}
			.talk = => Scene.current = build_fromå¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹()
		.traps[] = with {11, 7}
			.talk = => Scene.current = build_å¢“å ´é€šè·¯_fromã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹()
	
build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹_fromç”º = ->
	with build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹()
		g_player.x, g_player.y = 25, 15

build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹_fromé€šè·¯ = ->
	with build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹()
		g_player.x, g_player.y = 11, 8

----------------------------------
build_å¢“å ´é€šè·¯ = ->
	with Town(mapdataå¢“å ´é€šè·¯)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,20,4})
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout(->Scene.current = require('DQ1_å…¨ä½“ãƒžãƒƒãƒ—').build_atã‚¬ãƒ©ã‚¤ã®ç”º())
		.charactors[] = with Charactor(22,9,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŸã¦ã”ã¨ã¯ã€€ã¾ã‚‚ã®ãŸã¡ã‚’\nã‚ˆã³ã‚ˆã›ã‚‹\nã‚¬ãƒ©ã‚¤ã®ã¯ã‹ã«ã€€ã¡ã‹ã‚ˆã‚‹ãªï¼ðŸ”»"})\attach()
		.traps[] = with {11, 11}
			.talk = => Scene.current = build_å¢“å ´ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹_fromé€šè·¯()
		.traps[] = with {27, 8}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B1_fromé€šè·¯()

build_å¢“å ´é€šè·¯_fromã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ = ->
	with build_å¢“å ´é€šè·¯()
		g_player.x, g_player.y = 11, 10

build_å¢“å ´é€šè·¯_fromB1 = ->
	with build_å¢“å ´é€šè·¯()
		g_player.x, g_player.y = 27, 8
		BGM Town.BGM

--------------------------------------
class ã‚¬ãƒ©ã‚¤ã®å¢“ extends Dungeon
	ãƒªãƒ¬ãƒŸãƒˆ: => Scene.current\blackout -> Scene.current = build_å¢“å ´é€šè·¯_fromB1()

build_å¢“å ´B1 = ->
	with ã‚¬ãƒ©ã‚¤ã®å¢“(mapdataå¢“å ´B1)
		.traps[] = with {15, 20} -- å…¥å£
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´é€šè·¯_fromB1()
		.traps[] = with {10, 27}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B2_fromB1()
		.charactors[] = å®ç®±(20 ,9, L'ã‚„ããã†')
		.charactors[] = å®ç®±(21, 9, math.random(5, 20))
		.charactors[] = å®ç®±(22, 9, math.random(6, 13))
		.charactors[] = æ‰‰(27, 26, 'ã‚¬ãƒ©ã‚¤ã®å¢“B1ã®æ‰‰')
		_monster = -> generateMonster lume.weightedchoice {ãƒ¡ãƒˆãƒ­ã‚´ãƒ¼ã‚¹ãƒˆ: 1, ãƒ‰ãƒ­ãƒ«: 1, ãƒ‰ãƒ©ã‚­ãƒ¼ãƒž: 1, ãŒã„ã“ã¤: 1, ã¾ã©ã†ã—: 1}
		.traps[] = with {}
			.check = (_)-> math.random() < 0.2
			.talk = => Battle(_monster())\attach()
		.ãŽã‚“ã®ãŸã¦ã”ã¨ = => Battle(_monster())\attach()

build_å¢“å ´B1_fromé€šè·¯ = ->
	with build_å¢“å ´B1()
		g_player.x, g_player.y = 15, 20
		g_player.ãŸã„ã¾ã¤ = false
		BGM Dungeon.BGM

build_å¢“å ´B1_fromB2 = ->
	with build_å¢“å ´B1()
		g_player.x, g_player.y = 10, 27

------------------------------------
build_å¢“å ´B2 = ->
	with ã‚¬ãƒ©ã‚¤ã®å¢“(mapdataå¢“å ´B2)
		.traps[] = with {21, 12}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B1_fromB2()
		.traps[] = with {11, 11}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB2_1()
		.traps[] = with {22, 11}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB2_2()
		.traps[] = with {15, 16}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB2_3()
		.traps[] = with {11, 20}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB2_4()
		.traps[] = with {22, 20}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB2_5()
		_monster = -> generateMonster lume.weightedchoice {ãŒã„ã“ã¤: 1, ã¾ã©ã†ã—: 1, ã¦ã¤ã•ãã‚Š: 1, ãƒªã‚«ãƒ³ãƒˆ: 2}
		.traps[] = with {}
			.check = (_)-> math.random() < 0.2
			.talk = => Battle(_monster())\attach()
		.ãŽã‚“ã®ãŸã¦ã”ã¨ = => Battle(_monster())\attach()

build_å¢“å ´B2_fromB1 = ->
	with build_å¢“å ´B2()
		g_player.x, g_player.y = 21, 12

build_å¢“å ´B2_fromB3_1 = ->
	with build_å¢“å ´B2()
		g_player.x, g_player.y = 11, 11
build_å¢“å ´B2_fromB3_2 = ->
	with build_å¢“å ´B2()
		g_player.x, g_player.y = 22, 11
build_å¢“å ´B2_fromB3_3 = ->
	with build_å¢“å ´B2()
		g_player.x, g_player.y = 15, 16
build_å¢“å ´B2_fromB3_4 = ->
	with build_å¢“å ´B2()
		g_player.x, g_player.y = 11, 20
build_å¢“å ´B2_fromB3_5 = ->
	with build_å¢“å ´B2()
		g_player.x, g_player.y = 22, 20

------------------------------------
build_å¢“å ´B3 = ->
	with ã‚¬ãƒ©ã‚¤ã®å¢“(mapdataå¢“å ´B3)
		.traps[] = with {23, 10}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B2_fromB3_1()
		.traps[] = with {27, 10}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B2_fromB3_2()
		.traps[] = with {15, 20}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B2_fromB3_3()
		.traps[] = with {11, 26}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B2_fromB3_4()
		.traps[] = with {27, 22}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B2_fromB3_5()
		.traps[] = with {18, 14}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B4_fromB3_1()
		.traps[] = with {19, 18}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B4_fromB3_2()
		if not lume.find(g_player.items, L'ãŽã‚“ã®ãŸã¦ã”ã¨')
			.charactors[] = å®ç®±(22, 9, L'ãŽã‚“ã®ãŸã¦ã”ã¨')
		.charactors[] = å®ç®±(10, 10, L'ã®ã‚ã„ã®ãƒ™ãƒ«ãƒˆ') -- todo ï¼’å›žç›®ä»¥é™
		-- .ãƒªãƒ¬ãƒŸãƒˆ = => Scene.current\blackout -> Scene.current = build_å¢“å ´é€šè·¯_fromB1()
		_monster = -> generateMonster lume.weightedchoice {ãƒ˜ãƒ«ã‚´ãƒ¼ã‚¹ãƒˆ: 1, ãƒªã‚«ãƒ³ãƒˆãƒžãƒ«ãƒ : 1, ãƒ¡ãƒ¼ãƒ€ãƒ­ãƒ¼ãƒ‰: 1, ãƒ‰ãƒ­ãƒ«ãƒ¡ã‚¤ã‚¸: 1, ã—ã‚Šã‚‡ã†ã®ãã—: 1}
		.traps[] = with {}
			.check = (_)-> math.random(_monster()) < 0.2
			.talk = => Battle(_monster())\attach()
		.ãŽã‚“ã®ãŸã¦ã”ã¨ = => Battle(_monster())\attach()

build_å¢“å ´B3_fromB2_1 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 23, 10
build_å¢“å ´B3_fromB2_2 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 27, 10
build_å¢“å ´B3_fromB2_3 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 15, 20
build_å¢“å ´B3_fromB2_4 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 11, 26
build_å¢“å ´B3_fromB2_5 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 27, 22

build_å¢“å ´B3_fromB4_1 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 18, 14
build_å¢“å ´B3_fromB4_2 = ->
	with build_å¢“å ´B3()
		g_player.x, g_player.y = 19, 18

------------------------------------
build_å¢“å ´B4 = ->
	with ã‚¬ãƒ©ã‚¤ã®å¢“(mapdataå¢“å ´B4)
		.traps[] = with {8, 13}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB4_1()
		.traps[] = with {12, 13}
			.talk = =>
				play'assets/DQ1/éšŽæ®µ.ogg'
				Scene.current\blackout -> Scene.current = build_å¢“å ´B3_fromB4_2()
		_monster = -> generateMonster lume.weightedchoice {ãƒ˜ãƒ«ã‚´ãƒ¼ã‚¹ãƒˆ: 1, ãƒªã‚«ãƒ³ãƒˆãƒžãƒ«ãƒ : 1, ãƒ¡ãƒ¼ãƒ€ãƒ­ãƒ¼ãƒ‰: 1, ãƒ‰ãƒ­ãƒ«ãƒ¡ã‚¤ã‚¸: 1, ã—ã‚Šã‚‡ã†ã®ãã—: 1}
		.traps[] = with {}
			.check = (_)-> math.random() < 0.2
			.talk = => Battle(_monster())\attach()
		.ãŽã‚“ã®ãŸã¦ã”ã¨ = => Battle(_monster())\attach()

build_å¢“å ´B4_fromB3_1 = ->
	with build_å¢“å ´B4()
		g_player.x, g_player.y = 8, 13

build_å¢“å ´B4_fromB3_2 = ->
	with build_å¢“å ´B4()
		g_player.x, g_player.y = 12, 13
