import 'macros' as {$}
import 'utl' as :L, :pos_in_box, :play
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Town, :Charactor, :g_player, :MessageBoxRetro, :SelectBoxRetro, :宿屋, :武器屋, :道具屋, :扉
local *


mapdata = $to2d [[
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""CCC!"""CCCCC""""""""CCCC""""""""""
""""""""C'C!!""C'''C""""""CJC''C""""""""""
""""""""CAC,!""''P''$$$$$$'''''C""""""""""
"""""""",',,!""C'''C!$""""CACCCC""""""""""
"""""""",,,!!CCCC'CC!$""""C'C"""""""""""""
""""""""!,!!!C"""""""$""""CCC"""""""""""""
""""""""!!!!"C"""""""$""""""""""""""""""""
"""""""""!!""C"""""""$""""""""""""""""""""
""""""""""CCCCCC""""$$$"""""""""""""""""""
"""""""""""""""C"""$$$$$""""""""""""""""""
""""""""CCCCC""C""$$$$$$$"CCCCCC""""""""""
""""""""C'''C""C"$$$$$$$$$C''C'C""""""""""
""""""""C'''C"$$$$$$$$$$$$'''A'C""""""""""
""""""""C'''C"$C"$$$$$$$$$C''C'C""""""""""
""""""""C'CCC'$C""$$$$$$$"CCCCCC""""""""""
""""""""C'C''''C"""$$$$$""""""""""""""""""
""""""""C'C'CCCCCCC"$$$"""""!!!"""""""""""
""""""""C'''C'''''C""$""""CCCC""""""""""""
""""""""C'C'C'!'!'C""$$$$$$$$C""""""""""""
""""""""C'C'''''''C"CCCCC"$$$C""""""""""""
""""""""C'''C'''''CCC''FC"$$$C""""""""""""
""""""""CC'CC'!'!''''A'FC""$""""""""""""""
"""""""""!!!C'''''CCC''FC""$""""""""""""""
""""""""""!!CCCCCCC"CCCCC""$""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""]]


export build = ->
	with Town(mapdata)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,24,24})
			.talk = =>
				play'assets/DQ1/階段.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_全体マップ').build_atマイラの村()
		.charactors[] = with Charactor(28,27,{0x3a,0x3b}) -- 老人
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'＊「ここは　マイラの　むらです。🔻'})\attach()
		.charactors[] = with Charactor(23,21,{0x40,0x41}) -- 男の子
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'＊「みなみのしまは　とても　こわい\n　　ところです。🔻', L"\n＊「じゅうぶんに　ちからを　つけてから\n　　いかないと　いきて\n　　もどれないでしょう。🔻"})\attach()
		.charactors[] = with Charactor(20,20,{0x38,0x39}) -- 戦士
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'＊「ゴーレムは　ふえのね が\n　　にがてだときく。🔻' })\attach()
		.charactors[] = with Charactor(17,23,{0x3c,0x3d}) -- 女の子
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'＊「どうか　まものたちを\n　　たおして　ください。🔻' })\attach()
		.charactors[] = with Charactor(28,21,{0x38,0x39}) -- 戦士
			.talk = => MessageBoxRetro({ L'＊「ドムドーラの　はるかひがしに\n　　すばらしいぶきを\n　　うっているまちが　あるらしい。🔻' })\attach()
		.charactors[] = 武器屋(30,20,{{L'どうのつるぎ', 108}, {L'てつのおの', 560}, {L'てつのよろい', 1000}, {L'はがねのよろい', 3000}, {L"かわのたて", 90} })
		.charactors[] = with Charactor(28,23,{0x3a,0x3b}) -- 老人
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'＊「ふるい　いいつたえでは\n　　ようせいたちは　ゴーレムを\n　　ねむらせた　そうじゃ。🔻'})\attach()
		.charactors[] = with Charactor(20,9,{0x3c,0x3d}) -- 女性
			.talk = => MessageBoxRetro({ L'＊「ここは　ろてんぶろで\n　　ございまーす。🔻', L'＊「こうのうは　リュウマチで\n　　ございまーす。🔻'})\attach()
		.charactors[] = 扉(15, 20, 'マイラの村の扉1')
		.charactors[] = with Charactor(14,18,{0x40,0x41}) -- 男の子
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'＊「おまえがロトのちをひくもの？\n　　なにかしょうこがあるのか？🔻'})\attach() --[ ] todo:まとめられないか？
		.charactors[] = with Charactor(9,31,{0x38,0x39}) -- 戦士
			.talk = => MessageBoxRetro({ L'＊「うわさでは　リムルダールに\nカギをうるみせが　あるらしい。🔻'})\attach()
		.charactors[] = with Charactor(8,31,{0x3e,0x3f}) -- 商人
			.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
				coroutine.yield 1, L'＊「みなみの　しまに　いきましたか？'
				sb = SelectBoxRetro({L'はい', L'いいえ'})
				coroutine.yield 1, sb\attach()
				if sb.index == 1
					coroutine.yield 1, L'\n＊「なんと！　とても　つよい\n　　まものたちが　いるとききましたが🔻'
				else
					coroutine.yield 1, L'\n＊「みなみには　リムルダールという\n　　まちが　あるらしいです。🔻'
				nil
			)})\attach() -- はい　いいえを挟む
		.charactors[] = 宿屋(27,12,20)
		.charactors[] = 道具屋(22,29,{{L"やくそう", 24}, {L"たいまつ", 8}, {L"りゅうのうろこ", 20}, {L"キメラのつばさ", 70} })
		.charactors[] = 扉(9, 22, 'マイラの村の扉2')
		.charactors[] = with Charactor(9,9,{0x3a,0x3b}) -- 老人
			.talk = =>
				if g_player.武器 == L'ロトのつるぎ' or lume.find(g_player.items, L'ロトのつるぎ')
					MessageBoxRetro({ L('＊「ついに　てにいれたな\n　　ゆうしゃ　%sよ！🔻')\format(g_player.name)})\attach()
				else
					MessageBoxRetro({ L'＊「ロトの　ちをひく　ゆうしゃよ！\n　　しかし　そのぶきでは\n　　りゅうおうを　たおせまいぞ！🔻', L'\n＊「またくるがよい🔻'})\attach()
		.charactors[] = with Charactor(10,20,{0x3a,0x3b}) -- 老人
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
				coroutine.yield 1, L'＊「ふえを　てにいれたか？'
				sb = SelectBoxRetro({L'はい', L'いいえ'})
				coroutine.yield 1, sb\attach()
				if sb.index == 1
					coroutine.yield 1, L'\n＊「メルキドのまちに　ゆくがよい。🔻'
				else
					coroutine.yield 1, L'\n＊「よしりーんが　もっていたが\n　　リムルダールにいくといって\n　　むらをでて　それっきりかえらぬ。🔻'
				nil
			)})\attach()
		.しらべる = => if 17 == g_player.x and 14 == g_player.y then 'ようせいのふえ' else nil
		g_player.x, g_player.y = 27, 31
		BGM Town.BGM
