import 'macros' as {$}
import 'utl' as :L, :pos_in_box, :play
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Town, :Charactor, :g_player, :MessageBoxRetro, :SelectBoxRetro, :å®¿å±‹, :æ­¦å™¨å±‹, :é“å…·å±‹, :æ‰‰
local *


mapdata = $to2d [[
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""CCC!"""CCCCC""""""""CCCC""""""""""
""""""""C'C!!""C'''C""""""CJC''C""""""""""
""""""""CAC,!""''P''$$$$$$'''''C""""""""""
"""""""",',,!""C'''C!$""""CACCCC""""""""""
"""""""",,,!!CCCC'CC!$""""C'C"""""""""""""
""""""""!,!!!C"""""""$""""CCC"""""""""""""
""""""""!!!!"C"""""""$""""""""""""""""""""
"""""""""!!""C"""""""$""""""""""""""""""""
""""""""""CCCCCC""""$$$"""""""""""""""""""
"""""""""""""""C"""$$$$$""""""""""""""""""
""""""""CCCCC""C""$$$$$$$"CCCCCC""""""""""
""""""""C'''C""C"$$$$$$$$$C''C'C""""""""""
""""""""C'''C"$$$$$$$$$$$$'''A'C""""""""""
""""""""C'''C"$C"$$$$$$$$$C''C'C""""""""""
""""""""C'CCC'$C""$$$$$$$"CCCCCC""""""""""
""""""""C'C''''C"""$$$$$""""""""""""""""""
""""""""C'C'CCCCCCC"$$$"""""!!!"""""""""""
""""""""C'''C'''''C""$""""CCCC""""""""""""
""""""""C'C'C'!'!'C""$$$$$$$$C""""""""""""
""""""""C'C'''''''C"CCCCC"$$$C""""""""""""
""""""""C'''C'''''CCC''FC"$$$C""""""""""""
""""""""CC'CC'!'!''''A'FC""$""""""""""""""
"""""""""!!!C'''''CCC''FC""$""""""""""""""
""""""""""!!CCCCCCC"CCCCC""$""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""
""""""""""""""""""""""""""""""""""""""""""]]


export build = ->
	with Town(mapdata)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,24,24})
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atãƒã‚¤ãƒ©ã®æ‘()
		.charactors[] = with Charactor(28,27,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã“ã“ã¯ã€€ãƒã‚¤ãƒ©ã®ã€€ã‚€ã‚‰ã§ã™ã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(23,21,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã¿ãªã¿ã®ã—ã¾ã¯ã€€ã¨ã¦ã‚‚ã€€ã“ã‚ã„\nã€€ã€€ã¨ã“ã‚ã§ã™ã€‚ğŸ”»', L"\nï¼Šã€Œã˜ã‚…ã†ã¶ã‚“ã«ã€€ã¡ã‹ã‚‰ã‚’ã€€ã¤ã‘ã¦ã‹ã‚‰\nã€€ã€€ã„ã‹ãªã„ã¨ã€€ã„ãã¦\nã€€ã€€ã‚‚ã©ã‚Œãªã„ã§ã—ã‚‡ã†ã€‚ğŸ”»"})\attach()
		.charactors[] = with Charactor(20,20,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚´ãƒ¼ãƒ¬ãƒ ã¯ã€€ãµãˆã®ã­ ãŒ\nã€€ã€€ã«ãŒã¦ã ã¨ããã€‚ğŸ”»' })\attach()
		.charactors[] = with Charactor(17,23,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã©ã†ã‹ã€€ã¾ã‚‚ã®ãŸã¡ã‚’\nã€€ã€€ãŸãŠã—ã¦ã€€ãã ã•ã„ã€‚ğŸ”»' })\attach()
		.charactors[] = with Charactor(28,21,{0x38,0x39}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ã€€ã¯ã‚‹ã‹ã²ãŒã—ã«\nã€€ã€€ã™ã°ã‚‰ã—ã„ã¶ãã‚’\nã€€ã€€ã†ã£ã¦ã„ã‚‹ã¾ã¡ãŒã€€ã‚ã‚‹ã‚‰ã—ã„ã€‚ğŸ”»' })\attach()
		.charactors[] = æ­¦å™¨å±‹(30,20,{{L'ã©ã†ã®ã¤ã‚‹ã', 108}, {L'ã¦ã¤ã®ãŠã®', 560}, {L'ã¦ã¤ã®ã‚ˆã‚ã„', 1000}, {L'ã¯ãŒã­ã®ã‚ˆã‚ã„', 3000}, {L"ã‹ã‚ã®ãŸã¦", 90} })
		.charactors[] = with Charactor(28,23,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œãµã‚‹ã„ã€€ã„ã„ã¤ãŸãˆã§ã¯\nã€€ã€€ã‚ˆã†ã›ã„ãŸã¡ã¯ã€€ã‚´ãƒ¼ãƒ¬ãƒ ã‚’\nã€€ã€€ã­ã‚€ã‚‰ã›ãŸã€€ãã†ã˜ã‚ƒã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(20,9,{0x3c,0x3d}) -- å¥³æ€§
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã“ã“ã¯ã€€ã‚ã¦ã‚“ã¶ã‚ã§\nã€€ã€€ã”ã–ã„ã¾ãƒ¼ã™ã€‚ğŸ”»', L'ï¼Šã€Œã“ã†ã®ã†ã¯ã€€ãƒªãƒ¥ã‚¦ãƒãƒã§\nã€€ã€€ã”ã–ã„ã¾ãƒ¼ã™ã€‚ğŸ”»'})\attach()
		.charactors[] = æ‰‰(15, 20, 'ãƒã‚¤ãƒ©ã®æ‘ã®æ‰‰1')
		.charactors[] = with Charactor(14,18,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€ŒãŠã¾ãˆãŒãƒ­ãƒˆã®ã¡ã‚’ã²ãã‚‚ã®ï¼Ÿ\nã€€ã€€ãªã«ã‹ã—ã‚‡ã†ã“ãŒã‚ã‚‹ã®ã‹ï¼ŸğŸ”»'})\attach() --[ ] todo:ã¾ã¨ã‚ã‚‰ã‚Œãªã„ã‹ï¼Ÿ
		.charactors[] = with Charactor(9,31,{0x38,0x39}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã†ã‚ã•ã§ã¯ã€€ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã«\nã‚«ã‚®ã‚’ã†ã‚‹ã¿ã›ãŒã€€ã‚ã‚‹ã‚‰ã—ã„ã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(8,31,{0x3e,0x3f}) -- å•†äºº
			.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
				coroutine.yield 1, L'ï¼Šã€Œã¿ãªã¿ã®ã€€ã—ã¾ã«ã€€ã„ãã¾ã—ãŸã‹ï¼Ÿ'
				sb = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
				coroutine.yield 1, sb\attach()
				if sb.index == 1
					coroutine.yield 1, L'\nï¼Šã€Œãªã‚“ã¨ï¼ã€€ã¨ã¦ã‚‚ã€€ã¤ã‚ˆã„\nã€€ã€€ã¾ã‚‚ã®ãŸã¡ãŒã€€ã„ã‚‹ã¨ããã¾ã—ãŸãŒğŸ”»'
				else
					coroutine.yield 1, L'\nï¼Šã€Œã¿ãªã¿ã«ã¯ã€€ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã¨ã„ã†\nã€€ã€€ã¾ã¡ãŒã€€ã‚ã‚‹ã‚‰ã—ã„ã§ã™ã€‚ğŸ”»'
				nil
			)})\attach() -- ã¯ã„ã€€ã„ã„ãˆã‚’æŒŸã‚€
		.charactors[] = å®¿å±‹(27,12,20)
		.charactors[] = é“å…·å±‹(22,29,{{L"ã‚„ããã†", 24}, {L"ãŸã„ã¾ã¤", 8}, {L"ã‚Šã‚…ã†ã®ã†ã‚ã“", 20}, {L"ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•", 70} })
		.charactors[] = æ‰‰(9, 22, 'ãƒã‚¤ãƒ©ã®æ‘ã®æ‰‰2')
		.charactors[] = with Charactor(9,9,{0x3a,0x3b}) -- è€äºº
			.talk = =>
				if g_player.æ­¦å™¨ == L'ãƒ­ãƒˆã®ã¤ã‚‹ã' or lume.find(g_player.items, L'ãƒ­ãƒˆã®ã¤ã‚‹ã')
					MessageBoxRetro({ L('ï¼Šã€Œã¤ã„ã«ã€€ã¦ã«ã„ã‚ŒãŸãª\nã€€ã€€ã‚†ã†ã—ã‚ƒã€€%sã‚ˆï¼ğŸ”»')\format(g_player.name)})\attach()
				else
					MessageBoxRetro({ L'ï¼Šã€Œãƒ­ãƒˆã®ã€€ã¡ã‚’ã²ãã€€ã‚†ã†ã—ã‚ƒã‚ˆï¼\nã€€ã€€ã—ã‹ã—ã€€ãã®ã¶ãã§ã¯\nã€€ã€€ã‚Šã‚…ã†ãŠã†ã‚’ã€€ãŸãŠã›ã¾ã„ãï¼ğŸ”»', L'\nï¼Šã€Œã¾ãŸãã‚‹ãŒã‚ˆã„ğŸ”»'})\attach()
		.charactors[] = with Charactor(10,20,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
				coroutine.yield 1, L'ï¼Šã€Œãµãˆã‚’ã€€ã¦ã«ã„ã‚ŒãŸã‹ï¼Ÿ'
				sb = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
				coroutine.yield 1, sb\attach()
				if sb.index == 1
					coroutine.yield 1, L'\nï¼Šã€Œãƒ¡ãƒ«ã‚­ãƒ‰ã®ã¾ã¡ã«ã€€ã‚†ããŒã‚ˆã„ã€‚ğŸ”»'
				else
					coroutine.yield 1, L'\nï¼Šã€Œã‚ˆã—ã‚Šãƒ¼ã‚“ãŒã€€ã‚‚ã£ã¦ã„ãŸãŒ\nã€€ã€€ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã«ã„ãã¨ã„ã£ã¦\nã€€ã€€ã‚€ã‚‰ã‚’ã§ã¦ã€€ãã‚Œã£ãã‚Šã‹ãˆã‚‰ã¬ã€‚ğŸ”»'
				nil
			)})\attach()
		.ã—ã‚‰ã¹ã‚‹ = => if 17 == g_player.x and 14 == g_player.y then 'ã‚ˆã†ã›ã„ã®ãµãˆ' else nil
		g_player.x, g_player.y = 27, 31
		BGM Town.BGM
