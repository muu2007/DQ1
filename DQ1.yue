import 'macros' as {$}
_G.PROJECTNAME, _G.VERSION = $FILE\sub(1,-5), "0.1a(#{$DATE})"
import 'utf8'
import 'lib.lume'
import 'utl' as :L, :issubclass, :pos_in_box, :play, :toZenkaku
import 'lib.maid64' -- æ”¹é€ ã—ã¦y>256ã®å ´åˆã€linearã§msaa=2ã¨ã—ãŸ
-- require 'lib.gifcat' -- å…¨éƒ¨ã«?å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“æ¶ˆã™ã ã‘ã§ä½¿ã‚ãªããªã‚‹
import 'ui' as :Scene, :SelectBox, :MessageBox, :BGM, :Watchdog
import 'input' as :input, :SoftGamepad
import 'BDF'
import 'lib.tween' -- æ”¹é€ ã—ã¦delayã‚’å¯èƒ½ã«ã—ãŸ
import 'color' as :hsv
import 'bigmap' as :Map
vudu = if DEBUGMODE then require 'lib.vudu' else nil
if DEBUGMODE then require 'lib.inspect'
local *

love.window.setTitle(PROJECTNAME .. ' - v' .. VERSION)
love.window.setMode(800, 512, if 'Android' == love.system.getOS() then {fullscreen: true, msaa:2} else {resizable: true, msaa: 2}) -- ãƒ¬ãƒˆãƒ­ç”»é¢ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã ã‘ãªã‚‰anti aliasä¸è¦ã€‚gamepadæã„ã¦ã„ã‚‹ã®ã§msaaã¤ã‘ãŸ
maid64.setup(256, 256)
-- if 'Android' == love.system.getOS() then maid64.canvas\setFilter('linear')
love.mouse.getPosition = maid64.mouse.getPosition -- ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã¨ã—ã¦maid64ã®åº§æ¨™ç³»ã‚’ä½¿ã†ã“ã¨ã«ã™ã‚‹
love.touch.getPosition0 = love.touch.getPosition -- ä¿å­˜
love.touch.getPosition = (id)-> maid64.transformPosition(love.touch.getPosition0(id))
maid64.clearBG = -> gr.clear(gr.uipalette.text)
-- os.lang = nil -- i18nã‚’ç„¡åŠ¹
-- love.audio.setVolume(.65)

-- maid64.canvasã®å¤–(screen)ã«SoftGamepadã‚’æãâ†’æç”»æ™‚ã«ä½ç½®ãªã©ã‚’èª¿æ•´
const softgamepad = SoftGamepad(SoftGamepad.LURDABButtons256)
-- @diagnostic disable-next-line: duplicate-set-field
love.draw = ->
	love.draw1()
	softgamepad.font, font = gr.newFlyweightFont($FONT1SUBSET, 28*maid64.scaler), softgamepad.font
	softgamepad.buttons, buttons = {k, {x*maid64.scaler+maid64.x, y*maid64.scaler+maid64.y, r*maid64.scaler,label,pie} for k, {x,y,r,label,pie} in pairs softgamepad.buttons}, softgamepad.buttons
	softgamepad\draw()
	softgamepad.font, softgamepad.buttons = font, buttons

export play_wait = (fn)->
	s = play fn
	while s\isPlaying() do coroutine.yield 1

gr.uipalette.retro1 = gr.uipalette.base -- ä½“åŠ›ãŒå°‘ãªã„ã¨ãã«èµ¤ã«ã™ã‚‹ã‚‚ã®

const bdf1 = with BDF('assets/fonts/misaki_gothic_2nd.bdf') -- [ ]todo: æ¿ç‚¹ã€åŠæ¿ç‚¹ã‚’åˆ†é›¢ã—ã¦ä¸Šã«æç”»'assets/fonts/quan.bdf')
	.fy = 8

gr.draw_frame = (x, y, w, h, text = nil)->
	gr.rectangle(gr.setColor(gr.uipalette.text) or 'fill', x*8-8, y*8-16, w*8+16, h*8+24, 5)
	gr.rectangle(gr.setColor(gr.uipalette.retro1) or 'line', x*8-8+2, y*8-16+2, w*8+16-4, h*8+24-4, 5)
	if text
		w2 = bdf1\getWidth(text)
		x2 = x*8+idiv((w*8-w2)/2,8)*8
		gr.rectangle(gr.setColor(gr.uipalette.text) or 'fill', x2-2, y*8-16, w2+4, 8)
		gr.points bdf1\points(gr.setColor(gr.uipalette.retro1) or text, x2, y*8-16)
		gr.points()

blink = -> if love.timer.getTime() % 1 > 0.5 then 1 else 0

-- BDFãƒ•ã‚©ãƒ³ãƒˆã§æãã€ä¸€åˆ—ã®ã¿å¯¾å¿œ
export class SelectBoxRetro extends SelectBox
	new: (texts, width , x, y, @title)=>
		@w, @h = width or (math.max unpack [bdf1\getWidth(l) for l in *texts]) / 8 + 1, #texts*2
		@x, @y = x or 30 - @w, y or 23 -  @h
		super(SelectBox.buildButtons(texts, [{@x*8,@y*8+(j-1)*16,@w,16} for j, _ in ipairs texts]))
		for b in *@buttons do b.text = 'ã€€'..b.text
	attach: =>
		super()
		@index = 1
	clickB: =>
		@playClickSE()
		@index = -1
		@detach()
	draw: =>
		@_static_starttime or= love.timer.getTime()
		gr.setScissor(@x*8-8, @y*8-16, @w*8+16, math.min((@h*8+32)*(love.timer.getTime()-@_static_starttime)*20, maid64.sizeY))
		gr.draw_frame(@x, @y, @w, @h-1, @title) -- å¤–å´ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ã‚‰ã‚Œã‚‹ã€‚
		gr.points bdf1\points(b.text, b.box[1], b.box[2]) for b in *@buttons
		gr.points bdf1\points('â—', unpack @buttons[@index].box)
		gr.setScissor()


export class MessageBoxRetro extends MessageBox
	@X, @Y, @W, @H = 6, 24, 20, 6
	new: (texts)=>
		super({@@X*8, @@Y*8, @@W*8, @@H*8}, texts, bdf1)--, 16) --metatableæ¶ˆã•ãªã„ã‚ˆã†ã«
		if issubclass(Scene.current.__class, Town) then play('assets/sounds/åŠ¹æœéŸ³ãƒ©ãƒœ/ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•12.mp3') -- todo æœ¬å½“ã¯æˆ¦é—˜ã ã‘æ¶ˆã—ãŸã„(ãƒˆãƒ˜ãƒ­ã‚¹ã®åŠ¹æœãŒãªããªã£ãŸã‚„ç«œç‹ã«è©±ã—ã‹ã‘ã‚‹ã¨ãã¯é³´ã‚‰ã—ãŸã„)
		@overlapping_color = {0,0,0,0} -- æ¼”å‡ºã«ã¤ã‹ã†

	draw: =>
		gr.uipalette.retro1 =if g_player.hp / g_player.maxhp > 1/3 then gr.uipalette.base else {lume.color'#cc3333'} -- æœ¬å½“ã¯hpãŒå¢—æ¸›ã™ã‚‹å ´æ‰€ã«æ›¸ãã¹ãã ãŒFieldã§ã®ç§»å‹•ä»¥å¤–ã¯åˆ†æ•£ã—ã¦ã„ã‚‹ã®ã§ã“ã“ã§
		gr.draw_frame(@@X, @@Y, @@W, @@H)
		setFont0, gr.setFont = gr.setFont, -> -- fontã‚’ä¸€æ™‚çš„ã«bdfã«ã™ã‚‹ãŸã‚
		draw_text0, gr.draw_text = gr.draw_text, (text, x, y)-> gr.points(@font\points(text, x, y))
		gr.setColor(gr.uipalette.retro1)
		super()
		gr.setFont, gr.draw_text = setFont0, draw_text0 -- æˆ»ã™
		gr.rectangle(gr.setColor(@overlapping_color) or 'fill', 0, 0, maid64.sizeX, maid64.sizeY)

	draw_gold: =>
		X, Y, W, H = 3, 5, 6, 1
		gr.draw_frame(X, Y, W, H, g_player.name)
		gr.points bdf1\points(gr.setColor(gr.uipalette.retro1) or 'ï¼§'..'ã€€'\rep(5-#tostring(g_player.gold))..toZenkaku(g_player.gold), X*8, Y*8)

	draw_hpmp: =>
		X, Y, W, H = 3, 5, 6, 3
		gr.draw_frame(X, Y, W, H, g_player.name)
		gr.points bdf1\points(gr.setColor(gr.uipalette.retro1) or 'ï¼¨ï¼°'..'ã€€'\rep(4-#tostring(g_player.hp))..toZenkaku(g_player.hp)..'\nï¼­ï¼°'..'ã€€'\rep(4-#tostring(g_player.mp))..toZenkaku(g_player.mp), X*8, Y*8)



export class Charactor -- NPCã‚‚ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚‚ã“ã‚Œã§è¡¨ã›ã‚‹ãŒã€åˆ†ã‘ã‚‹ã¹ãã‹ï¼Ÿ
	new: (x, y, chipids)=>
		@x, @y, @direction, @chipids, @hp, @mp, @maxhp, @maxmp, @spells, @items, @gold, @çµŒé¨“å€¤ = x, y, {0, -1}, chipids, 15, 0, 15, 0, {}, {}, 0, 0
		@ã¡ã‹ã‚‰, @ç´ æ—©ã•, @æ­¦å™¨, @é§, @ç›¾ = 4, 4, nil, nil, nil
		@flags, @æ”»æ’ƒå›é¿ç‡, @ã‚®ãƒ©ç³»å›é¿ç‡, @ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, @ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = {}, 1/64, 0/64, 3/8, 3/8

	update: (_dt)=>
	_update_randomwalk: (dt)=>
		isblocked = (x, y)-> Scene.current.bg.data[y+1][x+1] >= 0x2c or (x==g_player.x and y==g_player.y) or lume.any(Scene.current.charactors, (c)-> c != @ and x == (c.tween?.target.x or c.x) and y == (c.tween?.target.y or c.y))
		isintown = (x, y)-> pos_in_box({x, y}, {8,8,#Scene.current.bg.data[1]-16,#Scene.current.bg.data-16})
		while true
			_, dt = coroutine.yield() for _i=1,112 -- åˆã‚ã›ã¦120Framesã§ç§»å‹•ã™ã‚‹
			{x2, y2} = if issubclass(Scene.current.__class, Field) then lume.randomchoice([{@x+dx, @y+dy} for {dx, dy} in *{{-1,0},{0,-1},{1,0},{0,1},{0,0}} when isintown(@x+dx, @y+dy) and not isblocked(@x+dx, @y+dy)]) else {@x, @y}
			@tween = tween.new(8/60, @, {x: x2, y: y2})
			while not @tween\update(dt)
				_, dt = coroutine.yield()
			@tween = nil
	-- talk: =>

export LevelUps = {
	{çµŒé¨“å€¤: 0, ã¡ã‹ã‚‰: 4, ç´ æ—©ã•: 4, maxhp: 15, maxmp: 0}
	{çµŒé¨“å€¤: 7, ã¡ã‹ã‚‰: 5, ç´ æ—©ã•: 4, maxhp: 22, maxmp: 0}
	{çµŒé¨“å€¤: 23, ã¡ã‹ã‚‰: 7, ç´ æ—©ã•: 6, maxhp: 24, maxmp: 5, å‘ªæ–‡: 'ãƒ›ã‚¤ãƒŸ'}
	{çµŒé¨“å€¤: 47, ã¡ã‹ã‚‰: 7, ç´ æ—©ã•: 8, maxhp: 31, maxmp: 16, å‘ªæ–‡: 'ã‚®ãƒ©'}
	{çµŒé¨“å€¤: 110, ã¡ã‹ã‚‰: 12, ç´ æ—©ã•: 10, maxhp: 35, maxmp: 20}
	{çµŒé¨“å€¤: 220, ã¡ã‹ã‚‰: 16, ç´ æ—©ã•: 10, maxhp: 38, maxmp: 24}
	{çµŒé¨“å€¤: 450, ã¡ã‹ã‚‰: 18, ç´ æ—©ã•: 17, maxhp: 40, maxmp: 26, å‘ªæ–‡: 'ãƒ©ãƒªãƒ›ãƒ¼'}
	{çµŒé¨“å€¤: 800, ã¡ã‹ã‚‰: 22, ç´ æ—©ã•: 20, maxhp: 46, maxmp: 29}
	{çµŒé¨“å€¤: 1300, ã¡ã‹ã‚‰: 30, ç´ æ—©ã•: 22, maxhp: 50, maxmp: 36, å‘ªæ–‡: 'ãƒ¬ãƒŸãƒ¼ãƒ©'}
	{çµŒé¨“å€¤: 2000, ã¡ã‹ã‚‰: 35, ç´ æ—©ã•: 31, maxhp: 54, maxmp: 40, å‘ªæ–‡: 'ãƒãƒ›ãƒˆãƒ¼ãƒ³'}
	{çµŒé¨“å€¤: 2900, ã¡ã‹ã‚‰: 40, ç´ æ—©ã•: 35, maxhp: 62, maxmp: 50}
	{çµŒé¨“å€¤: 4000, ã¡ã‹ã‚‰: 48, ç´ æ—©ã•: 40, maxhp: 63, maxmp: 58, å‘ªæ–‡: 'ãƒªãƒ¬ãƒŸãƒˆ'}
	{çµŒé¨“å€¤: 5500, ã¡ã‹ã‚‰: 52, ç´ æ—©ã•: 48, maxhp: 70, maxmp: 64, å‘ªæ–‡: 'ãƒ«ãƒ¼ãƒ©'}
	{çµŒé¨“å€¤: 7500, ã¡ã‹ã‚‰: 60, ç´ æ—©ã•: 55, maxhp: 78, maxmp: 70}
	{çµŒé¨“å€¤: 10000, ã¡ã‹ã‚‰: 68, ç´ æ—©ã•: 64, maxhp: 86, maxmp: 72, å‘ªæ–‡: 'ãƒˆãƒ˜ãƒ­ã‚¹'}
	{çµŒé¨“å€¤: 13000, ã¡ã‹ã‚‰: 72, ç´ æ—©ã•: 70, maxhp: 92, maxmp: 95}
	{çµŒé¨“å€¤: 17000, ã¡ã‹ã‚‰: 72, ç´ æ—©ã•: 78, maxhp: 100, maxmp: 100, å‘ªæ–‡: 'ãƒ™ãƒ›ã‚¤ãƒŸ'}
	{çµŒé¨“å€¤: 21000, ã¡ã‹ã‚‰: 85, ç´ æ—©ã•: 84, maxhp: 115, maxmp: 108}
	{çµŒé¨“å€¤: 25000, ã¡ã‹ã‚‰: 87, ç´ æ—©ã•: 86, maxhp: 130, maxmp: 115, å‘ªæ–‡: 'ãƒ™ã‚®ãƒ©ãƒ'}
	{çµŒé¨“å€¤: 29000, ã¡ã‹ã‚‰: 92, ç´ æ—©ã•: 88, maxhp: 138, maxmp: 128}
	{çµŒé¨“å€¤: 33000, ã¡ã‹ã‚‰: 95, ç´ æ—©ã•: 90, maxhp: 149, maxmp: 135}
	{çµŒé¨“å€¤: 37000, ã¡ã‹ã‚‰: 97, ç´ æ—©ã•: 90, maxhp: 158, maxmp: 146}
	{çµŒé¨“å€¤: 41000, ã¡ã‹ã‚‰: 99, ç´ æ—©ã•: 94, maxhp: 165, maxmp: 153}
	{çµŒé¨“å€¤: 45000, ã¡ã‹ã‚‰: 103, ç´ æ—©ã•: 98, maxhp: 170, maxmp: 161}
	{çµŒé¨“å€¤: 49000, ã¡ã‹ã‚‰: 113, ç´ æ—©ã•: 100, maxhp: 174, maxmp: 161}
	{çµŒé¨“å€¤: 53000, ã¡ã‹ã‚‰: 117, ç´ æ—©ã•: 105, maxhp: 180, maxmp: 168}
	{çµŒé¨“å€¤: 57000, ã¡ã‹ã‚‰: 125, ç´ æ—©ã•: 107, maxhp: 189, maxmp: 175}
	{çµŒé¨“å€¤: 61000, ã¡ã‹ã‚‰: 130, ç´ æ—©ã•: 115, maxhp: 195, maxmp: 180}
	{çµŒé¨“å€¤: 65000, ã¡ã‹ã‚‰: 135, ç´ æ—©ã•: 120, maxhp: 200, maxmp: 190}
	{çµŒé¨“å€¤: 65535, ã¡ã‹ã‚‰: 140, ç´ æ—©ã•: 130, maxhp: 210, maxmp: 200} }

æ­¦å™¨ä¸€è¦§ = {
	ãŸã‘ã–ãŠ: 2 -- æ”»æ’ƒåŠ›
	ã“ã‚“ã¼ã†: 4
	ã©ã†ã®ã¤ã‚‹ã:10
	ã¦ã¤ã®ãŠã®: 15
	ã¯ãŒã­ã®ã¤ã‚‹ã: 20
	ã»ã®ãŠã®ã¤ã‚‹ã: 28
	ãƒ­ãƒˆã®ã¤ã‚‹ã: 40 }

é§ä¸€è¦§ = {
	ã¬ã®ã®ãµã: 2
	ã‹ã‚ã®ãµã: 4
	ãã•ã‚Šã‹ãŸã³ã‚‰: 10
	ã¦ã¤ã®ã‚ˆã‚ã„: 16
	ã¯ãŒã­ã®ã‚ˆã‚ã„: 24
	ã¾ã»ã†ã®ã‚ˆã‚ã„: 24
	ãƒ­ãƒˆã®ã‚ˆã‚ã„: 28
}

ç›¾ä¸€è¦§ = {
	ã‹ã‚ã®ãŸã¦: 4
	ã¦ã¤ã®ãŸã¦: 10
	ã¿ã‹ãŒã¿ã®ãŸã¦: 20
}

å‘ªæ–‡ä¸€è¦§ = {
	ãƒ›ã‚¤ãƒŸ: {mp: 3, lv: 3,  gen_messages: (subject, _, level--[[ = 'ãƒ›ã‚¤ãƒŸ']])-> ->
		â£ = if subject == g_player then '' else 'ã€€'
		coroutine.yield 1, L('%s%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(â£, subject.name, level)
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		n = math.min(rawget({ãƒ›ã‚¤ãƒŸ: (-> math.random(10, 17)), ãƒ™ãƒ›ã‚¤ãƒŸ: (-> math.random(85, 100))}, level)(), subject.maxhp - subject.hp)
		subject.mp -= å‘ªæ–‡ä¸€è¦§[level].mp
		subject.hp += n
		coroutine.yield 1, L('\n%s%sã¯ï¼¨ï¼°ãŒ%sã‹ã„ãµãã—ãŸï¼ğŸ”»')\format(â£, subject.name, toZenkaku(n))
		nil
	}
	ã‚®ãƒ©: {mp: 2, lv: 4, gen_messages: (subject, other, level--[[ = 'ã‚®ãƒ©']])-> -> --æ•µ 16ï½20ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆæ•µã®ä½¿ç”¨æ™‚ã¯8ï½12ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰
		â£ = if subject == g_player then '' else 'ã€€'
		if level == 'ã‚®ãƒ©' or level == 'ãƒ™ã‚®ãƒ©ãƒ'
			coroutine.yield 1, L('%s%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(â£, subject.name, level)
			play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		else
			coroutine.yield 1, L('%s%sã¯ã€€%sã‚’ã¯ã„ãŸï¼')\format(â£, subject.name, level)
			play_wait'assets/supermario/ã‚¯ãƒƒãƒ‘ã®ç‚.ogg'
		n = rawget({ã‚®ãƒ©: (-> math.random(5, 12)), ãƒ™ã‚®ãƒ©ãƒ: (-> math.random(58, 65)), ã»ã®ãŠ: (-> math.random(16, 23)), ã‹ãˆã‚“ã®ã„ã¶ã: (-> math.random(65, 70))}, level)()
		if other.é§ and other.é§ == 'ãƒ­ãƒˆã®ã‚ˆã‚ã„' or other.é§ and other.é§ == 'ã¾ã»ã†ã®ã‚ˆã‚ã„' then n = math.floor(n*2/3)
		subject.mp -= å‘ªæ–‡ä¸€è¦§[level].mp
		if math.random() < other.ã‚®ãƒ©ç³»å›é¿ç‡
			if subject == g_player then coroutine.yield 1, L('\nãƒŸã‚¹ï¼\n%sã«ã€€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚ãŸãˆã‚‰ã‚Œãªã„ï¼')\format(other.name)
			else coroutine.yield 1, L('\nãƒŸã‚¹ï¼\n%s%sã¯ã€€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãªã„ï¼')\format(â£, other.name)
		else
			other.hp -= n
			if subject == g_player then coroutine.yield 1, L('\n%sã«ã€€%sãƒã‚¤ãƒ³ãƒˆã®\nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚ãŸãˆãŸï¼')\format(other.name, toZenkaku(n))
			else coroutine.yield 1, L('\n%s%sã¯ã€€%sãƒã‚¤ãƒ³ãƒˆã®\n%sãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼')\format(â£, other.name, toZenkaku(n), â£)
		nil
	}
	ãƒ©ãƒªãƒ›ãƒ¼: {mp: 2, lv: 7, gen_messages: (subject, other)-> ->
		â£ = if subject == g_player then '' else 'ã€€'
		coroutine.yield 1, L('%s%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(â£, subject.name, 'ãƒ©ãƒªãƒ›ãƒ¼')
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		if math.random() < other.ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡
			coroutine.yield 1, L('\n%s%sã«ã¯ã€€ãã‹ãªã‹ã£ãŸï¼')\format(â£, other.name)
		else
			other.flags[] = L'çœ ã‚Š'
			if subject == g_player then coroutine.yield 1, L('\n%sã‚’ã€€ã­ã‚€ã‚‰ã›ãŸï¼')\format(other.name)
			else coroutine.yield 1, L('\nã€€%sã¯ã€€ã­ã‚€ã£ã¦ã—ã¾ã£ãŸï¼')\format(other.name)
		nil
	}
	ãƒ¬ãƒŸãƒ¼ãƒ©: {mp: 2, lv: 9, gen_messages: (subject)-> -> -- ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†…ã‚’ä¸€å®šæ™‚é–“æ˜ã‚‹ãã™ã‚‹
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(subject.name, L'ãƒ¬ãƒŸãƒ¼ãƒ©')
		subject.mp -= 2
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		g_player.ãƒ¬ãƒŸãƒ¼ãƒ©count = 128
		nil
	}
	ãƒãƒ›ãƒˆãƒ¼ãƒ³: {mp: 2, lv: 10, gen_messages: (subject, other)-> -> -- å‘ªæ–‡ã‚’å°ã˜ã‚‹
		â£ = if subject == g_player then '' else 'ã€€'
		coroutine.yield 1, L('%s%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(â£, subject.name, L'ãƒãƒ›ãƒˆãƒ¼ãƒ³')
		subject.mp -= 2
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		if math.random() < other.ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ or (other.é§ and other.é§ == L'ãƒ­ãƒˆã®ã‚ˆã‚ã„')
			coroutine.yield 1, L('\n%s%sã«ã¯ã€€ãã‹ãªã‹ã£ãŸï¼')\format(â£, other.name)
		else
			other.flags[] = L'å‘ªæ–‡å°ã˜'
			if subject == g_player then coroutine.yield 1, L('\n%sã®ã€€ã˜ã‚…ã‚‚ã‚“ã‚’ãµã†ã˜ãŸï¼')\format(other.name)
			else coroutine.yield 1, L('\nã€€%sã¯ã€€ã˜ã‚…ã‚‚ã‚“ã‚’ãµã†ã˜ã‚‰ã‚ŒãŸï¼')\format(other.name)
		nil
	}
	ãƒªãƒ¬ãƒŸãƒˆ: {mp: 6, lv: 12, gen_messages: (subject)-> -> -- ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‹ã‚‰è„±å‡º
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(subject.name, L'ãƒªãƒ¬ãƒŸãƒˆ')
		subject.mp -= 6
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		Scene.current\detach()
		Scene.current.ãƒªãƒ¬ãƒŸãƒˆ()
		nil
	}
	ãƒ«ãƒ¼ãƒ©: {mp: 8, lv: 13, gen_messages: (subject)-> -> --ãƒ©ãƒ€ãƒˆãƒ¼ãƒ ã®åŸã¸æˆ»ã‚‹ï¼ˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†…ã§ã¯ç„¡åŠ¹ï¼‰
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(subject.name, L'ãƒ«ãƒ¼ãƒ©')
		subject.mp -= 8
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		Scene.current\detach()
		Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_fromãƒ«ãƒ¼ãƒ©()
		nil
	}
	ãƒˆãƒ˜ãƒ­ã‚¹: {mp: 2, lv: 15 , gen_messages: (subject)-> -> -- è‡ªåˆ†ã‚ˆã‚Šå¼±ã„æ•µã®å‡ºç¾ç‡ä½ä¸‹ï¼ˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†…ã§ã¯ç„¡åŠ¹ï¼‰
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¨ãªãˆãŸï¼')\format(subject.name, L'ãƒˆãƒ˜ãƒ­ã‚¹')
		subject.mp -= 2
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		g_player.ãƒˆãƒ˜ãƒ­ã‚¹count = 128
		nil
	}
	ãƒ™ãƒ›ã‚¤ãƒŸ: {mp: 8, lv: 17} 	--è‡ªåˆ† 	HPã‚’85ï½100å›å¾©
	ãƒ™ã‚®ãƒ©ãƒ: {mp: 5, lv: 19} 	--æ•µ 	50ï½65ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆæ•µã®ä½¿ç”¨æ™‚ã¯ç´„40ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰
	ã»ã®ãŠ: {mp: 0}
	ã‹ãˆã‚“ã®ã„ã¶ã: {mp: 0}
}
å‘ªæ–‡ä¸€è¦§.ãƒ™ãƒ›ã‚¤ãƒŸ.gen_messages = (subject, _)-> å‘ªæ–‡ä¸€è¦§.ãƒ›ã‚¤ãƒŸ.gen_messages(subject, _, L'ãƒ™ãƒ›ã‚¤ãƒŸ')
å‘ªæ–‡ä¸€è¦§.ãƒ™ã‚®ãƒ©ãƒ.gen_messages = (subject, other)-> å‘ªæ–‡ä¸€è¦§.ã‚®ãƒ©.gen_messages(subject, other, L'ãƒ™ã‚®ãƒ©ãƒ')
å‘ªæ–‡ä¸€è¦§.ã»ã®ãŠ.gen_messages = (subject, other)-> å‘ªæ–‡ä¸€è¦§.ã‚®ãƒ©.gen_messages(subject, other, L'ã»ã®ãŠ')
å‘ªæ–‡ä¸€è¦§.ã‹ãˆã‚“ã®ã„ã¶ã.gen_messages = (subject, other)-> å‘ªæ–‡ä¸€è¦§.ã‚®ãƒ©.gen_messages(subject, other, L'ã‹ãˆã‚“ã®ã„ã¶ã')

é“å…·ä¸€è¦§ = {
	ã‚„ããã†: { gen_messages: -> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¤ã‹ã£ãŸï¼ğŸ”»')\format(g_player.name, L'ã‚„ããã†')
		lume.remove(g_player.items, L'ã‚„ããã†')
		n = math.min(23 + math.random(0, 7), g_player.maxhp - g_player.hp)
		g_player.hp += n
		coroutine.yield 1, L('\n%sã¯ï¼¨ï¼°ãŒ%sã‹ã„ãµãã—ãŸï¼ğŸ”»')\format(g_player.name, toZenkaku(n))
		nil
	}
	ã‹ã: { gen_messages: -> ->
		coroutine.yield 1, L'ã“ã“ã«ã¯ã€€ã¨ã³ã‚‰ãŒãªã„ã€‚ğŸ”»'
		nil
	}
	ãŸã„ã¾ã¤: { gen_messages: => ->
		coroutine.yield 1, L('%sã¯ã€€ãŸã„ã¾ã¤ã‚’ã¨ã‚‚ã—ãŸï¼ğŸ”»')\format(g_player.name)
		lume.remove(g_player.items, L'ãŸã„ã¾ã¤')
		g_player.ãŸã„ã¾ã¤ = true
		nil
	}
	ã›ã„ã™ã„: { gen_messages: -> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã‹ã‚‰ã ã«ãµã‚Šã¾ã„ãŸï¼')\format(g_player.name, L'ã›ã„ã™ã„')
		lume.remove(g_player.items, L'ã›ã„ã™ã„')
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		g_player.ã›ã„ã™ã„count = 127
		nil
	}
	ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•: { gen_messages: -> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¤ã‹ã£ãŸï¼')\format(g_player.name, L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•')
		play_wait'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
		Scene.current\detach()
		Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_fromãƒ«ãƒ¼ãƒ©()
		nil
	}
	ã‚Šã‚…ã†ã®ã†ã‚ã“: { -- å®ˆå‚™åŠ›ã£ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒãªã„
	}
	ã›ã‚“ã—ã®ã‚†ã³ã‚: { -- ãªã‚‰ã“ã‚Œã¯æ”»æ’ƒåŠ›ï¼Ÿ
	}
	ã‚ˆã†ã›ã„ã®ãµãˆ: {gen_messages: (subject, other)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ãµã„ãŸï¼')\format(subject.name, L'ã‚ˆã†ã›ã„ã®ãµãˆ')
		BGM()
		play_wait'assets/sounds/mml2ogg/ã‚ˆã†ã›ã„ã®ãµãˆ.ogg'
		BGM({'assets/sounds/mml2ogg/battle.ogg'})
		if math.random() < 1/16 or other.name != L'ã‚´ãƒ¼ãƒ¬ãƒ '
			coroutine.yield 1, L('\n%sã«ã¯ã€€ãã‹ãªã‹ã£ãŸï¼')\format(other.name)
		else
			other.flags[] = L'çœ ã‚Š'
			coroutine.yield 1, L('\n%sã¯ã€€ã—ãšã‹ã«ã€€ã‚ã‚’ã¨ã˜ã‚‹â€¦')\format(other.name)
			coroutine.yield 1, L('\n%sã‚’ã€€ã­ã‚€ã‚‰ã›ãŸï¼')\format(other.name)
		nil
	}
	ã®ã‚ã„ã®ãƒ™ãƒ«ãƒˆ: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¿ã«ã¤ã‘ãŸï¼')\format(subject.name, L'ã®ã‚ã„ã®ãƒ™ãƒ«ãƒˆ')
		coroutine.yield 1, L('\n%sã¯ã€€ã®ã‚ã‚ã‚Œã¦ã—ã¾ã£ãŸï¼ğŸ”»')\format(subject.name)
		g_player.flags[] = L'å‘ªã„'
		lume.remove(g_player.items, L'ã®ã‚ã„ã®ãƒ™ãƒ«ãƒˆ') -- ã¤ã‹ã†ã¨é“å…·ç®±ã‹ã‚‰æ¶ˆãˆã‚‹ã“ã¨ã«ã™ã‚‹
		nil
	}
	ã—ã®ãã³ã‹ã–ã‚Š: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¿ã«ã¤ã‘ãŸï¼')\format(subject.name, L'ã—ã®ãã³ã‹ã–ã‚Š')
		coroutine.yield 1, L('\n%sã¯ã€€ã®ã‚ã‚ã‚Œã¦ã—ã¾ã£ãŸï¼ğŸ”»')\format(subject.name)
		g_player.flags[] = L'å‘ªã„'
		lume.remove(g_player.items, L'ã—ã®ãã³ã‹ã–ã‚Š') -- ã¤ã‹ã†ã¨é“å…·ç®±ã‹ã‚‰æ¶ˆãˆã‚‹ã“ã¨ã«ã™ã‚‹
		nil
	}
	ãã‚“ã®ãŸã¦ã”ã¨: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã€€ã‹ãªã§ãŸï¼')\format(subject.name, L'ãã‚“ã®ãŸã¦ã”ã¨')
		BGM()
		play_wait'assets/sounds/mml2ogg/ãã‚“ã®ãŸã¦ã”ã¨.ogg'
		BGM Scene.current.parent.__class.BGM
		if not Scene.current.parent.ãã‚“ã®ãŸã¦ã”ã¨
			coroutine.yield 1, L'\nã—ã‹ã—ã€ãªã«ã‚‚ã€€ãŠããªã‹ã£ãŸï¼ğŸ”»'
		else
			Scene.current.detach = =>
				MessageBoxRetro.__base.detach(Scene.current) -- super()
				Scene.current\ãã‚“ã®ãŸã¦ã”ã¨()
		nil
	}
	ãŠã†ã˜ã‚‡ã®ã‚ã„: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L'ãƒ­ãƒ¼ãƒ©ã²ã‚ã®ã€€ã“ãˆãŒã€€ãã“ãˆã‚‹ã€‚ğŸ”»'
		if LevelUps[g_player.level+1]
			coroutine.yield 1, L('\nãƒ­ãƒ¼ãƒ©ã€Œã‚ãŸãªãŒã€€ãƒ¬ãƒ™ãƒ«ã‚’ã‚ã’ã‚‹ã«ã¯\nã€€ã€€ã€€ã€€ã‚ã¨%sãƒã‚¤ãƒ³ãƒˆ\nã€€ã€€ã€€ã€€ã‘ã„ã‘ã‚“ã¡ãŒã€€ã²ã¤ã‚ˆã†ã§ã™ã€‚ğŸ”»')\format(toZenkaku(LevelUps[g_player.level+1].çµŒé¨“å€¤ - g_player.çµŒé¨“å€¤))
		if Scene.current.parent.__class == Field
			dx, dy =  g_player.x - 54, g_player.y - 49
			coroutine.yield 1, L('\nãƒ­ãƒ¼ãƒ©ã€Œã‚ãŸã—ã®ã„ã‚‹ã€€ãŠã—ã‚ã¯\nã€€ã€€ã€€ã€€%sã«%sã€€%sã«%s\nã€€ã€€ã€€ã€€ã®ã€€ã»ã†ã“ã†ã€€ã§ã™ã€‚ğŸ”»')\format((if dy < 0 then 'ã¿ãªã¿' else 'ããŸ'), toZenkaku(math.abs(dy)), (if dx < 0 then 'ã²ãŒã—' else 'ã«ã—'), toZenkaku(math.abs(dx)), )
		coroutine.yield 1, L('\nãƒ­ãƒ¼ãƒ©ã€Œ%sã•ã¾ã‚’ã€€ãƒ­ãƒ¼ãƒ©ã¯\nã€€ã€€ã€€ã€€ãŠã—ãŸã„ã€€ã‚‚ã†ã—ã¦ãŠã‚Šã¾ã™ã€‚ğŸ”»')\format(g_player.name)
		nil
	}
	ãƒ­ãƒˆã®ã—ã‚‹ã—: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã«ãã‚Šã—ã‚ãŸã€‚ğŸ”»')\format(subject.name, L'ãƒ­ãƒˆã®ã—ã‚‹ã—')
		coroutine.yield 1, L'\nã—ã‹ã—ã€ãªã«ã‚‚ã€€ãŠããªã‹ã£ãŸï¼ğŸ”»'
		nil
	}
	ãŸã„ã‚ˆã†ã®ã„ã—: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¦ã‚“ã«ã‹ã–ã—ãŸã€‚ğŸ”»')\format(subject.name, L'ãŸã„ã‚ˆã†ã®ã„ã—')
		coroutine.yield 1, L'\nã—ã‹ã—ã€ãªã«ã‚‚ã€€ãŠããªã‹ã£ãŸï¼ğŸ”»'
		nil
	}
	ã‚ã¾ãã‚‚ã®ã¤ãˆ: { gen_messages: (subject, _)-> ->
		coroutine.yield 1, L('%sã¯ã€€%sã‚’ã¦ã‚“ã«ã‹ã–ã—ãŸã€‚ğŸ”»')\format(subject.name, L'ã‚ã¾ãã‚‚ã®ã¤ãˆ')
		coroutine.yield 1, L'\nã—ã‹ã—ã€ãªã«ã‚‚ã€€ãŠããªã‹ã£ãŸï¼ğŸ”»'
		nil
	}
	ã«ã˜ã®ã—ãšã: { gen_messages: (subject, _)-> ->
		if g_player.x == 77 and g_player.y == 56
			coroutine.yield 1, L('%sã¯ã€€ã«ã˜ã®ã—ãšãã‚’ã€€ã¦ã‚“ã«ã‹ã–ã—ãŸã€‚ğŸ”»')\format(subject.name)
			g_player.flags[] = L'ã«ã˜ã®ã—ãšãã‚’ã¤ã‹ã£ãŸ'
			lume.remove(g_player.items, L'ã«ã˜ã®ã—ãšã')
			BGM()
			s = play'assets/sounds/mml2ogg/ã«ã˜ã®ã—ãšã.ogg'
			hue = love.timer.getTime()
			Scene.current.overlapping_color = {1,1,1,0.6}
			while s\isPlaying()
				Scene.current.overlapping_color = {hsv (love.timer.getTime() - hue)*3.2 % 6 , 1, 1, lume.smooth(0, 0.6, 1 - s\tell() / s\getDuration())}
				coroutine.yield 1
			Scene.current.overlapping_color = {0,0,0,0}
			BGM'assets/sounds/mml2ogg/overworld.ogg'
			Scene.current.parent.bg.data[57][77] = 0x29
			Scene.current.parent.bg\set(Scene.current.parent.bg.data)
		else
			coroutine.yield 1, L'ã“ã“ã§ã¯ã€€ã¤ã‹ãˆãªã„ã€‚ğŸ”»'
		nil
	}
}


export å®¿å±‹ = class å®¿å±‹ extends Charactor
	new: (x, y, @fee)=> super(x, y, {0x3e, 0x3f})
	talk: => @@.MessageBox(@fee)\attach()

class å®¿å±‹.MessageBox extends MessageBoxRetro
	new: (price)=>
		sb = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
		super({ <index>: coroutine.wrap((_, _)-> -- selfã¨nã ã‘ã©selfã‚’è¦†ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹
			coroutine.yield 1, L('ï¼Šã€ŒãŸã³ã³ã¨ã®ã€€ã‚„ã©ã‚„ã¸ã€€ã‚ˆã†ã“ãã€‚\nã€€ã€€ã²ã¨ã°ã‚“ã€€%sï¼§ã§ã™ãŒ\nã€€ã€€ãŠã¨ã¾ã‚Šã«ã€€ãªã‚Šã¾ã™ã‹ï¼Ÿ')\format(toZenkaku(price))
			coroutine.yield 1, sb\attach()
			if sb.index == 1
				if g_player.gold >= price
					coroutine.yield 1, L'\nï¼Šã€Œã§ã¯ã€€ãŠã‚„ã™ã¿ãªã•ã„ã¾ã›ã€‚'
					g_player.gold -= price
					@update = coroutine.wrap(@_update) -- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªã‚¢
					BGM()
					s = play $mml2ogg([[ Tempo(114) @8 q100 o5 l8 '>d<f+' '>c+<f' '>c<e' 'bd' 'ac',50 'd<f+>',50 '>d<f+'4 ]])
					@overlapping_color = {0,0,0,1}
					while s\isPlaying()
						@overlapping_color[4] = lume.smooth(0, 1, 1 - s\tell() / s\getDuration())
						coroutine.yield 1
					@overlapping_color = {0,0,0,0}
					BGM'assets/sounds/mml2ogg/town.ogg'
					if not lume.find(g_player.flags, L'ãƒ­ãƒ¼ãƒ©å§«ã‚’æ•‘å‡ºã—ãŸ')
						coroutine.yield 1, L'ï¼Šã€ŒãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚\nã€€ã€€ã‚†ã†ã¹ã¯ã€€ã‚ˆãã€€ãŠã‚„ã™ã¿\nã€€ã€€ã§ã—ãŸã­ã€‚ğŸ”»'
					else
						coroutine.yield 1, L'ï¼Šã€ŒãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚\nã€€ã€€ã‚†ã†ã¹ã¯ã€€ãŠãŸã®ã—ã¿ã€€ã§ã—ãŸã­ã€‚ğŸ”»'
					coroutine.yield 1, L'\nï¼Šã€Œã§ã¯ã€€ã¾ãŸã€€ã©ã†ãã€‚ğŸ”»'
				else coroutine.yield 1, L'\nï¼Šã€Œã™ã¿ã¾ã›ã‚“ã€€ãŠã‹ã­ãŒ\nã€€ã€€ãŸã‚Šãªã„ã‚ˆã†ã§ã™ã€‚'
			else coroutine.yield 1, L'\nï¼Šã€Œã•ã‚ˆã†ãªã‚‰ã€€ãŸã³ã®ã²ã¨ã€‚ã‚ã¾ã‚Š\nã€€ã€€ã‚€ã‚Šã‚’ã€€ãªã•ã„ã¾ã›ã¬ã‚ˆã†ã«ã€‚ğŸ”»'
			nil
		)})
	draw: =>
		super()
		@draw_gold()

export æ­¦å™¨å±‹ = class æ­¦å™¨å±‹ extends Charactor
	new: (x, y, @goods)=> super(x, y, {0x3e, 0x3f})
	talk: => @@.MessageBox(@goods)\attach()

class æ­¦å™¨å±‹.MessageBox extends MessageBoxRetro
	new: (goods)=> -- {{L'ãŸã‘ã–ãŠ', 10}, {L'ã“ã‚“ã¼ã†', 60}, {L'ã©ã†ã®ã¤ã‚‹ã', 180}, {L'ã¬ã®ã®ãµã', 20}, {L'ã‹ã‚ã®ãµã', 70}, {L'ã‹ã‚ã®ãŸã¦', 90} }
		super({ <index>: coroutine.wrap((_, _)->
			sb1 = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
			sb2 = SelectBoxRetro([name..'ã€€'\rep(7-utf8.len(name))..'ã€€'\rep(5-#tostring(price))..toZenkaku(price) for {name, price} in *goods]) -- bdf1.getWidthã‚’ä½¿ã†ã¨æ¿ç‚¹ã®åˆ†é›¢ã«å¯¾å¿œã§ãã‚‹ãŒbdf1ãŒæ¥ã¦ãªã„
			coroutine.yield 1, L'ï¼Šã€Œã“ã“ã¯ã€€ã¶ãã¨ã‚ˆã‚ã„ã®ã€€ã¿ã›ã ã€‚\nã€€ã€€ãªã«ã‹ã€€ã‹ã†ã‹ã­ï¼Ÿ'
			while true
				sb1.index = 1
				coroutine.yield 1, sb1\attach()
				if sb1.index == 1
					coroutine.yield 1, L'\nï¼Šã€Œãªã«ã‚’ã€€ã‹ã†ã‹ã­ï¼Ÿ'
					sb2.index = 1
					coroutine.yield 1, sb2\attach()
					if sb2.index >= 1
						coroutine.yield 1, L('\nï¼Šã€Œ%sã ã­ã€‚')\format(toZenkaku(goods[sb2.index][1]))
						sb1.index = 1
						coroutine.yield 1, sb1\attach()
						if sb1.index == 1
							if g_player.gold >= goods[sb2.index][2]
								coroutine.yield 1, L'\nï¼Šã€Œã©ã†ã‚‚ã‚ã‚ŠãŒã¨ã†ã€‚'
								item = goods[sb2.index][1]
								if item in lume.keys(æ­¦å™¨ä¸€è¦§)
									if g_player.æ­¦å™¨ then g_player.items[] = g_player.æ­¦å™¨
									g_player.æ­¦å™¨ = item
								elseif item in lume.keys(é§ä¸€è¦§)
									if g_player.é§ then g_player.items[] = g_player.é§
									g_player.é§ = item
								elseif item in lume.keys(ç›¾ä¸€è¦§)
									if g_player.ç›¾ then g_player.items[] = g_player.ç›¾
									g_player.ç›¾ = item
								g_player.gold -= goods[sb2.index][2]
								n = (if g_player.æ­¦å™¨ then 1 else 0) + (if g_player.ç›¾ then 2 else 0) -- å‹‡è€…ã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆå¤‰æ›´
								g_player.chipids = {0x20+n*2, 0x20+n*2+1}
							else coroutine.yield 1, L'\nï¼Šã€Œã™ã¾ãªã„ãŒã€€ãŠã‹ã­ãŒ\nã€€ã€€ãŸã‚Šãªã„ã‚ˆã†ã ã€‚'
					coroutine.yield 1, L'\nï¼Šã€Œã»ã‹ã«ã€€ãªã«ã‹ã€€ã‹ã†ã‹ã­ï¼Ÿ'
				else break
			coroutine.yield 1, L'\nï¼Šã€Œã¾ãŸãã¦ãã‚Œã‚ˆãªã€‚ğŸ”»'
			nil
		)})
	draw: =>
		super()
		@draw_gold()

export é“å…·å±‹ = class é“å…·å±‹ extends Charactor
	new: (x, y, @goods)=> super(x, y, {0x3e, 0x3f}) -- å•†äºº
	talk: => @@.MessageBox(@goods)\attach()

class é“å…·å±‹.MessageBox extends MessageBoxRetro
	@å£²å€¤: {ã‚„ããã†: 12, ã‹ã: 26, ãŸã„ã¾ã¤: 4, ã›ã„ã™ã„: 19, ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•: 35, ã‚Šã‚…ã†ã®ã†ã‚ã“: 10, ã›ã‚“ã—ã®ã‚†ã³ã‚: 15, ã®ã‚ã„ã®ãƒ™ãƒ«ãƒˆ: 180, ã—ã®ãã³ã‹ã–ã‚Š: 1200
		ãŸã‘ã–ãŠ: 10, ã“ã‚“ã¼ã†: 30, ã©ã†ã®ã¤ã‚‹ã: 90, ã¦ã¤ã®ãŠã®: 280, ã¯ãŒã­ã®ã¤ã‚‹ã: 750, ã»ã®ãŠã®ã¤ã‚‹ã: 4900, ãƒ­ãƒˆã®ã¤ã‚‹ã: 1
		ã¬ã®ã®ãµã: 10, ã‹ã‚ã®ãµã: 35, ãã•ã‚Šã‹ãŸã³ã‚‰: 150, ã¦ã¤ã®ã‚ˆã‚ã„: 500, ã¯ãŒã­ã®ã‚ˆã‚ã„: 1500, ã¾ã»ã†ã®ã‚ˆã‚ã„: 3850, ãƒ­ãƒˆã®ã‚ˆã‚ã„: 1
		ã‹ã‚ã®ãŸã¦: 45, ã¦ã¤ã®ãŸã¦: 800, ã¿ã‹ãŒã¿ã®ãŸã¦: 7400}
	new: (goods)=>
		super({ <index>: coroutine.wrap((_, _)->
			sb0 = SelectBoxRetro({L'ã‹ã„ã«ããŸ', L'ã†ã‚Šã«ããŸ'})
			sb1 = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
			sb2 = SelectBoxRetro([name..'ã€€'\rep(7-utf8.len(name))..'ã€€'\rep(5-#tostring(price))..toZenkaku(price) for {name, price} in *goods]) -- bdf1.getWidthã‚’ä½¿ã†ã¨æ¿ç‚¹ã®åˆ†é›¢ã«å¯¾å¿œã§ãã‚‹ãŒbdf1ãŒæ¥ã¦ãªã„
			coroutine.yield 1, L'ï¼Šã€Œã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚\nã€€ã€€ã“ã“ã¯ã€€ã©ã†ãã‚„ã€€ã§ã™ã€‚\nã€€ã€€ã©ã‚“ãªã€€ã”ã‚ˆã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ'
			coroutine.yield 1, sb0\attach()
			switch sb0.index
				when 1 -- ã‹ã„ã«ããŸ
					while true
						coroutine.yield 1, L'\nï¼Šã€Œã©ã‚Œã‚’ã€€ãŠã‚‚ã¨ã‚ã§ã™ã‹ï¼Ÿ'
						sb2.index = 1
						coroutine.yield 1, sb2\attach()
						if sb2.index >= 1
							coroutine.yield 1, L('\nï¼Šã€Œ%sã§ã™ã­ï¼Ÿ')\format(toZenkaku(goods[sb2.index][1]))
							sb1.index = 1
							coroutine.yield 1, sb1\attach()
							if sb1.index == 1
								if g_player.gold >= goods[sb2.index][2]
									coroutine.yield 1, L'\nï¼Šã€Œã¾ã„ã©ã€€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚'
									g_player.items[] = goods[sb2.index][1]
									g_player.gold -= goods[sb2.index][2]
								else coroutine.yield 1, L'\nï¼Šã€ãŠã‹ã­ãŒã€€ãŸã‚Šã¾ã›ã‚“ãŒã€‚'
						coroutine.yield 1, L'\nï¼Šã€Œã»ã‹ã«ã€€ãªã«ã‹ã€€ã‹ã‚ã‚Œã¾ã™ã‹ï¼Ÿ'
						sb1.index = 1
						coroutine.yield 1, sb1\attach()
						if sb1.index != 1 then break
				when 2 -- ã†ã‚Šã«ããŸ
					while true
						coroutine.yield 1, L'\nï¼Šã€Œã©ã‚Œã‚’ã€€ãŠã†ã‚Šã§ã—ã‚‡ã†ï¼Ÿ'
						items = [i for i in *g_player.items when lume.find(lume.keys(@@å£²å€¤), i)]
						sb3 = with SelectBoxRetro(lume.unique_(items), 12) -- è¤‡æ•°æŒã¡ã¯ã¾ã¨ã‚ã‚‹
							for b in *.buttons do b.text ..= 'ã€€'\rep(12-utf8.len(b.text)-#tostring(@@å£²å€¤[b.id]))..toZenkaku(@@å£²å€¤[b.id])
						coroutine.yield 1, sb3\attach()
						if sb3.index >= 1
							name = sb3.buttons[sb3.index].id
							coroutine.yield 1, L('\nã€€ã€€%sã§ã”ã–ã„ã¾ã™ã­ã€‚\nã€€ã€€ãã‚Œãªã‚‰ã€€%sã‚´ãƒ¼ãƒ«ãƒ‰ã§\nã€€ã€€ã‹ã„ã¾ã—ã‚‡ã†ã€‚ã„ã„ã§ã™ã‹ï¼Ÿ')\format(toZenkaku(name), toZenkaku(@@å£²å€¤[name]))
							sb1.index = 1
							coroutine.yield 1, sb1\attach()
							if sb1.index == 1
								lume.remove(g_player.items, name)
								g_player.gold += @@å£²å€¤[name]
						coroutine.yield 1, L'\nï¼Šã€Œã¾ã ã€€ãªã«ã‹ã€€ã†ã£ã¦ãã‚Œã¾ã™ã‹ï¼Ÿ'
						sb1.index = 1
						coroutine.yield 1, sb1\attach()
						if sb1.index != 1 then break
				-- else break
			coroutine.yield 1, L'\nï¼Šã€Œã§ã¯ã€€ã¾ãŸã®ã€€ãŠã“ã—ã‚’\nã€€ã€€ãŠã¾ã¡ã€€ã—ã¦ãŠã‚Šã¾ã™ã€‚ğŸ”»'
			nil
		)})
	draw: =>
		super()
		@draw_gold()

export ã‹ãå±‹ = class ã‹ãå±‹ extends Charactor
	new: (x, y, @price)=> super(x, y, {0x3a, 0x3b}) -- è€äºº
	talk: => @@.MessageBox(@price)\attach()

class ã‹ãå±‹.MessageBox extends MessageBoxRetro
	new: (price)=>
		sb1 = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
		super({ <index>: coroutine.wrap((_, _)->
			coroutine.yield 1, L('ï¼Šã€Œã©ã‚“ãªã¨ã³ã‚‰ã‚‚ã€€ã‚ã‘ã¦ã—ã¾ã†\nã€€ã€€ã¾ã»ã†ã®ã€€ã‹ãã¯ã€€ã„ã‚‰ã‚“ã‹ãªï¼Ÿ\nã€€ã€€ã²ã¨ã¤ã€€%sã‚´ãƒ¼ãƒ«ãƒ‰ã§ã©ã†ã˜ã‚ƒï¼Ÿ')\format(toZenkaku(price))
			coroutine.yield 1, sb1\attach()
			while sb1.index == 1
				if lume.count(g_player.items, L'ã‹ã') >= 6
					coroutine.yield 1, L'\nï¼Šã€Œã‚ã‚‹ã„ãŒã€€ã“ã‚Œã„ã˜ã‚‡ã†\nã€€ã€€ã†ã‚‹ã‚ã‘ã«ã¯ã€€ã„ã‹ã‚“ãªã€‚ğŸ”»'
					break
				elseif g_player.gold >= price
					g_player.gold -= price
					g_player.items[] = 'ã‹ã'
					coroutine.yield 1, L'\nï¼Šã€Œã»ã‚Œã€‚ã‹ãã‚’ã²ã¨ã¤ã€€ã‚ãŸãã†ã€‚\nï¼Šã€Œã¾ã ã€€ã‹ãã‚’ã€€ã‹ã†ã‹ãªï¼Ÿ'
					coroutine.yield 1, sb1\attach()
				else
					coroutine.yield 1, L'\nï¼Šã€ŒãŠã¾ãˆã•ã¾ã¯ã€€ãŠã‹ã­ãŒ\nã€€ã€€ãŸã‚‰ãªã„ã‚ˆã†ã˜ã‚ƒãªã€‚ğŸ”»'
					break
			coroutine.yield 1, L'\nï¼Šã€Œã§ã¯ã€€ã¾ãŸãªã€‚ğŸ”»'
			nil
		)})
	draw: =>
		super()
		@draw_gold()

export ã›ã„ã™ã„å±‹ = class ã›ã„ã™ã„å±‹ extends Charactor
	new: (x, y, @price)=> super(x, y, {0x3c, 0x3d}) -- å¥³æ€§
	talk: => @@.MessageBox(@price)\attach()

class ã›ã„ã™ã„å±‹.MessageBox extends MessageBoxRetro
	new: (price)=>
		sb1 = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
		super({ <index>: coroutine.wrap((_, _)->
			coroutine.yield 1, L('ï¼Šã€Œã¾ã‚‚ã®ã‚ˆã‘ã®ã€€ã›ã„ã™ã„ã¯\nã€€ã€€ã„ã‹ãŒã§ã—ã‚‡ã†ï¼Ÿ\nã€€ã€€ã²ã¨ã³ã‚“ã€€%sã‚´ãƒ¼ãƒ«ãƒ‰ã§ã™ãŒã€‚')\format(toZenkaku(price))
			coroutine.yield 1, sb1\attach()
			while sb1.index == 1
				if g_player.gold >= price
					g_player.gold -= price
					g_player.items[] = 'ã›ã„ã™ã„'
					coroutine.yield 1, L'\nï¼Šã€Œã‚ã‚ŠãŒã¨ã†ã”ã•ã„ã¾ã™ã€‚\nï¼Šã€Œã‚‚ã†ã²ã¨ã³ã‚“\nã€€ã€€ã‹ã‚ã‚Œã¾ã™ã‹ï¼Ÿ'
					coroutine.yield 1, sb1\attach()
				else
					coroutine.yield 1, L'\nï¼Šã€ŒãŠã‹ã­ãŒã€€ãŸã‚Šã¾ã›ã‚“ãŒã€‚ğŸ”»'
					break
			coroutine.yield 1, L'\nï¼Šã€Œã‚ãªãŸã«ã€€ã‹ã¿ã®ã€€ã”ã‹ã”ãŒ\nã€€ã€€ã‚ã‚Šã¾ã™ã‚ˆã†ã«ã€‚ğŸ”»'
			nil
		)})
	draw: =>
		super()
		@draw_gold()

export å®ç®± = class å®ç®± extends Charactor
	new: (x, y, @gold_or_item)=> super(x, y, {0x10})
	talk: =>
		lume.remove(Scene.current.charactors, @)
		play'assets/DQ1/å®ç®±.ogg'
		if type(@gold_or_item) == 'number'
			g_player.gold += @gold_or_item
			MessageBoxRetro({ L('%sã¯ã€€%sã‚´ãƒ¼ãƒ«ãƒ‰ã‚’\nã¦ã«ã„ã‚ŒãŸã€‚ğŸ”»')\format(g_player.name, toZenkaku(@gold_or_item)) })\attach()
		else
			MessageBoxRetro({ L('%sã¯ã€€%sã‚’\nã¦ã«ã„ã‚ŒãŸã€‚ğŸ”»')\format(g_player.name, @gold_or_item) })\attach()
			if lume.find(æ­¦å™¨ä¸€è¦§, @gold_or_item) then g_player.æ­¦å™¨, @gold_or_item = @gold_or_item, g_player.æ­¦å™¨
			if lume.find(é§ä¸€è¦§, @gold_or_item) then g_player.é§, @gold_or_item = @gold_or_item, g_player.é§
			if lume.find(ç›¾ä¸€è¦§, @gold_or_item) then g_player.ç›¾, @gold_or_item = @gold_or_item, g_player.ç›¾
			g_player.items[] = @gold_or_item

export æ‰‰ = class æ‰‰ extends Charactor
	new: (x, y, @name)=>
		if not lume.find(g_player.flags, @name) then super(x, y, {0x11})
		else
			super(0,0,{0x20})
			@talk = lume.noop
	talk: =>
		if not lume.find(g_player.items, L'ã‹ã') then return MessageBoxRetro({L'ã‹ããŒã€€ã²ã¤ã‚ˆã†ãªã‚ˆã†ã ã€‚ğŸ”»'})\attach()
		play'assets/DQ1/æ‰‰.ogg'
		lume.remove(g_player.items, L'ã‹ã')
		lume.remove(Scene.current.charactors, @)
		g_player.flags[] = @name


export class Battle extends MessageBoxRetro
	new: (@monster)=>
		@offset = {0, 0}
		@AutoA = true
		@effect_basecolor = {1,1,1}
		super({ <index>: coroutine.wrap((_, _)->
			æ•µã®æ”»æ’ƒ = ->
				if L'çœ ã‚Š' in @monster.flags and math.random() < 1/3 then coroutine.yield 1, L('\nã€€%sã¯ã‚ã‚’ã•ã¾ã—ãŸï¼')\format(@monster.name), lume.remove(@monster.flags, L'çœ ã‚Š') -- æœ¬å½“ã¯çœ ã‚‰ã•ã‚ŒãŸæ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ä¸€å®šç¢ºç‡ã§èµ·ãã‚‹
				if L'çœ ã‚Š' in @monster.flags then coroutine.yield 1, L('\nã€€%sã¯ã€€ã­ã‚€ã£ã¦ã„ã‚‹ï¼')\format(@monster.name)
				else
					if g_player.ã¡ã‹ã‚‰ / 2 >= @monster.æ”»æ’ƒåŠ› and (L'çœ ã‚Š' in g_player.flags or math.random() < 1/4)
						coroutine.yield 1, L('\nã€€%sã¯ã€€ã«ã’ã ã—ãŸï¼')\format(@monster.name)
						@detach(BGM(@parent.__class.BGM))
					strategy = lume.weightedchoice(if lume.find(@monster.flags, L'å‘ªæ–‡å°ã˜') then lume.pick(@monster.strategy, L'ãŸãŸã‹ã†', L'ã»ã®ãŠ', L'ã‹ãˆã‚“ã®ã„ã¶ã') else @monster.strategy) -- å‘ªæ–‡ãŒãµã†ã˜ã‚‰ã‚Œã¦ã„ã‚‹ã¨ãã¯ãã®é¸æŠè‚¢ã‚’å–ã‚‰ãªã„ã“ã¨ã«ã™ã‚‹ã€‚
					coroutine.yield 1, L'\n'
					if strategy in lume.keys(å‘ªæ–‡ä¸€è¦§)
						å‘ªæ–‡ä¸€è¦§[strategy].gen_messages(@monster, g_player, strategy)()
					else
						coroutine.yield 1, L('ã€€%sã®ã€€ã“ã†ã’ãï¼')\format(@monster.name)
						play'assets/sounds/mml2ogg/ã“ã†ã’ã.ogg'
						n = math.floor((@monster.æ”»æ’ƒåŠ› - g_player\å®ˆå‚™åŠ›()/2) * lume.random(0.25, 0.5))--(0.8, 1.0))
						if n <= 0 or math.random() < g_player.æ”»æ’ƒå›é¿ç‡
							coroutine.yield 1, L'\nã€€ãƒŸã‚¹ï¼\nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãªã„ï¼' -- todo: ãƒŸã‚¹ã®éŸ³ï¼
						else
							for p in *{--[[{-4, -4}, {4, 4}, {4, -3}, {-3, 4}, ]]{-3, -3}, {2, 3}, {2, -3}, {-3, 2}, {-2, -2}, {2, 1}, {1, -2}, {-1, 1}, {-1, -1}, {0, 0}}
								@offset = p
								coroutine.yield 1
							g_player.hp -= n
							coroutine.yield 1, L('\nã€€%sã¯%sãƒã‚¤ãƒ³ãƒˆã®\nã€€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼')\format(g_player.name, toZenkaku(n))
					if g_player.hp <= 0
						@AutoA = false
						coroutine.yield 1, L('\n%sã¯ã—ã‚“ã§ã—ã¾ã£ãŸï¼ğŸ”»')\format(g_player.name)
						lume.remove(g_player.flags, L'çœ ã‚Š')
						lume.remove(g_player.flags, L'å‘ªæ–‡å°ã˜')
						Scene.current\detach()
						Scene.current\blackout -> Scene.current = require('DQ1_ç‰åº§').build_æ­»ã«æˆ»ã‚Š()
			BGM({'assets/sounds/mml2ogg/ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆ.ogg', @monster.BGM or 'assets/sounds/mml2ogg/battle.ogg'})
			command = @@.Command()
			coroutine.yield 1, if not @monster.BGM then L('%sãŒã€€ã‚ã‚‰ã‚ã‚ŒãŸï¼')\format(@monster.name) else L'ã‚Šã‚…ã†ãŠã†ã¯ã€€ã—ã‚‡ã†ãŸã„ã‚’ã‚ã‚‰ã‚ã—ãŸï¼'
			if g_player.ã¡ã‹ã‚‰ / 2 >= @monster.æ”»æ’ƒåŠ› and math.random() < 1/4
				coroutine.yield 1, L('\nã€€%sã¯ã€€ã«ã’ã ã—ãŸï¼')\format(@monster.name)
				@detach(BGM(@parent.__class.BGM))
			if math.random() < @monster.å®ˆå‚™åŠ› / (@monster.å®ˆå‚™åŠ› + g_player.ç´ æ—©ã• * 4) -- ã“ã¡ã‚‰ã®å…ˆåˆ¶æ”»æ’ƒã¯DQ1ã«ã¯ãªã„ãã†ã 
				coroutine.yield 1, L('\nã€€%sãŒã€€ã¿ãŒã¾ãˆã‚‹ã‚ˆã‚Šã€€ã¯ã‚„ã\nã€€%sã¯ã€€ãŠãã„ã‹ã‹ã£ã¦ããŸï¼')\format(g_player.name, @monster.name)
				æ•µã®æ”»æ’ƒ()
			while true
				if L'çœ ã‚Š' in g_player.flags and math.random() < 1/3 then coroutine.yield 1, L('\n%sã¯ã€€ã‚ã‚’ã•ã¾ã—ãŸï¼')\format(g_player.name), lume.remove(g_player.flags, L'çœ ã‚Š')
				if L'çœ ã‚Š' in g_player.flags then coroutine.yield 1, L('\n%sã¯ã€€ã­ã‚€ã£ã¦ã„ã‚‹ï¼')\format(g_player.name)
				else
					coroutine.yield 1, L'\nã‚³ãƒãƒ³ãƒ‰ï¼Ÿ'
					coroutine.yield 1, command\attach()
					switch command.index
						when 1 -- ãŸãŸã‹ã†
							coroutine.yield 1, L('\n%sã®ã“ã†ã’ãï¼')\format(g_player.name)
							n = math.floor((g_player\æ”»æ’ƒåŠ›() - @monster.å®ˆå‚™åŠ›/2) * lume.random(0.25, 0.5))--(0.8, 1.0))
							æ”»æ’ƒéŸ³ = 'assets/sounds/mml2ogg/ã“ã†ã’ã.ogg'
							if math.random() < 1/32 and @monster.name != 'ã‚Šã‚…ã†ãŠã†' -- or 'ã‚Šã‚…ã†ãŠã†(ç«œ)' ã§ã¯ã‹ã„ã—ã‚“ã®ã„ã¡ã’ãã¯èµ·ããªã„
								coroutine.yield 1, L'\nã‹ã„ã—ã‚“ã®ã„ã¡ã’ãï¼'
								n = math.floor(g_player\æ”»æ’ƒåŠ›() * lume.random(0.5, 1.01))--(0.8, 1.01))
								æ”»æ’ƒéŸ³ = 'assets/DQ1/ã‹ã„ã—ã‚“ã®ã„ã¡ã’ã.ogg'
							if n <= 0 or math.random() < @monster.æ”»æ’ƒå›é¿ç‡
								coroutine.yield 1, L'\nãƒŸã‚¹ï¼\nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚ãŸãˆã‚‰ã‚Œãªã„ï¼' -- ãƒŸã‚¹ã®éŸ³ï¼
							else
								@monster.hp -=n
								s = play æ”»æ’ƒéŸ³
								for c in *{{1,.5,.5}, {1,.1,.5}, {1,.5,.1}, {.5,.5,.5}, {1,.1,.5}, {1,.5,.1}, {1,1,1}, } do
									@effect_basecolor = c
									coroutine.yield 1
								while s\isPlaying() do coroutine.yield 1
								coroutine.yield 1, L('\n%sã«ã€€%sãƒã‚¤ãƒ³ãƒˆã®\nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚ãŸãˆãŸï¼')\format(@monster.name, toZenkaku(n))
						when 3 -- ã«ã’ã‚‹
							play'assets/DQ1/éšæ®µ.ogg'
							coroutine.yield 1, L('\n%sã¯ã€€ã«ã’ã ã—ãŸï¼')\format(g_player.name)
							if g_player.ç´ æ—©ã•*lume.random() >= @monster.å®ˆå‚™åŠ›*lume.random(0,0.25) or L'çœ ã‚Š' in @monster.flags then @detach(BGM(@parent.__class.BGM))
							else coroutine.yield 1, L'\nã—ã‹ã—ã€€ã¾ã‚ã‚Šã“ã¾ã‚Œã¦ã—ã¾ã£ãŸï¼'
						when 2 -- ã˜ã‚…ã‚‚ã‚“
							if L'å‘ªæ–‡å°ã˜' in g_player.flags
								coroutine.yield 1, L('%sã®ã€€ã˜ã‚…ã‚‚ã‚“ã¯ãµã†ã˜ã‚‰ã‚Œã¦ã„ã‚‹ã€‚ğŸ”»')\format(g_player.name)
								continue
							if 0 == #g_player.spells
								coroutine.yield 1, L('%sã¯ã€€ã¾ã ã€€ã˜ã‚…ã‚‚ã‚“ã‚’ã¤ã‹ãˆãªã„ã€‚ğŸ”»')\format(g_player.name)
								continue
							if not command.sb
								coroutine.yield 1, L'\nï¼­ï¼°ãŒãŸã‚Šãªã„ï¼ğŸ”»'
								continue
							elseif command.sb.index <= 0 then continue
							else
								coroutine.yield 1, '\n'
								id = command.sb.buttons[command.sb.index].id
								å‘ªæ–‡ä¸€è¦§[id].gen_messages(g_player, @monster, id)()
						when 4 -- ã©ã†ã
							if not command.sb
								coroutine.yield 1, L'ã¤ã‹ãˆã‚‹ã€€ã©ã†ãã‚’ã€€ã‚‚ã£ã¦ã„ãªã„ï¼ğŸ”»'
								continue
							elseif command.sb.index <= 0 then continue
							else
								coroutine.yield 1, '\n'
								id = command.sb.buttons[command.sb.index].id
								é“å…·ä¸€è¦§[id].gen_messages(g_player, @monster, id)()
						else continue
					if @monster.hp <= 0 then break
				æ•µã®æ”»æ’ƒ()
			@monster.img = gr.newFlyweightImage() -- é€æ˜ã«å·®ã—æ›¿ãˆ
			@AutoA = nil
			-- BGM({'assets/sounds/mml2ogg/å‹åˆ©.ogg', @parent.__class.BGM})
			lume.remove(g_player.flags, L'å‘ªæ–‡å°ã˜')
			g_player.çµŒé¨“å€¤ += @monster.çµŒé¨“å€¤
			g_player.gold += @monster.gold
			if not @monster.BGM
				BGM({'assets/sounds/mml2ogg/å‹åˆ©.ogg', @parent.__class.BGM})
				coroutine.yield 1, L('\n%sã‚’ã€€ãŸãŠã—ãŸï¼\nã‘ã„ã‘ã‚“ã¡ã‚’ã€€%sãƒã‚¤ãƒ³ãƒˆã‹ãã¨ã\n%sã‚´ãƒ¼ãƒ«ãƒ‰ã‚’ã¦ã«ã„ã‚ŒãŸï¼ğŸ”»')\format(@monster.name, toZenkaku(@monster.çµŒé¨“å€¤), toZenkaku(@monster.gold))
			else
				BGM()
				play_wait'assets/sounds/mml2ogg/å‹åˆ©.ogg'
				coroutine.yield 1, L('\n%sã‚’ã€€ãŸãŠã—ãŸï¼ğŸ”»')\format(@monster.name)
				coroutine.yield 1, L('\nãã—ã¦ã€€ã²ã‹ã‚Šã®ãŸã¾ã‚’\nã‚Šã‚…ã†ãŠã†ã‹ã‚‰ã€€ã¨ã‚Šã‚‚ã©ã—ãŸï¼ğŸ”»')
				coroutine.yield 1, L('\nã‚ãªãŸãŒã€€ã²ã‹ã‚Šã®ãŸã¾ã‚’ã€€ã‹ã–ã™ã¨\nã¾ã°ã‚†ã„ã°ã‹ã‚Šã®ã€€ã²ã‹ã‚ŠãŒ\nã‚ãµã‚Œã ã™â€¦â€¦ğŸ”»')
				coroutine.yield 1, L('\nã“ã®ãã«ã«ã€€ã¸ã„ã‚ãŒã€€ã‚‚ã©ã£ãŸã®ã ã€‚ğŸ”»')
				g_player.items[] = L'ã²ã‹ã‚Šã®ãŸã¾'
				coroutine.yield 1, Scene.current.parent\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atã‚Šã‚…ã†ãŠã†ã®åŸ
			t = LevelUps[g_player.level+1]
			if t and g_player.çµŒé¨“å€¤ >= t.çµŒé¨“å€¤
				play_wait 'assets/sounds/mml2ogg/ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—.ogg'
				g_player.level += 1
				coroutine.yield 1, L('\n%sã¯ã€€ãƒ¬ãƒ™ãƒ«ãŒã€€ã‚ãŒã£ãŸï¼ğŸ”»')\format(g_player.name)
				coroutine.yield 1, L('\nã¡ã‹ã‚‰ãŒ%sã‚ãŒã£ãŸï¼\nã™ã°ã‚„ã•ãŒ%sã‚ãŒã£ãŸï¼\nã•ã„ã ã„ï¼¨ï¼°ãŒ%sã‚ãŒã£ãŸï¼\nã•ã„ã ã„ï¼­ï¼°ãŒ%sã‚ãŒã£ãŸï¼')\format(toZenkaku(t.ã¡ã‹ã‚‰ - g_player.ã¡ã‹ã‚‰), toZenkaku(t.ç´ æ—©ã• - g_player.ç´ æ—©ã•), toZenkaku(t.maxhp - g_player.maxhp), toZenkaku(t.maxmp - g_player.maxmp) )
				if t.å‘ªæ–‡ then coroutine.yield 1, L('\n%sã‚’ãŠã¼ãˆãŸï¼')\format(t.å‘ªæ–‡)
				g_player.ã¡ã‹ã‚‰, g_player.ç´ æ—©ã•, g_player.maxhp, g_player.maxmp, g_player.spells = t.ã¡ã‹ã‚‰, t.ç´ æ—©ã•, t.maxhp, t.maxmp, lume.concat(g_player.spells, {t.å‘ªæ–‡})
				coroutine.yield 1, 'ğŸ”»'
			nil
		)})

	predrawback: => gr.translate(@offset[1], @offset[2]) -- æºã‚‰ã™ç”¨
	draw: =>
		gr.rectangle(gr.setColor(gr.uipalette.text) or 'fill', 64, 64, 128, 128)
		gr.rectangle(gr.setColor(gr.uipalette.retro1) or 'line', 64, 64, 128, 128)
		super()
		@draw_hpmp()
		-- if Scene.current.__class == SelectBoxRetro then @command\draw()
		w, h = @monster.img\getDimensions()
		gr.draw(gr.setColor(@effect_basecolor) or @monster.img, 64+idiv(128-w,2), 64+idiv(128-h,2))

class Battle.Command extends SelectBox -- ã‚¯ãƒ©ã‚¹å†…ã«ã‚¯ãƒ©ã‚¹ã‚’æ›¸ãã¨ç”Ÿæˆé †åºï¼Ÿã§ã†ã¾ãè¡Œã‹ãªã„ã€‚å¤–å´ã‹ã‚‰è¿½åŠ ã—ã¦ã‚‚è‰¯ã„ã€‚
	@X, @Y, @W, @H = 18, 5, 11, 3
	new: =>
		super(SelectBox.buildButtons({L'ãŸãŸã‹ã†', L'ã˜ã‚…ã‚‚ã‚“', L'ã«ã’ã‚‹', L'ã©ã†ã'}, {{@@X*8,@@Y*8,5*8,2*8},{(@@X+6)*8,@@Y*8,5*8,2*8},{@@X*8,(@@Y+2)*8,5*8,2*8},{(@@X+6)*8,(@@Y+2)*8,5*8,2*8}}, nil, SelectBox.buildState4Indexes(4,2)))
		b.text = 'ã€€'..b.text for b in *@buttons
	attach: => _, @index = super(), 1
	detach: =>
		if 2 == @index
			spells = [s for s in *g_player.spells when å‘ªæ–‡ä¸€è¦§[s].mp <= g_player.mp and s in {L'ãƒ›ã‚¤ãƒŸ', L'ã‚®ãƒ©', L'ãƒ©ãƒªãƒ›ãƒ¼', L'ãƒãƒ›ãƒˆãƒ¼ãƒ³', L'ãƒ™ãƒ›ã‚¤ãƒŸ', L'ãƒ™ã‚®ãƒ©ãƒ', (if issubclass(@parent.parent.__class, Dungeon) then L'ãƒ«ãƒ¼ãƒ©' else nil)}]
			if #spells > 0
				@sb = with SelectBoxRetro(spells, 8, 22, 7, L'ã˜ã‚…ã‚‚ã‚“')
					.detach = => Scene.__base.detach(Scene.current.parent) -- super
				return @sb\attach()
		elseif 4 == @index
			items = [s for s in *g_player.items when s in {L'ã‚„ããã†', L'ã‚Šã‚…ã†ã®ã†ã‚ã“', L'ã‚ˆã†ã›ã„ã®ãµãˆ', (if issubclass(@parent.parent.__class, Dungeon) then L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•' else nil)}]
			if #items > 0
				@sb = with SelectBoxRetro(lume.unique(items), 9, 21, 7, L'ã©ã†ã')
					for b in *.buttons
						n = lume.count(items, (i)-> i == b.id)
						if n > 1 then b.text = b.text..'ã€€'\rep(8-utf8.len(b.text))..toZenkaku(n)
					.detach = => Scene.__base.detach(Scene.current.parent) -- super
				return @sb\attach()
		super()
	draw: =>
		@_static_starttime or= love.timer.getTime()
		gr.setScissor(@@X*8-8, @@Y*8-16, @@W*8+16, math.min((@@H*8+32)*(love.timer.getTime()-@_static_starttime)*20, maid64.sizeY))
		gr.draw_frame(@@X, @@Y, @@W, @@H, L'ã‚³ãƒãƒ³ãƒ‰')
		gr.points bdf1\points(b.text, b.box[1], b.box[2]) for b in *@buttons
		gr.points bdf1\points('â—', unpack @buttons[@index].box)
		gr.setScissor()

export generateMonster = (name--[[ = L'ã‚¹ãƒ©ã‚¤ãƒ ']])->
	damaged = (n)-> math.max(1, math.floor(lume.round(n*0.8, n)))
	switch name
		when 'ã‚¹ãƒ©ã‚¤ãƒ ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚¹ãƒ©ã‚¤ãƒ .png'), 1, 2, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(3), 3, 5, 3, {ãŸãŸã‹ã†: 16} -- mp maxmpä¸è¦ï¼Ÿç„¡é™ï¼
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 0, 15/16
		when 'ã‚¹ãƒ©ã‚¤ãƒ ãƒ™ã‚¹' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚¹ãƒ©ã‚¤ãƒ ãƒ™ã‚¹.png'), 1, 3, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(4), 4, 7, 3, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 0, 15/16
		when 'ãƒ‰ãƒ©ã‚­ãƒ¼' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ‰ãƒ©ã‚­ãƒ¼.png'), 2, 3, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(6), 6, 9, 6, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 0, 15/16
		when 'ã‚´ãƒ¼ã‚¹ãƒˆ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚´ãƒ¼ã‚¹ãƒˆ.png'), 3, 5, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(7), 7, 11, 8, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 4/16, 0, 0, 15/16
		when 'ã¾ã»ã†ã¤ã‹ã„' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã¾ã»ã†ã¤ã‹ã„.png'), 4, 12, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(13), 13, 11, 12, {ãŸãŸã‹ã†: 8, ã‚®ãƒ©: 8}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 0, 0
		when 'ãƒ¡ã‚¤ã‚¸ãƒ‰ãƒ©ã‚­ãƒ¼' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ¡ã‚¤ã‚¸ãƒ‰ãƒ©ã‚­ãƒ¼.png'), 5, 12, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(15), 15, 14, 14, {ãŸãŸã‹ã†: 8, ã‚®ãƒ©: 8}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 0, 0
		when 'ãŠãŠã•ãã‚Š' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãŠãŠã•ãã‚Š.png'), 6, 16, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(20), 20, 18, 16, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 0, 15/16
		when 'ãƒ¡ãƒ¼ãƒ€' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ¡ãƒ¼ãƒ€.png'), 7, 16, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(22), 22, 20, 18, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 0, 15/16
		when 'ãƒ¡ãƒˆãƒ­ã‚´ãƒ¼ã‚¹ãƒˆ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ¡ãƒˆãƒ­ã‚´ãƒ¼ã‚¹ãƒˆ.png'), 8, 18, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(23), 23, 18, 20, {ãŸãŸã‹ã†: 4, ã‚®ãƒ©: 12}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 6/16, 0, 0, 0
		when 'ãƒ‰ãƒ­ãƒ«' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ‰ãƒ­ãƒ«.png'), 10, 25, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(25), 25, 24, 24, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 0, 14/16
		when 'ãƒ‰ãƒ©ã‚­ãƒ¼ãƒ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ‰ãƒ©ã‚­ãƒ¼ãƒ.png'), 11, 20, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(20), 20, 22, 26, {ãŸãŸã‹ã†: 6, ãƒ›ã‚¤ãƒŸ: 4, ã‚®ãƒ©: 6}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 6/16, 2/16, 0, 0
		when 'ãŒã„ã“ã¤' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãŒã„ã“ã¤.png'), 11, 30, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(30), 30, 28, 22, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 4/16, 0, 0, 15/16
		when 'ã¾ã©ã†ã—' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã¾ã©ã†ã—.png'), 13, 35, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(30), 30, 28, 22, {ãŸãŸã‹ã†: 6, ãƒ©ãƒªãƒ›ãƒ¼: 4, ã‚®ãƒ©: 6}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 3/16, 1/16
		when 'ã¦ã¤ã•ãã‚Š' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã¦ã¤ã•ãã‚Š.png'), 14, 40, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(22), 22, 36, 42, {ãŸãŸã‹ã†: 3, ãƒ›ã‚¤ãƒŸ: 1}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 0, 15/16
		when 'ãƒªã‚«ãƒ³ãƒˆ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒªã‚«ãƒ³ãƒˆ.png'), 16, 50, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(6), 6, 9, 6, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 1/16, 15/16
		when 'ã—ã‚Šã‚‡ã†' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã—ã‚Šã‚‡ã†.png'), 17, 60, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(36), 36, 44, 34, {ãŸãŸã‹ã†: 12, ãƒ›ã‚¤ãƒŸ: 4}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 4/16, 0, 7/16, 0
		when 'ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ .png'), 115, 6, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(4), 4, 10, 255, {ãŸãŸã‹ã†: 4, ã‚®ãƒ©: 12}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 15/16, 15/16, 15/16
		when 'ãƒ˜ãƒ«ã‚´ãƒ¼ã‚¹ãƒˆ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ˜ãƒ«ã‚´ãƒ¼ã‚¹ãƒˆ.png'), 18, 70, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(36), 36, 40, 38, {ãŸãŸã‹ã†: 3, ãƒ©ãƒªãƒ›ãƒ¼: 4, ã‚®ãƒ©: 9}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 4/16, 0, 3/16, 1/16
		when 'ãƒªã‚«ãƒ³ãƒˆãƒãƒ«ãƒ ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒªã‚«ãƒ³ãƒˆãƒãƒ«ãƒ .png'), 20, 80, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(38), 38, 50, 36, {ãŸãŸã‹ã†: 4, ãƒãƒ›ãƒˆãƒ¼ãƒ³: 12}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 4/16, 7/16
		when 'ãƒ¡ãƒ¼ãƒ€ãƒ­ãƒ¼ãƒ‰' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ¡ãƒ¼ãƒ€ãƒ­ãƒ¼ãƒ‰.png'), 20, 85, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(35), 35, 47, 40, {ãŸãŸã‹ã†: 3, ãƒ›ã‚¤ãƒŸ: 12, ã‚®ãƒ©: 1}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 4/16, 0, 0, 15/16
		when 'ãƒ‰ãƒ­ãƒ«ãƒ¡ã‚¤ã‚¸' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ‰ãƒ­ãƒ«ãƒ¡ã‚¤ã‚¸.png'), 22, 90, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(38), 38, 52, 50, {ãŸãŸã‹ã†: 4, ãƒãƒ›ãƒˆãƒ¼ãƒ³: 12}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 2/16, 2/16
		when 'ã‚­ãƒ¡ãƒ©' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚­ãƒ¡ãƒ©.png'), 24, 100, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(42), 42, 56, 48, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 4/16, 15/16
		when 'ã—ã®ã•ãã‚Š' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã—ã®ã•ãã‚Š.png'), 24, 100, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(35), 35, 60, 90, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 0, 7/16, 15/16
		when 'ã—ã‚Šã‚‡ã†ã®ãã—' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã—ã‚Šã‚‡ã†ã®ãã—.png'), 28, 120, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(46), 46, 68, 56, {ãŸãŸã‹ã†: 4, ãƒ›ã‚¤ãƒŸ: 12}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 4/16, 3/16, 5/16, 0
		when 'ã‚´ãƒ¼ãƒ¬ãƒ ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚´ãƒ¼ãƒ¬ãƒ .png'), 5, 10, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(70), 70, 120, 60, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 0, 15/16, 15/16, 15/16
		when 'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒ³' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒ³.png'), 6, 200, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(50), 50, 48, 40, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 13/16, 15/16
		when 'ã‚ˆã‚ã„ã®ãã—' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚ˆã‚ã„ã®ãã—.png'), 33, 130, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(55), 55, 76, 78, {ãŸãŸã‹ã†: 4, ãƒãƒ›ãƒˆãƒ¼ãƒ³: 12}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 0, 6/16, 7/16
		when 'ãƒ¡ã‚¤ã‚¸ã‚­ãƒ¡ãƒ©' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ¡ã‚¤ã‚¸ã‚­ãƒ¡ãƒ©.png'), 34, 140, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(58), 58, 78, 68, {ãŸãŸã‹ã†: 8, ãƒ©ãƒªãƒ›ãƒ¼: 8}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 2/16, 0, 0
		when 'ã‹ã’ã®ãã—' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‹ã’ã®ãã—.png'), 37, 150, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(50), 50, 79, 64, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 15/16, 15/16, 15/16, 15/16
		when 'ã‚­ãƒ©ãƒ¼ãƒªã‚«ãƒ³ãƒˆ' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚­ãƒ©ãƒ¼ãƒªã‚«ãƒ³ãƒˆ.png'), 40, 155, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(60), 60, 86, 70, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 7/16, 0, 7/16, 15/16
		when 'ãƒ‰ãƒ©ã‚´ãƒ³' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ‰ãƒ©ã‚´ãƒ³.png'), 45, 160, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(65), 65, 88, 74, {ãŸãŸã‹ã†: 12, ã»ã®ãŠ: 4}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 2/16, 7/16, 15/16
		when 'ã‚¹ã‚¿ãƒ¼ã‚­ãƒ¡ãƒ©' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚¹ã‚¿ãƒ¼ã‚­ãƒ¡ãƒ©.png'), 43, 160, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(65), 65, 86, 60, {ãŸãŸã‹ã†: 3, ãƒ™ãƒ›ã‚¤ãƒŸ: 12, ã»ã®ãŠ: 1}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 1/16, 8/16, 0
		when 'ã ã„ã¾ã©ã†' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã ã„ã¾ã©ã†.png'), 50, 165, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(65), 65, 80, 70, {ãŸãŸã‹ã†: 8, ãƒ™ã‚®ãƒ©ãƒ: 8}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 15/16, 15/16, 7/16
		when 'ã‚ãã¾ã®ãã—' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚ãã¾ã®ãã—.png'), 54, 165, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(70), 70, 94, 82, {ãŸãŸã‹ã†: 12, ãƒ©ãƒªãƒ›ãƒ¼: 4}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 1/16, 15/16, 3/16
		when 'ã‚­ãƒ¼ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚­ãƒ¼ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³.png'), 60, 150, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(70), 70, 98, 84, {ãŸãŸã‹ã†: 12, ã»ã®ãŠ: 4}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 7/16, 15/16, 15/16
		when 'ã‚¹ãƒˆãƒ¼ãƒ³ãƒãƒ³' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚¹ãƒˆãƒ¼ãƒ³ãƒãƒ³.png'), 65, 140, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(160), 160, 100, 40, {ãŸãŸã‹ã†: 16}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 1/16, 7/16, 2/16, 15/16
		when 'ã—ã«ãŒã¿ã®ãã—' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã—ã«ãŒã¿ã®ãã—.png'), 70, 140, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(90), 90, 105, 86, {ãŸãŸã‹ã†: 3, ãƒ™ãƒ›ã‚¤ãƒŸ: 12, ãƒ™ã‚®ãƒ©ãƒ: 1}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 1/16, 15/16, 7/16
		when 'ãƒ€ãƒ¼ã‚¯ãƒ‰ãƒ©ã‚´ãƒ³' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ãƒ€ãƒ¼ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³.png'), 100, 140, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(100), 100, 120, 90, {ãŸãŸã‹ã†: 9, ãƒ©ãƒªãƒ›ãƒ¼: 4, ã»ã®ãŠ: 3}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 2/16, 15/16, 15/16, 7/16
		when 'ã‚Šã‚…ã†ãŠã†' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = name, gr.newFlyweightImage('assets/DQ1/ã‚Šã‚…ã†ãŠã†.png'), 0, 0, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(100), 100, 90, 75, {ãŸãŸã‹ã†: 3, ãƒãƒ›ãƒˆãƒ¼ãƒ³: 4, ãƒ™ã‚®ãƒ©ãƒ: 9}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 0, 15/16, 15/16, 15/16
		when 'ã‚Šã‚…ã†ãŠã†(ç«œ)' then with Charactor()
			.name, .img, .çµŒé¨“å€¤, .gold, .items = 'ã‚Šã‚…ã†ãŠã†', gr.newFlyweightImage('assets/DQ1/ã‚Šã‚…ã†ãŠã†(ç«œ).png'), 0, 0, {}
			.hp, .maxhp, .æ”»æ’ƒåŠ›, .å®ˆå‚™åŠ›, .strategy = damaged(130), 130, 140, 200, {ãŸãŸã‹ã†: 8, ã‹ãˆã‚“ã®ã„ã¶ã: 8}
			.æ”»æ’ƒå›é¿ç‡, .ã‚®ãƒ©ç³»å›é¿ç‡, .ãƒ©ãƒªãƒ›ãƒ¼å›é¿ç‡, .ãƒãƒ›ãƒˆãƒ¼ãƒ³å›é¿ç‡ = 0, 15/16, 15/16, 15/16
			.BGM = 'assets/sounds/mml2ogg/ã‚Šã‚…ã†ãŠã†æˆ¦.ogg' -- åˆ¤åˆ¥ãƒ•ãƒ©ã‚°ã¨ã™ã‚‹


export Field = class Field extends Scene -- å‰æ–¹å®£è¨€(local *)ã®ãŸã‚
	@BGM = 'assets/sounds/mml2ogg/overworld.ogg'
	new: (mapdata)=>
		super()
		@bg = Map('assets/DQ1/BG16x16.png', {16, 16})
		@bg\set(mapdata)
		@sprites = Map('assets/DQ1/SPR16x16.png', {16, 16})
		@scroll = {0, 0} -- ç§»å‹•ä¸­ã®ã‚¢ãƒ‹ãƒ¡ç”¨
		@charactors = {}
		@traps = {}
		@offset = {0, 0} -- ç”»é¢æºã‚‰ã™ç”¨

	ã—ã‚‰ã¹ã‚‹: => -- nil -> ã€Œä½•ã‚‚ãªã‹ã£ãŸ
	-- isblocked: (x, y)=> @bg.data[y+1][x+1] >= 0x40 or (x==g_player.x and y==g_player.y) or lume.any(@charactors, (c)-> x == (c.tween?.target.x or c.x) and y == (c.tween?.target.y or c.y)) -- playerç”¨ã¨NPCç”¨ã¾ã¨ã‚ã‚‰ã‚Œãªã‹ã£ãŸ

	update: (dt)=>
		super(dt)
		g_player\update(dt)
		for c in *@charactors do c\update(dt)
		if @tween and @tween.clock < @tween.duration then return @tween\update(dt) -- ç§»å‹•ã‚¢ãƒ‹ãƒ¡ä¸­ã€‚ä½•ã‚‚ã•ã›ãªã„
		if @tween -- ãƒã‚¹ç›®ã«åˆ°ç€ã—ãŸã‚ã¨ï¼‘å›ã ã‘ã‚„ã‚‹ã“ã¨
			@tween = nil
			if g_player.ãƒˆãƒ˜ãƒ­ã‚¹count == 0 then MessageBoxRetro({L'ãƒˆãƒ˜ãƒ­ã‚¹ã®ã€€ã“ã†ã‹ãŒã€€ãã‚ŒãŸï¼ğŸ”»'})\attach()
			if g_player.ã›ã„ã™ã„count == 0 then MessageBoxRetro({L'ã›ã„ã™ã„ã®ã€€ã“ã†ã‹ãŒã€€ãã‚ŒãŸï¼ğŸ”»'})\attach()
			if  g_player.é§ == 'ãƒ­ãƒˆã®ã‚ˆã‚ã„' or (g_player.é§ == 'ã¾ã»ã†ã®ã‚ˆã‚ã„' and g_player.ã¾ã»ã†ã®ã‚ˆã‚ã„count % 4 == 3) then g_player.hp = math.min(g_player.hp+1, g_player.maxhp)
			else
				if 0x2c == @bg.data[g_player.y+1][g_player.x+1] then g_player.hp, @update, _ = g_player.hp-1, coroutine.wrap(@_update_shaking), play'assets/sounds/mml2ogg/ã“ã†ã’ã.ogg' -- æ¯’ã®æ²¼åœ°
				if 0x2d == @bg.data[g_player.y+1][g_player.x+1] then g_player.hp, @update, _ = g_player.hp-14, coroutine.wrap(@_update_shaking), play'assets/sounds/mml2ogg/ã“ã†ã’ã.ogg' -- ãƒãƒªã‚¢
			gr.uipalette.retro1 =if g_player.hp / g_player.maxhp > 1/3 then gr.uipalette.base else {lume.color'#cc3333'}
			if g_player.hp <= 0 then MessageBoxRetro({ <index>: coroutine.wrap((_,_)->
				coroutine.yield 1, L('%sã¯ã€€ã—ã‚“ã§ã—ã¾ã£ãŸï¼ğŸ”»')\format(g_player.name)
				Scene.current\detach()
				Scene.current\blackout -> Scene.current = require('DQ1_ç‰åº§').build_æ­»ã«æˆ»ã‚Š()
			)})\attach()
			lume.first([t for t in *@traps when t.check?(g_player) or (g_player.x == t[1] and g_player.y == t[2])])?\talk() -- ç”ºã«ã¤ã„ãŸã®ã«æˆ¦é—˜ã«ãªã‚‰ãªã„ã‚ˆã†ã«ä¸€ã¤ã ã‘
		if input.Ar() or input.Br()-- Ap()ã ã¨SelectBoxã§Ar()ãŒã™ãæ¥ã¦ã—ã¾ã†ã€‚CharactorãŒã„ã‚‹æ™‚ã¯ã€è©±ã™ã€ã€ã„ãªã„æ™‚ã¯ã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤º
			for {dx, dy} in *{g_player.direction, {-1, 0}, {0, -1}, {1, 0}, {0, 1}} -- å‘ãå„ªå…ˆã ãŒã€ã™ã¹ã¦ã®æ–¹å‘ã§NPCã«æ¥ã—ã¦ã„ã‚Œã°ã€Œã¯ãªã™ã€
				if npc := lume.match(@charactors, (c)->g_player.x+dx == c.x and g_player.y+dy == c.y) then return npc\talk()
				elseif @bg.data[g_player.y+1+dy][g_player.x+1+dx] == 0x41
					if npc := lume.match(@charactors, (c)->g_player.x+dx*2 == c.x and g_player.y+dy*2 == c.y) then return npc\talk()
			@@.Command()\attach()
		if d := input.arrowkeysp({{-1,0}, {0,-1}, {1,0}, {0,1}}, 16)
			g_player.direction = d
			isblocked = (x, y)-> @bg.data[y+1][x+1] >= 0x40 or lume.any(@charactors, (c)-> x == (c.tween?.target.x or c.x) and y == (c.tween?.target.y or c.y))
			if isblocked(g_player.x+d[1], g_player.y+d[2]) then
				play $mml2ogg([[ @8o3l16c<a ]]) -- 16ãƒ•ãƒ¬ãƒ¼ãƒ ã«ï¼‘å›ãªã®ã§ã“ã‚Œã§ã„ã„ã®ã§ã¯ï¼Ÿ
			else
				g_player.x += d[1]
				g_player.y += d[2]
				if @__class == Field then g_player.ãƒˆãƒ˜ãƒ­ã‚¹count, g_player.ã›ã„ã™ã„count = g_player.ãƒˆãƒ˜ãƒ­ã‚¹count - 1, g_player.ã›ã„ã™ã„count - 1
				if @__class == Dungeon then g_player.ãƒ¬ãƒŸãƒ¼ãƒ©count = g_player.ãƒ¬ãƒŸãƒ¼ãƒ©count - 1
				g_player.ã¾ã»ã†ã®ã‚ˆã‚ã„count += 1
				@scroll = {d[1]*16, d[2]*16}
				-- pp g_player, @scroll
				@tween = tween.new((16-2)/60, @scroll, {0, 0})
				@tween\update(dt)

	_update_shaking: (dt)=>
		for p in *{--[[{-4, -4}, {4, 4}, {4, -3}, {-3, 4}, ]]{-3, -3}, {2, 3}, {2, -3}, {-3, 2}, {-2, -2}, {2, 1}, {1, -2}, {-1, 1}, {-1, -1}, {0, 0}}
			@@__base.update(@, dt)
			@offset = p
			_, dt = coroutine.yield()
		@update = nil

	blackout: (lazy)=> -- æš—è»¢ã—ã¦ã‚·ãƒ¼ãƒ³è»¢æ›
		@update = coroutine.wrap (dt)=>
			for i = 0, 1, 2/60
				@._blackout = i
				_, dt = coroutine.yield()
			lazy()
			@update, @._blackout = nil, nil

	draw_status: =>
		return if input.idletime < 0.8 or Scene.current != @
		X, Y, W, H = 3, 5, 6, 9
		gr.setScissor(X*8-8,Y*8-16,(W+16)*8,(H*8+32)*(input.idletime-0.8)*20)
		gr.draw_frame(X,Y,W,H,g_player.name)
		s = L'ãƒ¬ãƒ™ãƒ«'..' '\rep(6-#tostring(g_player.level)*2)..toZenkaku(g_player.level)..
			L'\nï¼¨ï¼°'..' '\rep(8-#tostring(g_player.hp)*2)..toZenkaku(g_player.hp)..
			L'\nï¼­ï¼°'..' '\rep(8-#tostring(g_player.mp)*2)..toZenkaku(g_player.mp)..
			L'\nï¼§'..' '\rep(10-#tostring(g_player.gold)*2)..toZenkaku(g_player.gold)..
			L'\nï¼¥'..' '\rep(10-#tostring(g_player.çµŒé¨“å€¤)*2)..toZenkaku(g_player.çµŒé¨“å€¤)
		gr.points((gr.setColor(gr.uipalette.retro1) or bdf1\points(s, X*8, Y*8)))
		gr.setScissor()

	drawå‘¨å›²ã‚’æš—ã: =>
		if not issubclass(@__class, Dungeon) or issubclass(@__class, Dungeonåœ°ä¸Š) then return
		r = if g_player.ãƒ¬ãƒŸãƒ¼ãƒ©count > 0 then 29+60*g_player.ãƒ¬ãƒŸãƒ¼ãƒ©count/100 elseif g_player.ãŸã„ã¾ã¤ then 29 else 11.2
		gr.stencil((-> gr.circle(gr.setColor(1,1,1) or 'fill', 128, 128, r)), 'increment')
		gr.setStencilTest('equal', 0)--'greater', 0)
		gr.rectangle(gr.setColor(0,0,0,.82) or 'fill', -9, -9, maid64.sizeX+18, maid64.sizeY+18) -- æºã‚‰ã™ã¨ããŒã‚ã‚‹ãŸã‚ï¼Ÿ
		gr.setStencilTest()

	predrawback: => gr.translate(@offset[1], @offset[2]) -- æºã‚‰ã™ç”¨
	draw: =>
		dx, dy = lume.round(-g_player.x*16+@scroll[1]+120), lume.round(-g_player.y*16+@scroll[2]+120) -- æ•´æ•°ã§ãªã„ã¨æ±šã„æç”»ã«ãªã‚‹
		@bg\draw(dx, dy)
		@sprites.spritebatch\clear()
		@sprites.spritebatch\add(@sprites.quads[g_player.chipids[(1+blink())%#g_player.chipids+1]], 120, 120)
		for c in *@charactors
			@sprites.spritebatch\add(@sprites.quads[c.chipids[(1+blink())%#c.chipids+1]], c.x*16+dx, c.y*16+dy)
		@sprites\draw(0, 0)
		@drawå‘¨å›²ã‚’æš—ã()
		@draw_status()
		if @._blackout then gr.rectangle(gr.setColor(0,0,0,@._blackout) or 'fill', 0, 0, maid64.sizeX, maid64.sizeY)
		-- if DEBUGMODE then gr.print(gr.setColor(gr.uipalette.base) or "(#{g_player.x},#{g_player.y})")
		-- gr.print 'FPS '..love.timer.getFPS() , 80, 0


export Town = class Town extends Field -- å‰æ–¹å®£è¨€(local *)ã®ãŸã‚ä»£å…¥æ–‡ã«ã‚‚ã™ã‚‹
	@BGM = 'assets/sounds/mml2ogg/town.ogg'
export class Castle extends Town
	@BGM = 'assets/sounds/mml2ogg/castle.ogg'
export Dungeon = class Dungeon extends Field
	@BGM = 'assets/sounds/mml2ogg/dungeon.ogg'
export Dungeonåœ°ä¸Š = class Dungeonåœ°ä¸Š extends Dungeon -- no mangleã‚’exportã™ã‚‹ãŸã‚ä»£å…¥æ–‡ã«ã‚‚ã™ã‚‹


class Field.Command extends SelectBox
	@X, @Y, @W, @H = 18, 5, 11, 3
	new: =>
		super(SelectBox.buildButtons({L'ã—ã‚‰ã¹ã‚‹', L'ã˜ã‚…ã‚‚ã‚“', L'ã¤ã‚ˆã•', L'ã©ã†ã'}, {{@@X*8,@@Y*8,5*8,2*8},{(@@X+6)*8,@@Y*8,5*8,2*8},{@@X*8,(@@Y+2)*8,5*8,2*8},{(@@X+6)*8,(@@Y+2)*8,5*8,2*8}},{(->g_player\ã—ã‚‰ã¹ã‚‹()), (->g_player\ã˜ã‚…ã‚‚ã‚“()), (->g_player\ã¤ã‚ˆã•()), (->g_player\ã©ã†ã())},SelectBox.buildState4Indexes(4,2)))
		b.text = 'ã€€'..b.text for b in *@buttons
	clickB: =>
		@playClickSE()
		@detach()
	draw: =>
		@_static_starttime or= love.timer.getTime()
		gr.setScissor(@@X*8-8, @@Y*8-16, @@W*8+16, math.min((@@H*8+32)*(love.timer.getTime()-@_static_starttime)*20, maid64.sizeY))
		gr.draw_frame(@@X, @@Y, @@W, @@H, 'ã‚³ãƒãƒ³ãƒ‰')
		gr.points bdf1\points(b.text, b.box[1], b.box[2]) for b in *@buttons
		gr.points bdf1\points('â—', unpack @buttons[@index].box)
		gr.setScissor()

class Status extends Scene
	@X, @Y, @W, @H = 15, 9, 11, 19
	new: =>
		@points =  L('ã€€ã€€ã€€ãƒ¬ãƒ™ãƒ«:')..' '\rep(8-#tostring(g_player.level)*2)..toZenkaku(g_player.level)..
			L('\nã€€ã€€ã€€ã¡ã‹ã‚‰:')..' '\rep(8-#tostring(g_player.ã¡ã‹ã‚‰)*2)..toZenkaku(g_player.ã¡ã‹ã‚‰)..
			L('\nã€€ã€€ã™ã°ã‚„ã•:')..' '\rep(8-#tostring(g_player.ç´ æ—©ã•)*2)..toZenkaku(g_player.ç´ æ—©ã•)..
			L('\nã•ã„ã ã„ï¼¨ï¼°:')..' '\rep(8-#tostring(g_player.maxhp)*2)..toZenkaku(g_player.maxhp)..
			L('\nã•ã„ã ã„ï¼­ï¼°:')..' '\rep(8-#tostring(g_player.maxmp)*2)..toZenkaku(g_player.maxmp)..
			L('\nã€€ã“ã†ã’ãåŠ›:')..' '\rep(8-#tostring(g_player\æ”»æ’ƒåŠ›())*2)..toZenkaku(g_player\æ”»æ’ƒåŠ›())..
			L('\nã€€ã€€ã—ã‚…ã³åŠ›:')..' '\rep(8-#tostring(g_player\å®ˆå‚™åŠ›())*2)..toZenkaku(g_player\å®ˆå‚™åŠ›())..
			L('\nã€€ã¶ã:')..' '\rep(14-utf8.len(g_player.æ­¦å™¨ or '')*2)..toZenkaku(g_player.æ­¦å™¨ or '')..
			L('\nã‚ˆã‚ã„:')..' '\rep(14-utf8.len(g_player.é§ or '')*2)..toZenkaku(g_player.é§ or '')..
			L('\nã€€ãŸã¦:')..' '\rep(14-utf8.len(g_player.ç›¾ or '')*2)..toZenkaku(g_player.ç›¾ or '')
		@points = bdf1\points @points, @@X*8, @@Y*8
	update: (_)=> if input.Ar() or input.Br() then @detach() --@parent\detach() -- ~~ã‚³ãƒãƒ³ãƒ‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚‚é–‰ã˜ã‚‹~~
	draw: =>
		@_static_starttime or= love.timer.getTime()
		gr.setScissor(@@X*8-8, @@Y*8-16, @@W*8+16, math.min((@@H*8+32)*(love.timer.getTime()-@_static_starttime)*20, maid64.sizeY))
		gr.draw_frame(@@X, @@Y, @@W, @@H, L'ã¤ã‚ˆã•')
		gr.points@points
		gr.setScissor()

export g_player = with Charactor(11, 13, {0x20,0x21}) -- luaã¯ï¼‘å§‹ã¾ã‚Šãªã®ã§mapdataã‚’èª¿ã¹ã‚‹æ™‚ã¯x y ã¨ã‚‚ã«+1ã™ã‚‹
	.name, .level = 'ã‚ã‚ã‚ã‚', 1
	.ãƒˆãƒ˜ãƒ­ã‚¹count, .ã›ã„ã™ã„count, .ãƒ¬ãƒŸãƒ¼ãƒ©count, .ã¾ã»ã†ã®ã‚ˆã‚ã„count = -1, -1, -1, 0
	.æ”»æ’ƒåŠ› = => @ã¡ã‹ã‚‰ + (æ­¦å™¨ä¸€è¦§[@æ­¦å™¨] or 0)
	.å®ˆå‚™åŠ› = => idiv(@ç´ æ—©ã•, 2) + (é§ä¸€è¦§[@é§] or 0) + (ç›¾ä¸€è¦§[@ç›¾] or 0)

	.ã—ã‚‰ã¹ã‚‹ = =>
		item = Scene.current.parent\ã—ã‚‰ã¹ã‚‹()
		with MessageBoxRetro({<index>: coroutine.wrap ((_,_)->
			coroutine.yield 1, L('%sã¯ã€€ã˜ã¶ã‚“ã®ã€€ã‚ã—ã‚‚ã¨ã‚’\nã—ã‚‰ã¹ãŸã€‚ğŸ”»')\format(@name)
			if item
				coroutine.yield 1, L('\nãªã‚“ã¨ã€€%sã‚’ã€€ã¿ã¤ã‘ãŸï¼ğŸ”»')\format(item)
				if lume.find(lume.keys(@@æ­¦å™¨ä¸€è¦§), item) then g_player.æ­¦å™¨, item = item, g_player.æ­¦å™¨
				if lume.find(lume.keys(@@é§ä¸€è¦§), item) then g_player.é§, item = item, g_player.é§
				if lume.find(lume.keys(@@ç›¾ä¸€è¦§), item) then g_player.ç›¾, item = item, g_player.ç›¾
				@items[] = item
			else coroutine.yield 1, L'\nã—ã‹ã—ã€€ãªã«ã‚‚ã€€ã¿ã¤ã‹ã‚‰ãªã‹ã£ãŸã€‚ğŸ”»'
			nil
		)})
			.detach = => @parent\detach()
			\attach()

	.ã¤ã‚ˆã• = => Status()\attach()

	.ã˜ã‚…ã‚‚ã‚“ = =>
		if 0 == #@spells then return with MessageBoxRetro({L('%sã¯ã€€ã¾ã ã€€ã˜ã‚…ã‚‚ã‚“ã‚’ã¤ã‹ãˆãªã„ã€‚ğŸ”»')\format(@name)})
			.detach = => @parent\detach()
			\attach()
		u = lume.concat {L'ãƒ›ã‚¤ãƒŸ', L'ãƒ™ãƒ›ã‚¤ãƒŸ' }, if not issubclass(Scene.current.parent.__class, Dungeon) then {L'ãƒ«ãƒ¼ãƒ©', L'ãƒˆãƒ˜ãƒ­ã‚¹'} elseif issubclass(Scene.current.parent.__class, Dungeonåœ°ä¸Š) then {L'ãƒªãƒ¬ãƒŸãƒˆ'} else {L'ãƒ¬ãƒŸãƒ¼ãƒ©', L'ãƒªãƒ¬ãƒŸãƒˆ'}
		spells = [s for s in *@spells when å‘ªæ–‡ä¸€è¦§[s].mp <= @mp and s in u]
		if 0 == #spells then return with MessageBoxRetro({L'ï¼­ï¼°ãŒãŸã‚Šãªã„ï¼ğŸ”»'})
			.detach = => @parent\detach()
			\attach()
		with SelectBoxRetro(spells, 8, 22, 7, L'ã˜ã‚…ã‚‚ã‚“')
			.detach = =>
				if @index <= 0 then return SelectBoxRetro.__base.detach(@)
				@parent\detach()
				MessageBoxRetro({<index>: coroutine.wrap å‘ªæ–‡ä¸€è¦§[@buttons[@index].id].gen_messages(g_player, nil, @buttons[@index].id)})\attach()
			\attach()

	.ã©ã†ã = =>
		if 0 == #@items then return with MessageBoxRetro({L'ã¤ã‹ãˆã‚‹ã‚‚ã®ã‚’ã€€ã¾ã ã€€ã‚‚ã£ã¦ãªã„ã€‚ğŸ”»'})
			.detach = => @parent\detach()
			\attach()
		u = lume.concat {L'ã‚„ããã†', L'ã‹ã', L'ã›ã„ã™ã„', L'ã‚Šã‚…ã†ã®ã†ã‚ã“', L'ã›ã‚“ã—ã®ã‚†ã³ã‚', L'ãã‚“ã®ãŸã¦ã”ã¨' }, if issubclass(Scene.current.parent.__class, Dungeon) then {L'ãŸã„ã¾ã¤' } else {L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•', L'ãŠã†ã˜ã‚‡ã®ã‚ã„', L'ãŸã„ã‚ˆã†ã®ã„ã—', L'ã‚ã¾ãã‚‚ã®ã¤ãˆ', L'ãƒ­ãƒˆã®ã—ã‚‹ã—', L'ã«ã˜ã®ã—ãšã'  }
		u = lume.concat(u, lume.keys(æ­¦å™¨ä¸€è¦§), lume.keys(é§ä¸€è¦§), lume.keys(ç›¾ä¸€è¦§))
		items = [s for s in *@items when lume.find(u, s)]
		if 0 == #items then return with MessageBoxRetro({L'ã¤ã‹ãˆã‚‹ã‚‚ã®ã‚’ã€€ã‚‚ã£ã¦ãªã„ã€‚ğŸ”»'})
			.detach = => @parent\detach()
			\attach()
		with SelectBoxRetro(lume.unique_(items), 9, 21, 9, L'ã©ã†ã') -- è¤‡æ•°æŒã¡ã¯ã¾ã¨ã‚ã‚‹
			for b in *.buttons
				n = lume.count(items, (i)-> i == b.id)
				if n > 1 then b.text = b.text..'ã€€'\rep(8-utf8.len(b.text))..toZenkaku(n)
			.detach = =>
				if @index <= 0 then return SelectBoxRetro.__base.detach(@)
				@parent\detach()
				name = @buttons[@index].id
				if lume.find(lume.keys(é“å…·ä¸€è¦§), name) then MessageBoxRetro({<index>: coroutine.wrap é“å…·ä¸€è¦§[name].gen_messages(g_player)})\attach()
				elseif lume.find(lume.keys(æ­¦å™¨ä¸€è¦§), name)
					g_player.æ­¦å™¨, tmp = name, g_player.æ­¦å™¨
					g_player.items[] = tmp
					MessageBoxRetro({L('%sã¯ã€€%sã‚’ã€€ãã†ã³ã—ãŸã€‚ğŸ”»')\format(g_player.name, name)})\attach()
				elseif lume.find(lume.keys(é§ä¸€è¦§), name)
					g_player.é§, tmp = name, g_player.é§
					g_player.items[] = tmp
					MessageBoxRetro({L('%sã¯ã€€%sã‚’ã€€ãã†ã³ã—ãŸã€‚ğŸ”»')\format(g_player.name, name)})\attach()
				elseif lume.find(lume.keys(ç›¾ä¸€è¦§), name)
					g_player.ç›¾, tmp = name, g_player.ç›¾
					g_player.items[] = tmp
					MessageBoxRetro({L('%sã¯ã€€%sã‚’ã€€ãã†ã³ã—ãŸã€‚ğŸ”»')\format(g_player.name, name)})\attach()
			\attach()

export Title = class Title extends SelectBox
	new: =>
		item3 = lume.randomchoice{L'ã‚¬ãƒ©ã‚¤ã®ç”º', L'æ²¼åœ°ã®æ´çªŸ', L'å²©å±±ã®æ´çªŸ',L'ãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ç”º', L'ã‚Šã‚…ã†ãŠã†ã®åŸ'}
		super(SelectBox.buildButtons({L'ã¯ã˜ã‚ã‹ã‚‰', L'ã¤ã¥ãã‹ã‚‰', item3}, {{108,136,40,16}, {108,136+16,40,16}, {108,136+16*2,40,16}}, {(-> Scene.current = require('DQ1_ç‰åº§').build_opening()), (-> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_load()), (-> @['start_at'..item3]())}))
		b.text = 'ã€€'..b.text for b in *@buttons
		BGM({'assets/sounds/mml2ogg/title_intro.ogg', 'assets/sounds/mml2ogg/title.ogg'})
	draw: =>
		gr.clear(lume.color'#005d78')
		gr.draw(gr.newFlyweightImage('assets/DQ1/title.png'), 24, 64)
		gr.points bdf1\points(b.text, b.box[1], b.box[2]) for b in *@buttons
		gr.points bdf1\points('â—', unpack @buttons[@index].box)

	start_atã‚¬ãƒ©ã‚¤ã®ç”º: =>
		g_player = with g_player
			.name, .level = 'ã‚ã‚ã‚ã‚', 11
			{çµŒé¨“å€¤: .çµŒé¨“å€¤, ã¡ã‹ã‚‰: .ã¡ã‹ã‚‰, ç´ æ—©ã•: .ç´ æ—©ã•, maxhp: .maxhp, maxmp: .maxmp} = LevelUps[.level]
			.hp, .mp, gold = .maxhp, .maxmp, .çµŒé¨“å€¤
			.spells = [info.å‘ªæ–‡ for info in *LevelUps[, .level] when info.å‘ªæ–‡]
			.items = {L'ã‚„ããã†', L'ã‚„ããã†', L'ã‹ã', L'ã‹ã', L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•'}
			.æ­¦å™¨, .é§, .ç›¾ = L'ã¯ãŒã­ã®ã¤ã‚‹ã', L'ãƒ­ãƒˆã®ã‚ˆã‚ã„', L'ã¦ã¤ã®ãŸã¦'
			.chipids = {0x26, 0x27}
		require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').save = lume.noop()
		Scene.current = require('DQ1_ã‚¬ãƒ©ã‚¤ã®ç”º').build_fromè¥¿å£()
	start_atæ²¼åœ°ã®æ´çªŸ: =>
		g_player = with g_player
			.name, .level = 'ã‚ã‚ã‚ã‚', 13
			{çµŒé¨“å€¤: .çµŒé¨“å€¤, ã¡ã‹ã‚‰: .ã¡ã‹ã‚‰, ç´ æ—©ã•: .ç´ æ—©ã•, maxhp: .maxhp, maxmp: .maxmp} = LevelUps[.level]
			.hp, .mp, gold = .maxhp, .maxmp, .çµŒé¨“å€¤
			.spells = [info.å‘ªæ–‡ for info in *LevelUps[, .level] when info.å‘ªæ–‡]
			.items = {L'ã‚„ããã†', L'ã‚„ããã†', L'ã‹ã', L'ã‹ã', L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•'}
			.æ­¦å™¨, .é§, .ç›¾ = L'ã¯ãŒã­ã®ã¤ã‚‹ã', L'ãƒ­ãƒˆã®ã‚ˆã‚ã„', L'ã¦ã¤ã®ãŸã¦'
			.chipids = {0x26, 0x27}
		require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').save = lume.noop()
		Scene.current = require('DQ1_æ²¼åœ°ã®æ´çªŸ').build_fromãƒ©ãƒ€ãƒˆãƒ¼ãƒ æ–¹é¢()
	start_atå²©å±±ã®æ´çªŸ: =>
		g_player = with g_player
			.name, .level = 'ã‚ã‚ã‚ã‚', 15
			{çµŒé¨“å€¤: .çµŒé¨“å€¤, ã¡ã‹ã‚‰: .ã¡ã‹ã‚‰, ç´ æ—©ã•: .ç´ æ—©ã•, maxhp: .maxhp, maxmp: .maxmp} = LevelUps[.level]
			.hp, .mp, gold = .maxhp, .maxmp, .çµŒé¨“å€¤
			.spells = [info.å‘ªæ–‡ for info in *LevelUps[, .level] when info.å‘ªæ–‡]
			.items = {L'ã‚„ããã†', L'ã‚„ããã†', L'ã‹ã', L'ã‹ã', L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•'}
			.æ­¦å™¨, .é§, .ç›¾ = L'ã¯ãŒã­ã®ã¤ã‚‹ã', L'ãƒ­ãƒˆã®ã‚ˆã‚ã„', L'ã¦ã¤ã®ãŸã¦'
			.chipids = {0x26, 0x27}
		require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').save = lume.noop()
		Scene.current = require('DQ1_å²©å±±ã®æ´çªŸ').build_fromåœ°ä¸Š()
	start_atãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ç”º: =>
		g_player = with g_player
			.name, .level = 'ã‚ã‚ã‚ã‚', 17
			{çµŒé¨“å€¤: .çµŒé¨“å€¤, ã¡ã‹ã‚‰: .ã¡ã‹ã‚‰, ç´ æ—©ã•: .ç´ æ—©ã•, maxhp: .maxhp, maxmp: .maxmp} = LevelUps[.level]
			.hp, .mp, gold = .maxhp, .maxmp, .çµŒé¨“å€¤
			.spells = [info.å‘ªæ–‡ for info in *LevelUps[, .level] when info.å‘ªæ–‡]
			.items = {L'ã‚„ããã†', L'ã‚„ããã†', L'ã‹ã', L'ã‹ã', L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•'}
			.æ­¦å™¨, .é§, .ç›¾ = L'ã¯ãŒã­ã®ã¤ã‚‹ã', L'ãƒ­ãƒˆã®ã‚ˆã‚ã„', L'ã¦ã¤ã®ãŸã¦'
			.chipids = {0x26, 0x27}
		require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').save = lume.noop()
		Scene.current = require('DQ1_ãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ç”º').build()
	start_atã‚Šã‚…ã†ãŠã†ã®åŸ: =>
		g_player = with g_player
			.name, .level = 'ã‚ã‚ã‚ã‚', 19
			{çµŒé¨“å€¤: .çµŒé¨“å€¤, ã¡ã‹ã‚‰: .ã¡ã‹ã‚‰, ç´ æ—©ã•: .ç´ æ—©ã•, maxhp: .maxhp, maxmp: .maxmp} = LevelUps[.level]
			.hp, .mp, gold = .maxhp, .maxmp, .çµŒé¨“å€¤
			.spells = [info.å‘ªæ–‡ for info in *LevelUps[, .level] when info.å‘ªæ–‡]
			.items = {L'ã‚„ããã†', L'ã‚„ããã†', L'ã‹ã', L'ã‹ã', L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•', L'ãƒ­ãƒˆã®ã—ã‚‹ã—', }
			.æ­¦å™¨, .é§, .ç›¾ = L'ã¯ãŒã­ã®ã¤ã‚‹ã', L'ãƒ­ãƒˆã®ã‚ˆã‚ã„', L'ã¦ã¤ã®ãŸã¦'
			.chipids = {0x26, 0x27}
		require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').save = lume.noop()
		Scene.current = require('DQ1_ã‚Šã‚…ã†ãŠã†ã®åŸ').build_fromå…¥å£()


love.load = ->
	vudu?.initialize()
	vudu?.initializeDefaultHotkeys()
	if DEBUGMODE
		g_player = with g_player
			.level = 21
			{çµŒé¨“å€¤: .çµŒé¨“å€¤, ã¡ã‹ã‚‰: .ã¡ã‹ã‚‰, ç´ æ—©ã•: .ç´ æ—©ã•, maxhp: .maxhp, maxmp: .maxmp} = LevelUps[.level]
			.hp, .mp = .maxhp, .maxmp
			.spells = [info.å‘ªæ–‡ for info in *LevelUps[, .level] when info.å‘ªæ–‡]
			.gold = .çµŒé¨“å€¤
			.items = {L'ã‚„ããã†', L'ã‚„ããã†', L'ã‹ã', L'ã‹ã', L'ãŸã„ã¾ã¤', L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•', L'ãã‚“ã®ãŸã¦ã”ã¨', L'ã«ã˜ã®ã—ãšã', L'ãŠã†ã˜ã‚‡ã®ã‚ã„', L'ã²ã‹ã‚Šã®ãŸã¾', L'ã‚ˆã†ã›ã„ã®ãµãˆ'}
			-- .æ­¦å™¨, .é§, .ç›¾ = L'ã“ã‚“ã¼ã†', L'ã‹ã‚ã®ãµã', L'ã‹ã‚ã®ãŸã¦'
			.æ­¦å™¨, .é§, .ç›¾ = L'ã¯ãŒã­ã®ã¤ã‚‹ã', L'ãƒ­ãƒˆã®ã‚ˆã‚ã„', L'ã¦ã¤ã®ãŸã¦'
			-- .flags[] = L'å‘ªã„'
			.chipids = {0x26, 0x27}
		-- Title()\attach()
		-- require('DQ1_ç‰åº§').build_opening()\attach()
		-- require('DQ1_ç‰åº§').build_æ­»ã«æˆ»ã‚Š()\attach()
		-- require('DQ1_ãƒ©ãƒ€ãƒˆãƒ¼ãƒ åŸ').build_atåŸé–€()\attach()
		require('DQ1_ãƒ©ãƒ€ãƒˆãƒ¼ãƒ ç”º').build_fromè¥¿å£()\attach()
		-- require('DQ1_ãƒ­ãƒˆã®æ´çªŸ').build_fromåœ°ä¸Š()\attach()
		-- require('DQ1_ã‚¬ãƒ©ã‚¤ã®ç”º').build_fromè¥¿å£()\attach()
		-- require('DQ1_ãƒã‚¤ãƒ©ã®æ‘').build()\attach()
		-- require('DQ1_æ²¼åœ°ã®æ´çªŸ').build_fromãƒ©ãƒ€ãƒˆãƒ¼ãƒ æ–¹é¢()\attach()
		-- require('DQ1_ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã®ç”º').build_fromå…¥å£()\attach()
		-- require('DQ1_è–ãªã‚‹ç¥ ').build()\attach()
		-- require('DQ1_å²©å±±ã®æ´çªŸ').build_fromåœ°ä¸Š()\attach()
		-- require('DQ1_é›¨ã®ç¥ ').build()\attach()
		-- require('DQ1_ãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ç”º').build()\attach()
		-- require('DQ1_ãƒ¡ãƒ«ã‚­ãƒ‰ã®ç”º').build_fromå…¥å£()\attach()
		-- require('DQ1_ã‚Šã‚…ã†ãŠã†ã®åŸ').build_fromå…¥å£()\attach()
		-- require('DQ1_ã‚Šã‚…ã†ãŠã†ã®åŸ').build_B7_fromB6_1()\attach()
	else
		Title()\attach()

	if DEBUGMODE -- hotswap
		Watchdog{
			"#{$FILE}": -> Watchdog.transpile("#{$FILE}", 'main.lua')
			'ui.yue': -> Watchdog.transpile('ui.yue')
			'input.yue': -> Watchdog.transpile('input.yue')
			'color.yue': -> Watchdog.transpile('color.yue')
			'utl.yue': -> Watchdog.transpile('utl.yue')
			'bigmap.yue': -> Watchdog.transpile('bigmap.yue')
			'BDF.yue': -> Watchdog.transpile('BDF.yue')
			'distribute.yue': -> Watchdog.transpile('distribute.yue')
			'main.lua': -> lume.hotswap('main')
			'input.lua': -> lume.hotswap('input')
			-- 'ui.lua': -> lume.hotswap('ui') -- uiã§watchdogãŒå®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§hotswapå‡ºæ¥ãªã„
			'color.lua': -> lume.hotswap('color')
			'utl.lua': -> lume.hotswap('utl')
			'bigmap.lua': -> lume.hotswap('bigmap')
			'BDF.lua': -> lume.hotswap('BDF')
			'distribute.lua': -> lume.hotswap('distribute')
			}
	if DEBUGMODE -- build
		-- os.execute 'rustc -C opt-level=3 --crate-type=cdylib ray.rs' -- android(32bit?)ç”¨
		-- os.execute 'rustc -C opt-level=3 --crate-type=cdylib ray.rs' -- Windowsç”¨
		-- os.execute 'zig build-lib -dynamic -target arm-linux-gnueabi ray.zig' -- android(32bit?)ç”¨
		-- os.execute 'zig build-lib -dynamic -target x86_64-windows ray.zig' -- Windowsç”¨
		-- require('distribute').build{'BDF.lua', 'DQ1_ç‰åº§.lua', 'DQ1_ãƒ©ãƒ€ãƒˆãƒ¼ãƒ åŸ.lua', 'DQ1_ãƒ©ãƒ€ãƒˆãƒ¼ãƒ ç”º.lua', 'DQ1_å…¨ä½“ãƒãƒƒãƒ—.lua' }
		love.thread.newThread([[
_G.PROJECTNAME, _G.VERSION, description = ...
require('distribute').build{'BDF.lua', 'color.lua', 'DQ1_ç‰åº§.lua', 'DQ1_ãƒ©ãƒ€ãƒˆãƒ¼ãƒ åŸ.lua', 'DQ1_ãƒ©ãƒ€ãƒˆãƒ¼ãƒ ç”º.lua', 'DQ1_å…¨ä½“ãƒãƒƒãƒ—.lua', 
	'DQ1_ãƒ­ãƒˆã®æ´çªŸ.lua', 'DQ1_ã‚¬ãƒ©ã‚¤ã®ç”º.lua', 'DQ1_ãƒã‚¤ãƒ©ã®æ‘.lua', 'DQ1_æ²¼åœ°ã®æ´çªŸ.lua', 'DQ1_è–ãªã‚‹ç¥ .lua', 'DQ1_ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã®ç”º.lua', 'DQ1_é›¨ã®ç¥ .lua',
	'DQ1_å²©å±±ã®æ´çªŸ.lua', 'DQ1_ãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ç”º.lua', 'DQ1_ãƒ¡ãƒ«ã‚­ãƒ‰ã®ç”º.lua', 'DQ1_ã‚Šã‚…ã†ãŠã†ã®åŸ.lua' }
-- require('distribute').modify_index_html(require('lib.os_capture').capture('echo \''..description..'\' | pandoc -f markdown -t html'))
]])\start PROJECTNAME, VERSION


_ = $mml2ogg([[
Tempo(228)
Track(1) q50 @8 o5 l4
'bg'4+8,100'bg'8'bg''ad'ã€€'ad''ad''g<b>''ad'ã€€'bg'>'c<a''bg''ad'ã€€'bg'>'c<a>''d<b>''ec'ã€€'ge''ec''d<b>''c<a>'ã€€<'bg''ad'4+16r16'ad'8'ad''bg'4+8,100'bg'8'bg''bg'ã€€'g<b>''bg',100'ad'2+1,100
]], title_intro, 9.473  ) -- 60/228 *4 * 9

_ = $mml2ogg([[
Tempo(117)
Track(1) q50 @8 o5 l4
g8+16,50,g16>cdã€€efgq100>cã€€^<b8+16a16a4+8g8ã€€+8f+8,50f+8a8g,50e^
<e8+16,50e16ee,50ã€€f+g+,50a2+8ã€€a8,50,b8,50>c8,50d2+8ã€€<a8,50a8,50>c8,50c<b
ag>e2+8ã€€f8e8d8c2ã€€<a>cd2+8e8d8c8c2ã€€<bg>g2+8
e8f8g8a2+8ã€€<a8b8c8f2ã€€e2c2+4
Track(2) q50 @8 v80 o5 l4
f8+16,50,f16egã€€>ccq100c2ã€€c2f4+8e8ã€€r8e-8,50e-8f8e,50c^
r<<g+g+,50ã€€ab,50>c2+8ã€€c8,50d8,50e8,50a2+8ã€€f+8,50f+8,50a8,50ag
ffg+2+8ã€€g+8g+8g+8a2ã€€eea2+8ã€€f+8f+8f+8f2
ff>e2+8ã€€c+8d8e8f2+8ã€€<f8g8a8a2ã€€b8,50a8,50g8f8e2+4
Track(3) q50 @8 v75 o5 l4
r>c<bã€€b-ae2,100ã€€f2,100>c<gã€€c>c<ce
g>c<e2,100ã€€e2,100aeã€€>c<af+aã€€>d<dg2,100
g,100b,100eg+ã€€beabã€€>c<af+aã€€>d<dgg
>dfec+ã€€<aadeã€€fd>d<gã€€>e<g>c<gã€€>c
]], title,  32.82 ) -- 60/117 *4 * 10


_ = $mml2ogg([[
Tempo(120)
Track(1) q100 @8 o5 l32 KeyFlag-(edba)
cea>cee-gb>d<bgedc<ge
]], ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆ, 1) -- 60/120

_ = $mml2ogg([[
Tempo(120)
Track(1) q100 @8 o5 l32 KeyFlag+(fcg)
e+4+8g-gaa+ b4+8fg-gaã€€a+4+8efg-g a4+8gaa+bã€€>c-4+8<fg-ga a+4+8fg-gaã€€a+4+8e+fg-g a4+8ee+fg-
g-4+8>cdd+e e+4+8cdd+eã€€e4+8<b>c-cd d+4+8<b>c-cdã€€d+4+8<b>c-cd d4+8<aa+b>c-ã€€c4+8<a+b>cc+d2
l12 g-dg-fd+fe+de+eceã€€d+c-<afd+c-c<eg-a>ce
Track(2) v80q100 @8 o4 l8 KeyFlag+(fcg)
]], battle, 20 ) -- 60/120 *4 * 10

_ = $mml2ogg([[
Tempo(220)
Track(1) q100 @8 o6 r8 l32cdefgab>c2
Track(2) v80q100 @8 o4 {gc}4
]], å‹åˆ©)

_ = $mml2ogg([[
Tempo(300)
Track(1) q100 @8 o6 l24 ga-f+ga-f+
]], ã“ã†ã’ã, 0.5)--60/300* 1.5/4*6)

_ = $mml2ogg([[
Tempo(300)
Track(1) q100 @8 o6 a16g16e-8
]], ãƒŸã‚¹)

_ = $mml2ogg([[
Tempo(100)
Track(1) q100 @8 o6 l24 ce-b-ebf q50 g4
]], å‘ªæ–‡, 1.2) -- 60/100*2

_ = $mml2ogg([[
Tempo(120)
Track(1) q100 @8 o6 l16 rfff q50 l8 fe- q100 g4+8
Track(2) v80q100 @8 o5 l16 rc>bb- q50 l8 agb q100 a4+8
]], ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—, 2) -- 60/120 *3.5

_ = $mml2ogg([[
Tempo(90)
Track(1) q100 @8 o7 l16 afd<b>
Tempo(120) fe<ba>
Tempo(150) d<baf
Tempo(180) afd<b>ã€€
Tempo(210) fd<ba>
Tempo(240) d<baf
afd<b> fd<ba>ã€€d<baf d8fa b>d8f ab>d8ã€€fab>d g2r4
]], ãã‚“ã®ãŸã¦ã”ã¨, 5.25) -- 60/90 *1 + 60/120 *1 + 60/150 *1 + 60/180 *1 + 60/210 * 1 + 60/240* 11

_ = $mml2ogg([[
Tempo(160)
Track(1) q100 @8 o5 l16 g8ab> é€£ç¬¦{cdefg}4 é€£ç¬¦{ab>cdef}4ã€€q50g4g4g4q100ã€€é€£ç¬¦{gagagaga}2g4ã€€a4d <ba g4
]], ã‚ˆã†ã›ã„ã®ãµãˆ, 4.6) -- 60/160 *12

_ = $mml2ogg([[
Tempo(90)
Track(1) q100 @8 o4 l16 cgb>e<
Tempo(135) da>cf<
Tempo(160) eb>dg< f>cea<ã€€l4é€£ç¬¦{<g>dg>ce} é€£ç¬¦{a>cfa>c} é€£ç¬¦{fe<bge}é€£ç¬¦{<bge<bg} c2r2
]], ã«ã˜ã®ã—ãšã, 3.85) -- 60/90 *1 + 60/135 *1 + 60/160 *10 

