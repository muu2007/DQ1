import 'macros' as {$}
import 'utl' as :L, :play--, :toZenkaku
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Dungeon, :Charactor, :g_player, :MessageBoxRetro, :SelectBoxRetro, :Battle, :generateMonster, :æ‰‰, :play_wait
local *

_ = $mml2ogg([[
Tempo(92)
Track(1) q100 @8 o6 l16 >c8.<agfe8d4ã€€b-8.ged c+4 a8ã€€>c2.
Track(2) q100 @8 o5 l8 r>c<a ra-fã€€r>d<b- rl16egbeã€€a>cec<a>c<a4.
Track(3) v80q100 @8 o4 l8 fa>c< g+bg+ã€€gb-g c+>c+<c+ã€€fa>c<afc< f4.
]], ãƒ­ãƒ¼ãƒ©å§«æ•‘å‡º, 5.87) -- 60/92 *9

mapdata = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEECCCCCCCCEEEEEEEEEE
EEEEEEEEC3'''''CEEEEEEEEEE
EEEEEEEEC'CC'CCCEEEEEEEEEE
EEEEEEEEC'C''C'CEEEEEEEEEE
EEEEEEEEC'CC'''CEEEEEEEEEE
EEEEEEEEC''''C'CEEEEEEEEEE
EEEEEEEEC'C'CC'CEEEEEEEEEE
EEEEEEEEC''CC''CEEEEEEEEEE
EEEEEEEEC'CC'''CEEEEEEEEEE
EEEEEEEEC''''C'CEEEEEEEEEE
EEEEEEEEC'C'CC'CEEEEEEEEEE
EEEEEEEEC'C''''CEEEEEEEEEE
EEEEEEEEC'C''C'CEEEEEEEEEE
EEEEEEEEC'C'CC'CEEEEEEEEEE
EEEEEEEEC'C''''CEEEEEEEEEE
EEEEEEEEC'CCC'CCEEEEEEEEEE
EEEEEEEEC'C''''CEEEEEEEEEE
EEEEEEEEC'C'CCCCEEEEEEEEEE
EEEEEEEEC'C'C''CEEEEEEEEEE
EEEEEEEEC'C'C''CEEEEEEEEEE
EEEEEEEEC'C'C''CEEEEEEEEEE
EEEEEEEEC'C'CC'CEEEEEEEEEE
EEEEEEEEC'C''''CEEEEEEEEEE
EEEEEEEEC'CCCCCCEEEEEEEEEE
EEEEEEEEC''''C'CEEEEEEEEEE
EEEEEEEEC'CC'C'CEEEEEEEEEE
EEEEEEEEC''C'''CEEEEEEEEEE
EEEEEEEECC'''CCCEEEEEEEEEE
EEEEEEEECCCC'''CEEEEEEEEEE
EEEEEEEEC''C'C'CEEEEEEEEEE
EEEEEEEEC3'''C'CEEEEEEEEEE
EEEEEEEECCCCCCCCEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE]]


build = ->
	with Dungeon(mapdata)
		.traps[] = with {9, 9}
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atæ²¼åœ°ã®æ´çªŸãƒ©ãƒ€ãƒˆãƒ¼ãƒ å´()
		.traps[] = with {9, 38}
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atæ²¼åœ°ã®æ´çªŸãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«å´()
		.traps[] = with {13, 23}
			.talk = =>
				if not lume.find(g_player.flags, L'æ²¼åœ°ã®æ´çªŸã®ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ãŸãŠã—ãŸ')
					with b = Battle(generateMonster 'ãƒ‰ãƒ©ã‚´ãƒ³')
						.detach = =>
							if .monster.hp <= 0 then g_player.flags[] = L'æ²¼åœ°ã®æ´çªŸã®ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ãŸãŠã—ãŸ'
							else g_player.y = 22 -- é€ƒã’ãŸã¨ãï¼‘ãƒã‚¹ä¸‹ãŒã‚‹
							Battle.__base.detach(b)
						\attach()
		.charactors[] = æ‰‰(14, 29, 'æ²¼åœ°ã®æ´çªŸã®ç‰¢å±‹ã®æ‰‰')
		if not lume.find(g_player.flags, L'ãƒ­ãƒ¼ãƒ©å§«ã‚’æ•‘å‡ºã—ãŸ') and not lume.find(g_player.items, L'ãŠã†ã˜ã‚‡ã®ã‚ã„')
			.charactors[] = with Charactor(14,27,{0x32}) -- ãƒ­ãƒ¼ãƒ©å§«
				.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
					coroutine.yield 1, L'ãƒ­ãƒ¼ãƒ©ã€Œã‚ã‚ï¼ã€€ãŸã™ã‘ã ã—ã¦ãã ã•ã‚‹\nã€€ã€€ã€€ã€€ã‹ãŸãŒã€€ã»ã‚“ã¨ã†ã«ã„ãŸãªã‚“ã¦\nã€€ã€€ã€€ã€€ã¾ã ã€€ã—ã‚“ã˜ã‚‰ã‚Œã¾ã›ã‚“ã‚ï¼ğŸ”»'
					coroutine.yield 1, L'\nãƒ­ãƒ¼ãƒ©ã€Œã‚ãŸã—ã¯ã€€ãƒ©ãƒ«ã‚¹ï¼‘ï¼–ã›ã„ã®\nã€€ã€€ã€€ã€€ã‚€ã™ã‚ã€€ãƒ­ãƒ¼ãƒ©ã§ã™ã€‚ğŸ”»'
					sb1 = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
					repeat
						coroutine.yield 1, L'\nãƒ­ãƒ¼ãƒ©ã€Œã‚ãŸã—ã‚’ã€€ãŠã—ã‚ã¾ã§\nã€€ã€€ã€€ã€€ã¤ã‚Œã¦ã‹ãˆã£ã¦ãã‚Œã¾ã™ã­ï¼Ÿ'
						sb1.index = 1
						coroutine.yield 1, sb1\attach()
					until sb1.index == 1
					coroutine.yield 1, L'\nã‚ãªãŸã¯ã€€ã²ã‚ã‚’ã€€ã ãã‹ã‹ãˆãŸã€‚'
					lume.remove(Scene.current.parent.charactors, @)
					g_player.chipids = {0x2e, 0x2f}
					g_player.flags[] = L'ãƒ­ãƒ¼ãƒ©å§«ã‚’æ•‘å‡ºã—ãŸ' -- ãŠã†ã˜ã‚‡ã®ã‚ã„ã¾ã§ã®ã¤ãªã
					BGM()
					play_wait'assets/sounds/mml2ogg/ãƒ­ãƒ¼ãƒ©å§«æ•‘å‡º.ogg'
					BGM Dungeon.BGM
					coroutine.yield 1, L'\nãƒ­ãƒ¼ãƒ©ã€Œã†ã‚Œã—ã‚…ã†ã”ã•ã„ã¾ã™ã€‚ã½ã£ğŸ”»'
					nil
				)})\attach()
		_monster = -> generateMonster lume.weightedchoice {ã‚´ãƒ¼ã‚¹ãƒˆ: 1, ã¾ã»ã†ã¤ã‹ã„: 1, ãŠãŠã•ãã‚Š: 1, ãƒ¡ãƒ¼ãƒ€: 2}
		.traps[] = with {}
			.check = (_)-> math.random() < 0.2
			.talk = => Battle(_monster())\attach()
		.ãã‚“ã®ãŸã¦ã”ã¨ = => Battle(_monster())\attach()
		.ãƒªãƒ¬ãƒŸãƒˆ = -> Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atæ²¼åœ°ã®æ´çªŸãƒ©ãƒ€ãƒˆãƒ¼ãƒ å´() -- å¿…ãšãƒ©ãƒ€ãƒˆãƒ¼ãƒ å´ã«å‡ºã‚‹ï¼Ÿ

export build_fromãƒ©ãƒ€ãƒˆãƒ¼ãƒ æ–¹é¢ = ->
	with build()
		g_player.x, g_player.y = 9, 9
		g_player.ãŸã„ã¾ã¤ = false
		BGM Dungeon.BGM

export build_fromãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«æ–¹é¢ = ->
	with build()
		g_player.x, g_player.y = 9, 38
		g_player.ãŸã„ã¾ã¤ = false
		BGM Dungeon.BGM

