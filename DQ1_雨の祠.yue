import 'macros' as {$}
import 'utl' as :L, :play--, :toZenkaku
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Castle, :g_player, :Charactor, :å®ç®±, :MessageBoxRetro
local *


mapdata = $to2d [[
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCC''''''''CCCCCCCC
CCCCCCCC''''''''''CCCCCCC
CCCCCCCC''CCCCCC''CCCCCCC
CCCCCCCC''C''C'C''CCCCCCC
CCCCCCCC''C'''''''CCCCCCC
CCCCCCCC''C''C'C''CCCCCCC
CCCCCCCC''CCCCCC''CCCCCCC
CCCCCCCC''''''''''CCCCCCC
CCCCCCCCC''''''''CCCCCCCC
CCCCCCCCCCCC3'CCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCC]]


export build = ->
	with Castle(mapdata)
		.traps[] = with {12, 16}
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_até›¨ã®ç¥ ()
		if lume.find(g_player.items, L'ã‚ã¾ãã‚‚ã®ã¤ãˆ') or lume.find(g_player.items, L'ã«ã˜ã®ã—ãšã')
			.charactors[] = with Charactor(12,11,{0x3a,0x3b}) -- è€äºº
				.talk = => MessageBoxRetro({ L'ï¼Šã€Œã“ã“ã«ã¯ã€€ã‚‚ã†ã€€ã‚ˆã†ãŒãªã„ã¯ãšã€‚\nã€€ã€€ã„ããŒã‚ˆã„ã€‚ğŸ”»' })\attach()
		elseif not lume.find(g_player.items, L'ã‚ã¾ãã‚‚ã®ã¤ãˆ')
			.charactors[] = with self = Charactor(12,11,{0x3a,0x3b}) -- è€äºº
				if not 'ãã‚“ã®ãŸã¦ã”ã¨' in g_player.items
					.talk = =>
						MessageBoxRetro({ L'ï¼Šã€ŒããªãŸãŒã€€ã¾ã“ã¨ã®ã€€ã‚†ã†ã—ã‚ƒã‹\nã©ã†ã‹ã€€ãŸã‚ã•ã›ã¦ã»ã—ã„ã€‚ğŸ”»', L'ï¼Šã€Œã“ã®ã¡ã®ã€€ã©ã“ã‹ã«ã€€ã¾ã‚‚ã®ãŸã¡ã‚’\nã‚ˆã³ã‚ˆã›ã‚‹ã€€ãã‚“ã®ãŸã¦ã”ã¨ãŒã€€ã‚ã‚‹ã¨ããã€‚ğŸ”»', L'ãã‚Œã‚’ã€€ã‚‚ã¡ã‹ãˆã£ãŸã¨ã\nããªãŸã‚’ã€€ã‚†ã†ã—ã‚ƒã¨ã€€ã¿ã¨ã‚\nã‚ã¾ãã‚‚ã®ã¤ãˆã‚’ã€€ã•ãšã‘ã‚ˆã†ã€‚ğŸ”»' })
				else
					.talk = => 
						MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
							coroutine.yield 1, L('ï¼Šã€ŒãŠãŠã€€%sï¼\nã€€ã€€ãŸã¦ã”ã¨ã‚’ã€€ã‚‚ã£ã¦ããŸãªï¼ğŸ”»')\format(g_player.name)
							coroutine.yield 1, L'\nï¼Šã€Œã‚ã—ã¯ã€€ã¾ã£ã¦ãŠã£ãŸã€‚\nã€€ã€€ããªãŸã®ã‚ˆã†ãªã€€ã‚ã‹ã‚‚ã®ãŒ\nã€€ã€€ã‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ã‚’â€¦ğŸ”»'
							coroutine.yield 1, L'\nï¼Šã€Œã•ã‚ã€€ãŸã‹ã‚‰ã®ã€€ã¯ã“ã‚’\nã€€ã€€ã¨ã‚‹ãŒã‚ˆã„ã€‚ğŸ”»'
							lume.remove(Scene.current.parent.charactors, @)
							nil
						)})\attach()
			.charactors[] = å®ç®±(11, 11, L'ã‚ã¾ãã‚‚ã®ã¤ãˆ') -- å®ç®±
		g_player.x, g_player.y = 12, 16
		BGM Castle.BGM


