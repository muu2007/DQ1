import 'macros' as {$}
import 'utl' as :L, :pos_in_box, :play
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Town, :Charactor, :g_player, :å®¿å±‹, :æ­¦å™¨å±‹, :ã‹ãå±‹, :å®ç®±, :æ‰‰, :MessageBoxRetro, :SelectBoxRetro
local *


mapdata = $to2d [[
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!PPPPPPPPPPPPPPP!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!PPP@@@""P!!!!!!!PPPP!!!!!!!!!!!!!!!!!!!
!!!!!!!!!)!!'@@"!!!!!"""!!!"PPPP!!!!!!!!!!!!!!!!
!!!!!!!!PP!!@@@!!!!''''''''""!!PPPP!!!!!!!!!!!!!
!!!!!!!!P"@@@@@!"!!'!"!'$$'!!!!!""P!!!!!!!!!!!!!
!!!!!!!!P"@@@@@!!CC'CCC'CC'!!CCCCCPP!!!!!!!!!!!!
!!!!!!!!P!@@@@@!!C'''C'''C'!!C'''CPP!!!!!!!!!!!!
!!!!!!!!P!@@@@@!!C'''C'''C'"!CCACC$P!!!!!!!!!!!!
!!!!!!!!P!!!!!!!!CCCCCCCCC'''''''C$P!!!!!!!!!!!!
!!!!!!!!P!!!!!!PP"!!!!!"!!'!IC'''C$P!!!!!!!!!!!!
!!!!!!!!P!"!PPPPPP!!!'''''''!C'''C$PP!!!!!!!!!!!
!!!!!!!!P$!PP"""PP!"''''''''!CCCCC"!P!!!!!!!!!!!
!!!!!!!!P$PP"!!"P!!'''!!!!''!!!!""""P!!!!!!!!!!!
!!!!!!!!P$$$"!"PP!'''!!"!!'''''''''')'!!!!!!!!!!
!!!!!!!!P$PP""PP!!''!!""!!'''''''''')'!!!!!!!!!!
!!!!!!!!P$!PPPP!!!''!""!CJ'!!""!!"""P!!!!!!!!!!!
!!!!!!!!P!"!!!!"!!''!!"CCC'CCCCCCC"!P!!!!!!!!!!!
!!!!!!!!P!!!!!"""!''!""C'A'C''C''C!PP!!!!!!!!!!!
!!!!!!!!P!@@@@@@@@''@!"CCC'''''''C!P!!!!!!!!!!!!
!!!!!!!!P!@@@@@@@@@@@!!C''''''C''C"P!!!!!!!!!!!!
!!!!!!!!P!@@@@@@@@@@@!"CC'CCC'CCCC"P!!!!!!!!!!!!
!!!!!!!!P!@@@@@@@@@@@!$C'''C''C''CPP!!!!!!!!!!!!
!!!!!!!!P"@@@@@@@@@@@!$C'''C'''''CP!!!!!!!!!!!!!
!!!!!!!!P"@@@@@@@@@@@!$CCCCCCCCCCCP!!!!!!!!!!!!!
!!!!!!!!PP@@@@@@@@@@@!$$$$"!!""PPPP!!!!!!!!!!!!!
!!!!!!!!!P@@@@@@@@@@@""!!"!!PPPP!!!!!!!!!!!!!!!!
!!!!!!!!!P@@@@@@@@@@@""""PPPP!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!PPPPPPPPPPPPPPP!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!]]

mapdataã‚ˆã’ã‚“ã˜ã‚‡ = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEE%%EEEEEEEE
EEEEEEEECCCCCCCC''CEEEEEEE
EEEEEEEEC'''''''''CEEEEEEE
EEEEEEEEC''''C''''CEEEEEEE
EEEEEEEECCC''C''''CEEEEEEE
EEEEEEEEC'A''''CC'CEEEEEEE
EEEEEEEECCC''C''''CEEEEEEE
EEEEEEEEC''''C''''CEEEEEEE
EEEEEEEEC'''''''''CEEEEEEE
EEEEEEEECCCCCCCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE]]

mapdataã‹ãå±‹ = $to2d [[
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEECCCEEEEEEE
EEEEEEEEE%''CEEEEEEE
EEEEEEEEE%''CEEEEEEE
EEEEEEEEC'''CEEEEEEE
EEEEEEEECCACCEEEEEEE
EEEEEEEEC'''CEEEEEEE
EEEEEEEECCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE]]


build = ->
	with Town(mapdata)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,30,30})
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout(->Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã®ç”º())
		.charactors[] = with Charactor(32,22,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€ŒãŠã„ã§ã€€ã¼ã†ã‚„\nã€€ã€€ã±ãµã±ãµã—ã¦ã»ã—ã„ãªã‚‰\nã€€ã€€ï¼•ï¼ã‚´ãƒ¼ãƒ«ãƒ‰ã‚ˆã€‚ğŸ”»' })\attach()
		.charactors[] = å®¿å±‹(24,26,55)
		.charactors[] = with Charactor(32,27,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L('ï¼Šã€Œã„ã‚ˆãŠã€€%sï¼\nã€€ã€€%sã˜ã‚ƒãªã„ã‹ï¼\nã€€ã€€ã²ã•ã—ã¶ã‚Šã ãªï¼ğŸ”»')\format(g_player.name, g_player.name) })\attach()
		.charactors[] = with Charactor(24,18,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã®ã€€ã¾ã¡ã¸\nã€€ã€€ã‚ˆã†ã“ãï¼ğŸ”»'})\attach()
		.charactors[] = with Charactor(17,24,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L('ï¼Šã€Œã†ã‚ã•ã§ã¯ã€€ãƒ©ãƒ€ãƒˆãƒ¼ãƒ ã®ãŠã—ã‚ã«\nã€€ã€€ãŸã„ã‚ˆã†ã®ã„ã—ãŒã€€ã‚ã‚‹ã‚‰ã—ã„ã€‚\nã€€ã€€ã‚‚ã†ã€€ã¦ã«ã„ã‚ŒãŸã‹ï¼ŸğŸ”»') })\attach()
		.charactors[] = æ‰‰(29, 29, L'ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã®å®¿å±‹ã®æ‰‰1')
		.charactors[] = with Charactor(28,31,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚ãŸã—ã¯ã€€ã‚ˆã—ã‚Šãƒ¼ã‚“ã€‚\nã€€ã€€ãƒã‚¤ãƒ©ã®ãŠãµã‚ã‹ã‚‰ã€€ã¿ãªã¿ã«ï¼”ã¤\nã€€ã€€ã‚ã‚‹ãã€€ã—ã‚‰ã¹ã‚‹ãŒã‚ˆã„ã€‚ğŸ”»'})\attach()
		.charactors[] = æ‰‰(30, 31, L'ãƒªãƒ ãƒ«ãƒ€ãƒ¼ãƒ«ã®å®¿å±‹ã®æ‰‰2')
		.charactors[] = å®ç®±(32,31,L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•')
		.traps[] = with {18, 27}
			.talk = => Scene.current = build_ã‚ˆã’ã‚“ã˜ã‚‡()
		.traps[] = with {19, 27}
			.talk = => Scene.current = build_ã‚ˆã’ã‚“ã˜ã‚‡()
		.charactors[] = with Charactor(14,21,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œãµã‚‹ã„ã€€ã„ã„ã¤ãŸãˆã§ã¯ ãƒ­ãƒˆã¯\nã€€ã€€ã“ã®ã—ã¾ã®ã€€ã«ã—ã®ã¯ãšã‚Œã«\nã€€ã€€ã«ã˜ã‚’ã‹ã‘ãŸãã†ã˜ã‚ƒã€‚ğŸ”»', L'\nï¼Šã€Œãã—ã¦ã€€ã¾ãŠã†ã®ã€€ã¸ã‚„ã®\nã€€ã€€ã‹ãã•ã‚ŒãŸã‚‹ã€€ã„ã‚Šãã¡ã‚ˆã‚Š\nã€€ã€€ã‚„ã¿ã«ã€€ã¯ã„ã£ãŸã¨ããã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(19,16,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€ŒãŠã¾ãˆãŒãƒ­ãƒˆã®ã¡ã‚’ã²ãã‚‚ã®ï¼Ÿ\nã€€ã€€ãªã«ã‹ã—ã‚‡ã†ã“ãŒã‚ã‚‹ã®ã‹ï¼ŸğŸ”»'})\attach()
		.charactors[] = with Charactor(23,16,{0x3c,0x3d}) -- å¥³ã®å­
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚ãªãŸã€€ã ã‚Œï¼Ÿ\nã€€ã€€ã§ã¦ã‚†ã‹ãªã„ã¨ã€€ã²ã¨ã‚’ã€€ã‚ˆã¶ã‚ã‚ˆã€‚ğŸ”»' })\attach()
		.charactors[] = æ­¦å™¨å±‹(31,15,{{L'ã©ã†ã®ã¤ã‚‹ã', 108}, {L'ã¦ã¤ã®ãŠã®', 560}, {L'ã¯ãŒã­ã®ã¤ã‚‹ã', 1500}, {L'ã¦ã¤ã®ã‚ˆã‚ã„', 1000}, {L'ã¯ãŒã­ã®ã‚ˆã‚ã„', 3000}, {L"ã¾ã»ã†ã®ã‚ˆã‚ã„", 7700} })
		.charactors[] = with Charactor(35,8,{0x40,0x41}) -- ç”·ã®å­
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã¡ã‚…ã‚“ã€€ã§ãƒ¼ã™ã€‚\nã€€ã€€ã‹ã®ã˜ã‚‡ã‚’ã€€ã¾ã£ã¦ã„ã¾ã™ã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(8,34,{0x3c,0x3d}) -- å¥³ã®å­
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚‚ã†ã€€ã¡ã‚…ã‚“ã•ã¾ã£ãŸã‚‰\nã€€ã€€ãŠãã„ã‚ã­ãˆã€‚ã·ã‚“ã·ã‚“ã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(10,12,{0x3e,0x3f}) -- å•†äºº
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ğŸ”»'})\attach()
		.traps[] = with {12, 11}
			.talk = => Scene.current = build_ã‹ãå±‹()

export build_fromå…¥å£ = ->
	with build()
		g_player.x, g_player.y = 37, 22
		BGM Town.BGM

build_fromã‚ˆã’ã‚“ã˜ã‚‡ = ->
	x = g_player.x
	with build()
		g_player.x, g_player.y = 18+x-16, 26

build_fromã‹ãå±‹ = ->
	y = g_player.y
	with build()
		g_player.x, g_player.y = 11, 11+y-9

build_ã‚ˆã’ã‚“ã˜ã‚‡ = ->
	x = g_player.x
	with Town(mapdataã‚ˆã’ã‚“ã˜ã‚‡)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,30,30})
			.talk = =>
				Scene.current = build_fromã‚ˆã’ã‚“ã˜ã‚‡()
		.charactors[] = with Charactor(9,12,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
				coroutine.yield 1, L'ï¼Šã€Œã“ã“ã¯ã€€ã‚ˆã’ã‚“ã˜ã‚‡\nã€€ã€€ã›ã„ãªã‚‹ã€€ã»ã“ã‚‰ã‚’ã¿ã¤ã‘ãŸã‹ï¼Ÿ'
				sb = SelectBoxRetro({L'ã¯ã„', L'ã„ã„ãˆ'})
				coroutine.yield 1, sb\attach()
				if sb.index == 1
					coroutine.yield 1, L'\nï¼Šã€Œã‚ã‚ã¨ã€€ãŸã„ã‚ˆã†ãŒã€€ã‚ã‚ã•ã‚‹\nã€€ã€€ã»ã“ã‚‰ã˜ã‚ƒã€‚ğŸ”»'
				else
					coroutine.yield 1, L'\nï¼Šã€Œã¿ãªã¿ã«ã€€ã‚†ããŒã‚ˆã„ã€‚ğŸ”»'
				nil
				)})\attach()
		.charactors[] = with Charactor(9,9,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚„ãŒã¦ã€€ã“ã®ã¾ã¡ã‚‚\nã€€ã€€ã¾ã‚‚ã®ãŸã¡ã«â€¦\nã€€ã€€ã‚ã‚ã€€ã‚«ãƒŸã•ã¾â€¦ğŸ”»' })\attach()
		.charactors[] = with Charactor(12,11,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã¿ãªã¿ã«ã€€ã„ã£ã¦ã¯ã€€ã„ã‘ã¾ã›ã‚“ã€‚\nã€€ã€€ã‚‚ã£ã¨ã‚‚ã£ã¨ã€€ã¤ã‚ˆã„ã¾ã‚‚ã®ãŒ\nã€€ã€€ã™ã‚“ã§ã„ã‚‹ã€€ãã†ã§ã™ã€‚ğŸ”»'})\attach()
		.charactors[] = with Charactor(15,15,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚Šã‚…ã†ãŠã†ã®ã€€ã‹ã‚‰ã ã‚’\nã€€ã€€ã¤ã‚‰ã¬ã‘ã‚‹ã€€ã¤ã‚‹ããŒ\nã€€ã€€ã“ã®ã‚ˆã«ã€€ã‚ã‚‹ã®ã ã‚ã†ã‹â€¦â€¦ğŸ”»' })\attach()
		g_player.x, g_player.y = 16+x-18, 8


build_ã‹ãå±‹ = ->
	with Town(mapdataã‹ãå±‹)
		.traps[] = with {9, 9}
			.talk = => Scene.current = build_fromã‹ãå±‹()
		.traps[] = with {9, 10}
			.talk = => Scene.current = build_fromã‹ãå±‹()
		.charactors[] = ã‹ãå±‹(10, 13, 53)
		g_player.x, g_player.y = 10, 9
