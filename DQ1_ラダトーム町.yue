import 'macros' as {$}
import 'utl' as :L, :pos_in_box, :play--, :toZenkaku
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Town, :g_player, :Charactor, :MessageBoxRetro, :å®¿å±‹, :æ­¦å™¨å±‹, :é“å…·å±‹, :ã›ã„ã™ã„å±‹, :æ‰‰
local *


_ = $mml2ogg([[
Tempo(115)
Track(1) q100 @8 o5 l8 ab->
cfedc^d<aã€€b-^^^r^gaã€€b->edcc<b-gb-ã€€a^b-^>c^de
f,50<b-16b-16b-,50>d,50f^edã€€c,50<a16a16a,50>c,50f^c<b-ã€€a^fag^>f^ã€€efdec^de
f,50<b-16b-16b-,50>d,50f^edã€€c,50<a16a16a,50>c,50f^c<b-ã€€ab-b>dc<b-agã€€a^,50g^,50f^,50
Track(2) q100 @8 v75 o4 l8 r^
fa>cf<f+a>cdã€€<gb->dg<f+>d<f>dã€€<e>c<b->c<<b>gegã€€f>c<g>c<a>db->c
d,50<<f16f16f,50b-,50>d^>c<b-ã€€<c,50f16f16f,50a,50>c^r^ã€€<b^>d^<b^>cdã€€c^d^e^b->c
d,50<<f16f16f,50b-,50>d^>c<b-ã€€<c,50f16f16f,50a,50>c^r^ã€€<fga-b>cc+def^,50c^,50<a^,50
]], town, 25.043) --60/115 *4 *12


mapdata = $to2d [[
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!CCCCCCCCCCCCC$''$CCCCCCCCCCCCC!!!!!!!!!!
!!!!!!!!C"""!!!!!!!!$$''$$"""""""""""C!!!!!!!!!!
!!!!!!!!C""!!!!!!!!!!$''$!!"@@@@@@@@"C!!!!!!!!!!
!!!!!!!!C"!CCCCC!!!!!!''!!!"@@@@@@@@"C!!!!!!!!!!
!!!!!!!!C"!C'''C!!!!!!''$!!!@@@@@@@@"C!!!!!!!!!!
!!!!!!!!C"!C'A'C!!!!!!''$$"!@@@@@@@@"C!!!!!!!!!!
!!!!!!!!C"!CC'CC!!$$!!''$!"!@'@@@@@@!C!!!!!!!!!!
!!!!!!!!C"!!!'I!!$$$$!''!!"!!!!"!!"!!C!!!!!!!!!!
!!!!!!!!C""!!'!!$$"$$!''!!!!!!""""""!C!!!!!!!!!!
!!!!!!!!C"!!!'!!$"""$$''!!CCCCCCCCC"!C!!!!!!!!!!
!!!!!!!!C"!!!'!$$$"""$''!!C'''C'''C!!C!!!!!!!!!!
!!!!!!!!C!!!!'!$$"""$!''!!C'''C'''C!!C!!!!!!!!!!
!!!!!!!!C""!!'!!$$$$$!''!!CC'CCC'CC!"C!!!!!!!!!!
!!!!!!!!""!!!'!!!!$$!!''!!!!'!!!'!!!""!!!!!!!!!!
!!!!!!!!''''''''''''''''''''''''''''''!!!!!!!!!!
!!!!!!!!''''''''''''''''''''''''''''''!!!!!!!!!!
!!!!!!!!""!!!!!!'!!!!"!'!!!"!!!!!PPP""!!!!!!!!!!
!!!!!!!!C""!!!!!'!!!""!'!""""!PPPPPPP"!!!!!!!!!!
!!!!!!!!C"!!!!!!'!!""!!'"""!!PPPPPPPPP!!!!!!!!!!
!!!!!!!!C!!!!!CJ'C!!!!!'!"!!PPPPPPPPPP!!!!!!!!!!
!!!!!!!!C!CCCCCC'CCC!!!'"!!PPPP!!PPPPP!!!!!!!!!!
!!!!!!!!C!C''C'''A'C!!!'!!PP!!!!!!!PPP!!!!!!!!!!
!!!!!!!!C!C''C'CCCCC!!!''')!!!!!!!!!!P!!!!!!!!!!
!!!!!!!!C!C''''''''C!!!!!!P!!@'@@@@"!P!!!!!!!!!!
!!!!!!!!C!C'CC'CC''C!!!!!PP!!@@@@@@"!P!!!!!!!!!!
!!!!!!!!C!C''C''C''C!!!!!PPP!@@@@@@!PP!!!!!!!!!!
!!!!!!!!C!C''C''C''C!!!!!PP!!@@@@@@!"P!!!!!!!!!!
!!!!!!!!C!CCCCCCCCCC!!!!PPPP!@@@@@@""P!!!!!!!!!!
!!!!!!!!C!!!!!!!!!!!!!!PPPPP!!!!!PP"PP!!!!!!!!!!
!!!!!!!!CCCCCCCCCCCCCCCCCCCCPPPPPPPPPP!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!]]


mapdataé“å…·å±‹ = $to2d [[
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEE%EEEEEEEEEEE
EEEEEEEEC'CCCCEEEEEEE
EEEEEEEEC''C'CEEEEEEE
EEEEEEEEC''A'CEEEEEEE
EEEEEEEEC''C'CEEEEEEE
EEEEEEEECCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEE]]

mapdataã›ã„ã™ã„å±‹ = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEECCCCCCCCCEEEEEEE
EEEEEEEEC'''C'PPCEEEEEEE
EEEEEEEEC'''A'PPCEEEEEEE
EEEEEEEEC'''C'PPCEEEEEEE
EEEEEEEEC'CCCCCCCEEEEEEE
EEEEEEEEE%EEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEE]]


build = ->
	with Town(mapdata)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,9,30,30})
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout(->Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atãƒ©ãƒ€ãƒˆãƒ¼ãƒ ç”º())
		.charactors[] = with Charactor(9,22,{0x40,0x41}) -- ç”·ã®å­
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œãƒ©ãƒ€ãƒˆãƒ¼ãƒ ã®ã¾ã¡ã¸ã€€ã‚ˆã†ã“ãã€‚ğŸ”»"})\attach()
		.charactors[] = with Charactor(12,16,{0x3c,0x3d}) -- å¥³ã®å­
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚\nã€€ã€€ãªã‹ã«ã™ã™ã¿ã€€ã¤ããˆã€€ã”ã—ã«\nã€€ã€€ã¯ãªã—ã‹ã‘ã¦ãã ã•ã„ãªã€‚ğŸ”»" })\attach()
		.charactors[] = æ­¦å™¨å±‹(13, 13, {{L"ãŸã‘ã–ãŠ", 10}, {L"ã“ã‚“ã¼ã†", 60}, {L"ã©ã†ã®ã¤ã‚‹ã", 180}, {L"ã¬ã®ã®ãµã", 20}, {L"ã‹ã‚ã®ãµã", 70}, {L"ã‹ã‚ã®ãŸã¦", 90} })
		.charactors[] = with Charactor(19,19,{0x40,0x41}) -- ç”·ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã“ã®ã¾ã¡ã®ã€€ãšã£ã¨ã€€ããŸã«ã„ã\nã€€ã€€ã†ã¿ã¹ã‚’ã€€ã«ã—ã«ã‚ã‚‹ãã¨\nã€€ã€€ã‚¬ãƒ©ã‚¤ã®ã¾ã¡ãŒã€€ã‚ã‚‹ãã†ã§ã™ã€‚ğŸ”»"})\attach()
		.charactors[] = with Charactor(23,16,{0x3e,0x3f}) -- å•†äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã©ã†ã‹ã€€ã¾ã‚‚ã®ãŸã¡ã‚’\nã€€ã€€ãŸãŠã—ã¦ã€€ãã ã•ã„ã€‚ğŸ”»"})\attach()
		.charactors[] = with Charactor(17,13,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã©ãã®ã¬ã¾ã¡ã«ã€€ãã‚’ã¤ã‘ãªã•ã‚Œã€‚\nã€€ã€€ã¬ã¾ã¡ã‚’ã€€ã‚ã‚‹ãã¨ãã¯\nã€€ã€€ãŸã„ã‚Šã‚‡ãã«ã€€ãã‚’ã¤ã‹ã†ã‚ˆã†ã«ãªğŸ”»"})\attach()
		.charactors[] = æ‰‰(29, 15, 'ãƒ©ãƒ€ãƒˆãƒ¼ãƒ ç”ºã›ã„ã™ã„å±‹ã®æ‰‰')
		.traps[] = with {29, 15}
			.talk = => Scene.current = build_ã›ã„ã™ã„å±‹()
		.charactors[] = with Charactor(36,10,{0x38,0x39}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã¯ã—ã«ã€€ãã‚’ã¤ã‘ã‚ï¼ğŸ”»\n", "ï¼Šã€Œã¯ã—ã‚’ã‚ãŸã£ã¦ã€€ã¨ãŠãã«ã„ãã»ã©\nã€€ã€€ãŠãã‚ã—ã„ã€€ã¾ã‚‚ã®ãŸã¡ãŒ\nã€€ã€€ã‚ã‚‰ã‚ã‚Œã‚‹ã ã‚ã†ã€‚ğŸ”»"})\attach()
		.charactors[] = with Charactor(14,26,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŠãŠãã®ã‚†ã†ã—ã‚ƒãŒ\nã€€ã€€ã¾ã¡ã‹ã‚‰ã€€ã¨ãŠãã«ã€€ãŸã³ã«ã§ã¦\nã€€ã€€ãã—ã¦ã€€ã—ã‚“ã ã€‚ğŸ”»\n", L("ï¼Šã€Œã‚†ã†ã—ã‚ƒã€€%sã‚ˆ\nã€€ã€€ãŠã¾ãˆã‚’ã€€ã—ãªã›ãŸããªã„ã‚‚ã®ã ãªğŸ”»")\format(g_player.name)})\attach()
		.charactors[] = with Charactor(24,28,{0x38,0x39}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŠã¾ãˆãŒãƒ­ãƒˆã®ã¡ã‚’ã²ãã‚‚ã®ï¼Ÿ\nã€€ã€€ãªã«ã‹ã—ã‚‡ã†ã“ãŒã‚ã‚‹ã®ã‹ï¼ŸğŸ”»"})\attach()
		.charactors[] = with Charactor(23,32,{0x3c,0x3d}) -- å¥³æ€§
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã„ãƒ¼ãˆã€€ã‚ãŸã—ã¯\nã€€ã€€ãƒ­ãƒ¼ãƒ©ã²ã‚ã˜ã‚ƒãªã„ã‚ã€‚ğŸ”»"})\attach()
		.charactors[] = å®¿å±‹(18, 30, 6)
		.charactors[] = with Charactor(18,35,{0x34,0x35}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŠã†ã•ã¾ã«ã€€ã¤ãŸãˆã¦ãã‚Œ\nã€€ã€€ãƒ­ãƒ¼ãƒ©ã²ã‚ã®ã€€ãã†ã•ããŸã„ã¯\nã€€ã€€ãœã‚“ã‚ã¤ã—ãŸã¨â€¦ğŸ”»\n", L"ï¼Šã€Œã‚ãŸã—ã‚‚ã€€ã‚‚ã†ã€€ã ã‚ã â€¦\nã€€ã€€ãã¶â€¦ğŸ”»"})\attach()
		.charactors[] = with Charactor(13,32,{0x11}) -- æ‰‰
			.talk = =>
		.charactors[] = with Charactor(12,35,{0x38,0x39}) -- æˆ¦å£«
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŠã¾ãˆãŒãƒ­ãƒˆã®ã¡ã‚’ã²ãã‚‚ã®ï¼Ÿ\nã€€ã€€ãªã«ã‹ã—ã‚‡ã†ã“ãŒã‚ã‚‹ã®ã‹ï¼ŸğŸ”»"})\attach() --[ ] todo:ã¾ã¨ã‚ã‚‰ã‚Œãªã„ã‹ï¼Ÿ
		.charactors[] = with Charactor(28,32,{0x40,0x41}) -- ç”·ã®å­
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œãã“ã®ã€€ã¸ã“ã‚“ã ã“ã¨ã‚ã‹ã‚‰\nã€€ã€€ãªã‹ã¸ã€€ã™ã™ã‚“ã§ãã ã•ã„ã€‚ğŸ”»"})\attach()
		.charactors[] = with Charactor(31,30,{0x40,0x41}) -- ç”·ã®å­
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œãƒ©ãƒ€ãƒˆãƒ¼ãƒ ã®ãŠã—ã‚ã®ã¿ãªã¿ã‹ã‚‰\nã€€ã€€ã†ã¿ã®ã‚€ã“ã†ã«ã€€ãŠã—ã‚ãŒ\nã€€ã€€ã¿ãˆã‚‹ã§ã—ã‚‡ã†ã€‚ğŸ”»\n"
				L"ï¼Šã€Œã‚Šã‚…ã†ãŠã†ã¯ã€€ãã®ã—ã‚ã«\nã€€ã€€ã„ã‚‹ã¨ã‹â€¦ã€‚ãŠãŠã€€ã“ã‚ã„â€¦ã€‚ğŸ”»\n"})\attach()
		.traps[] = with {30, 32}
			.talk = => Scene.current = build_é“å…·å±‹()
		.charactors[] = with Charactor(32,19,{0x3a,0x3b}) -- å‘ªã„ã‚’è§£ãè€äºº
			.talk = =>
				if not lume.find(g_player.flags, L'å‘ªã„')
					MessageBoxRetro({ L"ï¼Šã€Œã‚‚ã—ã€€ããªãŸãŒã€€ã®ã‚ã‚ã‚ŒãŸãªã‚‰\nã€€ã€€ã“ã“ã«ã€€ãã‚‹ãŒã‚ˆã„ã€‚ğŸ”»" })\attach()
				else
					lume.remove(g_player.flags, L'å‘ªã„')
					MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
						coroutine.yield 1, L"ï¼Šã€Œã®ã‚ã„ã‚’ã€€ã¨ã„ã¦ã€€ã—ã‚“ãœã‚ˆã†ã€‚"
						Scene.current.overlapping_color = {1,1,1,0.6}
						s = play'assets/sounds/mml2ogg/å‘ªæ–‡.ogg'
						while s\isPlaying()
							Scene.current.overlapping_color[4] = lume.smooth(0, 0.6, 1 - s\tell() / s\getDuration())
							coroutine.yield 1
						Scene.current.overlapping_color = {0,0,0,0}
						coroutine.yield 1, "ğŸ”»"
						nil
					)})\attach()
		.charactors[] = with Charactor(28,19,{0x40,0x41}) -- ç”·ã®å­
			.talk = => MessageBoxRetro({ L"ï¼Šã€Œã†ã‚ã•ã§ã¯ã€€ã©ã“ã‹ã«ã€€ã¾ã»ã†ã®\nã€€ã€€ã‚«ã‚®ã‚’ã†ã£ã¦ã„ã‚‹ã€€ã¾ã¡ãŒ\nã€€ã€€ã‚ã‚‹ã‚‰ã—ã„ã§ã™ã‚ˆã€‚ğŸ”»" })\attach()
		.charactors[] = with Charactor(31,24,{0x34,0x35}) -- å…µå£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L"ï¼Šã€ŒãŸãŸã‹ã„ã§ã€€ã‘ã„ã‘ã‚“ã‚’ã€€ã¤ã¿\nã€€ã€€ãƒ¬ãƒ™ãƒ«ãŒã€€ã‚ãŒã£ãŸã¨ãã¯\nã€€ã€€ãŠã†ã•ã¾ã«ã€€ã‚ã„ã«ã€€ã„ã‘ã‚ˆã€‚ğŸ”»" })\attach()


export build_fromåŒ—å£ = ->
	with build()
		g_player.x, g_player.y = 23, 9
		BGM Town.BGM --å±‹æ ¹ã®æœ‰ã‚‹ã¨ã“ã‚ã«å‡ºå…¥ã‚Šã™ã‚‹æ™‚ã¯BGMã‚’ã‹ã‘ç›´ã•ãªã„ãŸã‚ã€å¤–ã‹ã‚‰ã®ã¨ãã¯æ‰‹å‹•ã§æ›ã‘ã‚‹

export build_fromè¥¿å£ = ->
	with build()
		g_player.x, g_player.y = 8, 24
		BGM Town.BGM

export build_fromæ±å£ = ->
	with build()
		g_player.x, g_player.y = 37, 24
		BGM Town.BGM

build_é“å…·å±‹ = ->
	with Town(mapdataé“å…·å±‹)
		.charactors[] = é“å…·å±‹(12, 10, {{L"ã‚„ããã†", 24}, {L"ãŸã„ã¾ã¤", 8}, {L"ã‚Šã‚…ã†ã®ã†ã‚ã“", 20} })
		.traps[] = with {9, 7}
			.talk = => Scene.current = build_fromé“å…·å±‹()
		g_player.x, g_player.y = 9, 8

build_fromé“å…·å±‹ = ->
	with build()
		g_player.x, g_player.y = 30, 31

build_ã›ã„ã™ã„å±‹ = ->
	with Town(mapdataã›ã„ã™ã„å±‹)
		.charactors[] = ã›ã„ã™ã„å±‹(13, 10, 38)
		.traps[] = with {9, 13}
			.talk = => Scene.current = build_fromã›ã„ã™ã„å±‹()
		g_player.x, g_player.y = 9, 12

build_fromã›ã„ã™ã„å±‹ = ->
	with build()
		g_player.x, g_player.y = 29, 16
