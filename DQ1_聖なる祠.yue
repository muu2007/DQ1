import 'macros' as {$}
import 'utl' as :L, :play--, :toZenkaku
-- import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Castle, :Charactor, :g_player, :MessageBoxRetro
local *


mapdata = $to2d [[
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEECCCCCCCCCCCEEEEEEE
EEEEEEEEC'''''''''CEEEEEEE
EEEEEEEEC''C'C'C''CEEEEEEE
EEEEEEEEC'CC'''CC'CEEEEEEE
EEEEEEEEC'''CCC'''CEEEEEEE
EEEEEEEE3'C'C'C'C'CEEEEEEE
EEEEEEEE''C''FC'C'CEEEEEEE
EEEEEEEEC'''CCC'''CEEEEEEE
EEEEEEEEC'CC'''CC'CEEEEEEE
EEEEEEEEC''C'C'C''CEEEEEEE
EEEEEEEEC'''''''''CEEEEEEE
EEEEEEEECCCCCCCCCCCEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEEEEEEEE]]


export build = ->
	with Castle(mapdata)
		.traps[] = with {8, 12}
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atè–ãªã‚‹ç¥ ()
		.charactors[] = with Charactor(12,13,{0x3a,0x3b}) -- è€äºº
			unless 'ãƒ­ãƒˆã®ã—ã‚‹ã—' in g_player.items -- todo ã‚‚ã‚‰ã£ãŸã‚ã¨
				.talk = =>
					MessageBoxRetro({<index>: coroutine.wrap((_, _)->
						coroutine.yield 1, L'ï¼Šã€ŒããªãŸãŒã€€ãƒ­ãƒˆã®ã¡ã‚’ã²ã\nã¾ã“ã¨ã®ã€€ã‚†ã†ã—ã‚ƒãªã‚‰\nã—ã‚‹ã—ãŒã€€ã‚ã‚‹ã¯ãšğŸ”»'
						coroutine.yield 1, L'\nï¼Šã€ŒãŠã‚ã‹ã‚‚ã®ã‚ˆï¼ã€€ãŸã¡ã•ã‚Œã„ï¼ğŸ”»'
						Scene.current.parent\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atè–ãªã‚‹ç¥ ()
						nil )})\attach()
			else
				.talk = =>
					MessageBoxRetro({ L'ï¼Šã€Œãƒ­ãƒˆã®ã€€ã¡ã‚’ã²ãã‚‚ã®ã‚ˆã€‚\nã€€ã€€ã„ã¾ã“ãã€€ã‚ã‚ã¨ã€€ãŸã„ã‚ˆã†ãŒ\nã€€ã€€ã‚ã‚ã•ã‚‹ã¨ãã˜ã‚ƒï¼ğŸ”»\nï¼Šã€ŒããªãŸã«ã€€ã«ã˜ã®ã—ãšãã‚’\nã€€ã€€ã‚ãŸãˆã‚ˆã†ï¼ğŸ”»' })\attach()
					lume.remove(g_player.items, L'ãŸã„ã‚ˆã†ã®ã„ã—')
					lume.remove(g_player.items, L'ã‚ã¾ãã‚‚ã®ã¤ãˆ')
					g_player.items[] = L'ã«ã˜ã®ã—ãšã'

		g_player.x, g_player.y = 8, 12
		BGM Castle.BGM


