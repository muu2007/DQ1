import 'macros' as {$}
import 'utl' as :L, :pos_in_box, :play
import 'lib.lume'
import 'ui' as :Scene, :BGM
import 'main' as :Town, :Charactor, :g_player, :å®¿å±‹, :æ­¦å™¨å±‹, :é“å…·å±‹, :ã‹ãå±‹, :ã›ã„ã™ã„å±‹, :æ‰‰, :MessageBoxRetro, :SelectBoxRetro
local *


mapdata = $to2d [[
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''CCC''CCCCCCCC''I$$$$$$$$'CCC''''''''
''''''''C''''C''C'''C''$$CCCCCC$'C'C''''''''
''''''''CCC''C''C'''C''""C''C'C$'C'C''''''''
'''''''''''''CCAC'CCC'''''''A'C$''''''''''''
'''''''''''''C''''''C'''''''A'C$'CCC''''''''
''''''''CCC''CC'CC''C''""C''C'C$'C'C''''''''
''''''''C'A''$J$$C''C''$$CCCCCC$'CAC''''''''
''''''''CCC''$$$$CCCC''$$$$$$$$$'C'C''''''''
'''''''''''''''''''''''''''''''''''C''''''''
''''''''''''''''''''''''''''''''CC'C''''''''
''''''''CCC''CCC''.@@@....''CCCCC''C''''''''
''''''''C'A''A'C''@@@@@@@.''C'C'A''C''''''''
''''''''CCC''CCC''@@@@@@@.''A'C'C''C''''''''
''''''''C'A'''''''.@@@@@@.''CCCCCCCC''''''''
''''''''CCC'CCCC''.@@@@@@.''''''''''''''''''
''''''''C'''C''C''.@@@@@@.''''''''''''''''''
''''''''C''''''C''.@@@@@@.''CCC''CCC''''''''
''''''''CCCCCCCC''.@@@@@@@''A'C''''C''''''''
''''''''''''''''''.@@@@@@@''CCC''C'C''''''''
''''''''''''''''''.@@@@@@@'''''''CCC''''''''
''''''''CCC'CCCC''.@@@@@@.''CCC'''''''''''''
''''''''C''''''C''.@@@@@@.''C'CCCC'C''''''''
''''''''C''''''C''...@@...''CAC''''C''''''''
''''''''CCCCC''C'''C''''C'''C'CC'CCC''''''''
''''''''C'''C''''CCCC''CCCC'''C''CFC''''''''
''''''''C'''A''C'C--------C'C''''A'C''''''''
''''''''CF''C''C'C-CCCCCC-C'C'C''CFC''''''''
''''''''CCCCCCCC'C---''---C'CCCCCCCC''''''''
'''''''''''''''''CCCCCCCCCC'''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''
'''''''''''''''''''''''''''''''''''''''''''']]


export build = ->
	with Town(mapdata)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,28,28})
			.talk = =>
				play'assets/DQ1/éšæ®µ.ogg'
				Scene.current\blackout -> Scene.current = require('DQ1_å…¨ä½“ãƒãƒƒãƒ—').build_atãƒ¡ãƒ«ã‚­ãƒ‰ã®ç”º()
		.traps[] = with {}
			.check = (player)-> pos_in_box({player.x, player.y}, {18,18,8,13})
			.talk = =>
				Scene.current = build_å…¬åœ’()
		.charactors[] = with Charactor(22,13,{0x34,0x35}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã˜ã‚‡ã†ã•ã„ã®ã¾ã¡\nã€€ã€€ãƒ¡ãƒ«ã‚­ãƒ‰ã¸ã€€ã‚ˆã†ã“ãï¼ğŸ”»' })\attach()
		.charactors[] = æ­¦å™¨å±‹(29, 12, {{L'ãŸã‘ã–ãŠ', 10}, {L'ã“ã‚“ã¼ã†', 60}, {L'ã©ã†ã®ã¤ã‚‹ã', 180}, {L'ã‹ã‚ã®ãµã', 70}, {L'ãã•ã‚Šã‹ãŸã³ã‚‰', 300}, {L"ã¦ã¤ã®ãŸã¦", 800} })
		.charactors[] = å®¿å±‹(15, 10, 100)
		.charactors[] = with é“å…·å±‹(9,14,{{L"ã‚„ããã†", 24}, {L"ãŸã„ã¾ã¤", 8} })
			.chipids = {0x40,0x41} -- ç”·ã®å­
		.charactors[] = with Charactor(12,11,{0x34,0x35}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ <index>: coroutine.wrap((_, _)->
				coroutine.yield 1, L'ï¼Šã€Œã‚Šã‚…ã†ãŠã†ã®ã€€ã¤ã‚ã¯ã€€ã¦ã¤ã‚’\nã€€ã€€ã²ãã•ãã€€ãã—ã¦ã€€ã¯ãã€€ã»ã®ãŠã¯\nã€€ã€€ã„ã‚ã‚’ã‚‚ã€€ã¨ã‹ã™ã¨ã„ã†ã€‚ğŸ”»'
				coroutine.yield 1, L('\nï¼Šã€Œ%sã‚ˆã€€ãã‚Œã§ã‚‚ã€€ã‚†ãã‹ï¼Ÿ')\format(g_player.name)
				sb = SelectBox({'ã¯ã„', 'ã„ã„ãˆ'}) -- todo ã„ã„ãˆå´ã®ã›ã‚ŠãµãŒã‚ã‹ã‚‰ãªã„
				coroutine.yield 1, sb\attach()
				if sb.index == 1
					coroutine.yield 1, L'\nï¼Šã€ŒãŠãŠï¼ã€€ã‚ãªãŸã“ã\nã€€ã€€ã¾ã“ã¨ã®ã€€ã‚†ã†ã—ã‚ƒã ï¼ğŸ”»'
				else
					coroutine.yield 1, L'\nï¼Šã€Œãã‚ŒãŒã„ã„\nã€€ã€€ã ã‚Œã‚‚ã€€ãŠã¾ãˆã‚’ã€€ãŠãã³ã‚‡ã†ã¨ã¯\nã€€ã€€ã„ã‚ãªã„ã ã‚ã†ã€‚ğŸ”»'
				nil
			)})\attach()
		.charactors[] = with Charactor(30,16,{0x34,0x35}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã†ã‚ã•ã§ã¯ã€€ãƒ­ãƒˆã®ã‚ˆã‚ã„ã¯\nã€€ã€€ã²ã¨ã‹ã‚‰ã€€ã²ã¨ã¸ã€‚ğŸ”»', L'\nã‚†ãã®ãµã€€ã¨ã„ã†ãŠã¨ã“ã®ã€€ã¦ã«\nã€€ã€€ã‚ãŸã£ãŸãã†ã ã€‚ğŸ”»' })\attach()
		.charactors[] = æ‰‰(33,16, 'ãƒ¡ãƒ«ã‚­ãƒ‰ã®å¼·ã„æ­¦å™¨å±‹ã‹ãå±‹ã®æ‰‰')
		.charactors[] = ã‹ãå±‹(34,13,98)
		.charactors[] = æ­¦å™¨å±‹(31,19,{{L'ã»ã®ãŠã®ã¤ã‚‹ã', 9800}, {L'ã¿ã‹ãŒã¿ã®ãŸã¦', 14800} })
		.charactors[] = with Charactor(31,27,{0x3e,0x3f}) -- æˆ¦å£«
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚€ã‹ã—ã€€ã†ã¡ã®ã˜ã„ã•ã‚“ãŒã€€ã‚ˆã\nã€€ã€€ã„ã£ã¦ã¾ã—ãŸã€‚ğŸ”»', L'\nã¨ã‚‚ã ã¡ã®ã€€ã‚†ãã®ãµã¯\nã€€ã€€ã˜ã¶ã‚“ã®ã¿ã›ã®ã€€ã†ã‚‰ã®ã€€ãã«\nã€€ã€€ãªã«ã‹ã€€ã†ã‚ãŸã‚‰ã—ã„ã¨â€¦ğŸ”»' })\attach()
		.charactors[] = æ­¦å™¨å±‹(34,33,{{L'ã¦ã¤ã®ãŠã®', 560}, {L'ã¯ãŒã­ã®ã¤ã‚‹ã', 1500}, {L'ã¯ãŒã­ã®ã‚ˆã‚ã„', 3000}, {L'ã¾ã»ã†ã®ã‚ˆã‚ã„', 7700} })
		.charactors[] = é“å…·å±‹(14,19,{{L'ã‚Šã‚…ã†ã®ã†ã‚ã“', 20}, {L'ã‚­ãƒ¡ãƒ©ã®ã¤ã°ã•', 70} })
		.charactors[] = with Charactor(9,19,{0x3e,0x3f}) -- å•†äºº
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã¾ã„ã©ï¼\nã€€ã€€ãã‚‡ã†ã¯ã€€ã ã„ã“ã‚“ãŒã€€ã‚„ã™ã„ã‚ˆï¼ğŸ”»' })\attach()
		.charactors[] = with Charactor(13,21,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã“ã‚“ã‚„ã®ã€€ãŠã‹ãšã¯\nã€€ã€€ãªã‚“ã«ã€€ã—ã‚ˆã†ã‹ã—ã‚‰â€¦â€¦ğŸ”»' })\attach()
		.charactors[] = with Charactor(16,21,{0x3c,0x3d}) -- å¥³ã®å­
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã­ãˆã€€ã‚ãŸã—ã®ã€€ã½ãƒ¼ã¨ã´ã‚ã¨\nã€€ã€€ã‚ãªãŸã®ã€€ãƒ‰ãƒ©ã‚´ãƒ³ããˆã™ã¨ã‚’\nã€€ã€€ã‹ãˆã£ã“ã—ã¦ã‚ˆã€‚ğŸ”»' })\attach()
		.charactors[] = æ‰‰(11,28, 'ãƒ¡ãƒ«ã‚­ãƒ‰ã®å—è¥¿ã®æ‰‰1')
		.charactors[] = æ‰‰(15,32, 'ãƒ¡ãƒ«ã‚­ãƒ‰ã®å—è¥¿ã®æ‰‰2')
		.charactors[] = with Charactor(11,33,{0x3e,0x3f}) -- å•†äºº
			.talk = => MessageBoxRetro({
				L'ï¼Šã€Œã‚ãŸã—ã®ã€€ã„ãˆã¯ã€€ãã®ã‚€ã‹ã—\nã€€ã€€ãƒ‰ãƒ ãƒ‰ãƒ¼ãƒ©ã®ã¾ã¡ã§ã€€ã¿ã›ã‚„ã‚’\nã€€ã€€ã—ã¦ã„ãŸã¨ã‹ã€‚ğŸ”»'
				L'ï¼Šã€Œã¿ã›ã¯ã€€ã€€ã¾ã¡ã®ã²ãŒã—ã«ã€€ã‚ã‚Š\nã€€ã€€ã‚†ãã®ãµã˜ã„ã•ã‚“ã®ã¨ã\nã€€ã€€ã¾ã¡ãŒã€€ã¾ã‚‚ã®ãŸã¡ã«ã€€ãŠãã‚ã‚Œâ€¦â€¦ğŸ”»'
				L'ï¼Šã€Œã“ã®ã¾ã¡ã¾ã§ã€€ã«ã’ã¦ãã¾ã—ãŸã€‚ğŸ”»'
			})\attach()
		.charactors[] = with Charactor(27,26,{0x40,0x41}) -- å•†äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œãˆãƒ¼ã‚“ã€‚ã€€ã‚ã¦ãŒã€€ã¾ã„ã”ã®\nã€€ã€€ã‚­ãƒ ã“ã†ã€€ã ã™ã€‚ğŸ”»' })\attach()
		.charactors[] = with Charactor(26,29,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œãµã‚‹ã„ã€€ã„ã„ã¤ãŸãˆã§ã¯\nã€€ã€€ã‚†ã†ã—ã‚ƒãƒ­ãƒˆã®ã¤ã‹ã£ãŸã€€ã¤ã‚‹ãã¯\nã€€ã€€ã¯ãŒã­ã‚’ã‚‚ã€€ãã ã„ãŸãã†ã˜ã‚ƒã€‚ğŸ”»' })\attach()
		.charactors[] = ã›ã„ã™ã„å±‹(29,20,38)
		.charactors[] = æ‰‰(21,32, 'ãƒ¡ãƒ«ã‚­ãƒ‰ã®ç¥æ®¿ã®æ‰‰1')
		.charactors[] = æ‰‰(22,32, 'ãƒ¡ãƒ«ã‚­ãƒ‰ã®ç¥æ®¿ã®æ‰‰2')
		.charactors[] = with Charactor(21,35,{0x3a,0x3b}) -- è€äºº
			.update = coroutine.wrap(._update_randomwalk)
			.talk = => MessageBoxRetro({ L'ï¼Šã€Œã‚†ã†ã—ã‚ƒã®ãŸã‚ã€€ã„ã®ã‚Šã¾ã—ã‚‡ã†ã€‚ğŸ”»', L'\nï¼Šã€Œã²ã‹ã‚ŠãŒã€€ããªãŸã¨ã€€ã¨ã‚‚ã«\nã€€ã€€ã‚ã‚Šã¾ã™ã‚ˆã†ã«â€¦ğŸ”»', L'\nï¼Šã€Œã‚†ããŒã‚ˆã„ã€‚\nã€€ã€€ãã—ã¦ã€€ã•ãŒã™ãŒã‚ˆã„ã€‚ğŸ”»', L'\nï¼Šã€Œãƒ©ãƒ€ãƒˆãƒ¼ãƒ ã®ã€€ãŠã—ã‚ã¾ã§\nã€€ã€€ããŸã«ï¼—ï¼”ã€€ã«ã—ã«ï¼”ï¼ã®\nã€€ã€€ãã®ã°ã—ã‚‡ã‚’ï¼ğŸ”»'})\attach()

export build_fromå…¥å£ = ->
	with build()
		g_player.x, g_player.y = 22, 8
		BGM Town.BGM

build_fromå…¬åœ’ = ->
	with self = build()
		g_player.x, g_player.y = 18+g_player.x-8, 18+g_player.y-8


mapdataå…¬åœ’ = $to2d[[
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%!PPP!!!!%%%%%%%%
%%%%%%%%PPPPP!!!%%%%%%%%
%%%%%%%%PP"PPP!!%%%%%%%%
%%%%%%%%!PPP!PP!%%%%%%%%
%%%%%%%%!!!!!!)!%%%%%%%%
%%%%%%%%!!!!!!P!%%%%%%%%
%%%%%%%%!!!!!PP!%%%%%%%%
%%%%%%%%!!!PPPPP%%%%%%%%
%%%%%%%%!!PPP"PP%%%%%%%%
%%%%%%%%!PPP""PP%%%%%%%%
%%%%%%%%!PP""PP!%%%%%%%%
%%%%%%%%!!PPPP!!%%%%%%%%
%%%%%%%%!!!PP!!!%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
]]

build_å…¬åœ’ = ->
	with Town(mapdataå…¬åœ’)
		.traps[] = with {}
			.check = (player)-> not pos_in_box({player.x, player.y}, {8,8,8,13})
			.talk = =>
				Scene.current = build_fromå…¬åœ’()
		.charactors[] = with Charactor(12,13,{0x3a,0x3b}) -- è€äºº
			.talk = => MessageBoxRetro({ L'ï¼Šã€ŒããªãŸãŒã€€ã—ã‚‹ã—ã‚’ã‚‚ã¨ã‚ã‚‹ãªã‚‰\nã€€ã€€ã“ã®ã¾ã¡ã®ã€€ã—ã‚“ã§ã‚“ã«ã™ã‚€\nã€€ã€€ã¡ã‚‡ã†ã‚ã†ã‚’ã€€ãŸãšã­ã‚‹ãŒã‚ˆã„ã€‚ğŸ”»' })\attach()
		g_player.x, g_player.y = 8+g_player.x-18, 8+g_player.y-18


